<!doctype html>
<head>
    <meta charset="utf-8">
    <title>json.oak | Oak programming language</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/lib.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;700&family=IBM+Plex+Sans:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <div class="overlay">
            <div class="home">
                <a href="/">Oak</a>
            </div>
            <nav>
                <a href="/spec/">spec</a>
                <a href="/lib/"><span class="desktop">standard library</span><span class="mobile">stdlib</span></a>
                <a href="/posts/">blog</a>
                <a href="/#start">download</a>
                <a href="https://github.com/thesephist/oak" target="_blank">source ↗</a>
            </nav>
        </div>
    </header>
    <main aria-role="main">
        <article class="overlay stdlib">
            <h1>json.oak</h1>
            <p class="meta">
                <a href="/spec/">spec</a>
                <a href="/lib/">&larr; Standard library</a>
                <a href="https://github.com/thesephist/oak/blob/main/lib/json.oak">See on GitHub ↗</a>
            </p>
            <pre><code><span class="oak-comment">// libjson implements a JSON parser and serializer for Oak values</span>

<span class="oak-leftBrace">{</span><span class="oak-newline">
	</span><span class="oak-identifier">default</span><span class="oak-colon">: </span><span class="oak-identifier">default</span><span class="oak-newline">
	</span><span class="oak-identifier">slice</span><span class="oak-colon">: </span><span class="oak-identifier">slice</span><span class="oak-newline">
	</span><span class="oak-identifier">map</span><span class="oak-colon">: </span><span class="oak-identifier">map</span>
<span class="oak-rightBrace">} </span><span class="oak-assign">:= </span><span class="oak-fnName">import</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'std'</span><span class="oak-rightParen">)</span>
<span class="oak-leftBrace">{</span><span class="oak-newline">
	</span><span class="oak-identifier">space?</span><span class="oak-colon">: </span><span class="oak-identifier">space?</span><span class="oak-newline">
	</span><span class="oak-identifier">join</span><span class="oak-colon">: </span><span class="oak-identifier">join</span>
<span class="oak-rightBrace">} </span><span class="oak-assign">:= </span><span class="oak-fnName">import</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'str'</span><span class="oak-rightParen">)</span>

<span class="oak-comment">// string escape '"'</span>
<span class="oak-fnKeyword">fn </span><span class="oak-fnName">esc</span><span class="oak-leftParen">(</span><span class="oak-identifier">c</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">c </span><span class="oak-leftBrace">{</span><span class="oak-newline">
	</span><span class="oak-stringLiteral">'\t' </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'\\t'</span><span class="oak-newline">
	</span><span class="oak-stringLiteral">'\n' </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'\\n'</span><span class="oak-newline">
	</span><span class="oak-stringLiteral">'\r' </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'\\r'</span><span class="oak-newline">
	</span><span class="oak-stringLiteral">'\f' </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'\\f'</span><span class="oak-newline">
	</span><span class="oak-stringLiteral">'"' </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'\\"'</span><span class="oak-newline">
	</span><span class="oak-stringLiteral">'\\' </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'\\\\'</span><span class="oak-newline">
	</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">c</span>
<span class="oak-rightBrace">}</span>

<span class="oak-comment">// escapes whole string</span>
<span class="oak-fnKeyword">fn </span><span class="oak-fnName">escape</span><span class="oak-leftParen">(</span><span class="oak-identifier">s</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
	</span><span class="oak-identifier">max </span><span class="oak-assign">:= </span><span class="oak-fnName">len</span><span class="oak-leftParen">(</span><span class="oak-identifier">s</span><span class="oak-rightParen">)</span><span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">i</span><span class="oak-comma">, </span><span class="oak-identifier">acc</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">i </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-identifier">max </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">acc</span><span class="oak-newline">
		</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">i </span><span class="oak-plus">+ </span><span class="oak-numberLiteral">1</span><span class="oak-comma">, </span><span class="oak-identifier">acc </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-fnName">esc</span><span class="oak-leftParen">(</span><span class="oak-identifier">s</span><span class="oak-dot">.</span><span class="oak-leftParen">(</span><span class="oak-identifier">i</span><span class="oak-rightParen">)</span><span class="oak-rightParen">)</span><span class="oak-rightParen">)</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-numberLiteral">0</span><span class="oak-comma">, </span><span class="oak-stringLiteral">''</span><span class="oak-rightParen">)</span>
<span class="oak-rightBrace">}</span>

<span class="oak-comment">// serialize takes an Oak value and returns its JSON representation</span>
<span class="oak-fnKeyword">fn </span><span class="oak-fnName">serialize</span><span class="oak-leftParen">(</span><span class="oak-identifier">c</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">type</span><span class="oak-leftParen">(</span><span class="oak-identifier">c</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
	</span><span class="oak-comment">// do not serialize functions</span><span class="oak-newline">
	</span><span class="oak-colon">:</span><span class="oak-identifier">null</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">empty</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">function </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'null'</span><span class="oak-newline">
	</span><span class="oak-colon">:</span><span class="oak-identifier">string </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'"' </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-fnName">escape</span><span class="oak-leftParen">(</span><span class="oak-identifier">c</span><span class="oak-rightParen">) </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-stringLiteral">'"'</span><span class="oak-newline">
	</span><span class="oak-colon">:</span><span class="oak-identifier">atom </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'"' </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-fnName">string</span><span class="oak-leftParen">(</span><span class="oak-identifier">c</span><span class="oak-rightParen">) </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-stringLiteral">'"'</span><span class="oak-newline">
	</span><span class="oak-colon">:</span><span class="oak-identifier">int</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">float</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">bool </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">string</span><span class="oak-leftParen">(</span><span class="oak-identifier">c</span><span class="oak-rightParen">)</span><span class="oak-newline">
	</span><span class="oak-comment">// composite types</span><span class="oak-newline">
	</span><span class="oak-colon">:</span><span class="oak-identifier">list </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'[' </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">c </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">map</span><span class="oak-leftParen">(</span><span class="oak-identifier">serialize</span><span class="oak-rightParen">) </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">join</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">','</span><span class="oak-rightParen">) </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-stringLiteral">']'</span><span class="oak-newline">
	</span><span class="oak-colon">:</span><span class="oak-identifier">object </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'{' </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-fnName">keys</span><span class="oak-leftParen">(</span><span class="oak-identifier">c</span><span class="oak-rightParen">) </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">map</span><span class="oak-leftParen">(</span><span class="oak-fnKeyword">fn</span><span class="oak-leftParen">(</span><span class="oak-identifier">k</span><span class="oak-rightParen">) </span><span class="oak-stringLiteral">'"' </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-fnName">escape</span><span class="oak-leftParen">(</span><span class="oak-identifier">k</span><span class="oak-rightParen">) </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-stringLiteral">'":' </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-fnName">serialize</span><span class="oak-leftParen">(</span><span class="oak-identifier">c</span><span class="oak-dot">.</span><span class="oak-leftParen">(</span><span class="oak-identifier">k</span><span class="oak-rightParen">)</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">join</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">','</span><span class="oak-rightParen">) </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-stringLiteral">'}'</span>
<span class="oak-rightBrace">}</span>

<span class="oak-comment">// reader implementation with internal state for parsing</span>
<span class="oak-fnKeyword">fn </span><span class="oak-fnName">Reader</span><span class="oak-leftParen">(</span><span class="oak-identifier">s</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
	</span><span class="oak-identifier">index </span><span class="oak-assign">:= </span><span class="oak-numberLiteral">0</span><span class="oak-newline">
	</span><span class="oak-comment">// has there been a parse error?</span><span class="oak-newline">
	</span><span class="oak-identifier">err? </span><span class="oak-assign">:= </span><span class="oak-falseLiteral">false</span>
<span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">next </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-identifier">index </span><span class="oak-nonlocalAssign">&lt;- </span><span class="oak-identifier">index </span><span class="oak-plus">+ </span><span class="oak-numberLiteral">1</span><span class="oak-newline">
		</span><span class="oak-fnName">default</span><span class="oak-leftParen">(</span><span class="oak-identifier">s</span><span class="oak-dot">.</span><span class="oak-leftParen">(</span><span class="oak-identifier">index </span><span class="oak-minus">- </span><span class="oak-numberLiteral">1</span><span class="oak-rightParen">)</span><span class="oak-comma">, </span><span class="oak-stringLiteral">''</span><span class="oak-rightParen">)</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">peek </span><span class="oak-fnName">default</span><span class="oak-leftParen">(</span><span class="oak-identifier">s</span><span class="oak-dot">.</span><span class="oak-leftParen">(</span><span class="oak-identifier">index</span><span class="oak-rightParen">)</span><span class="oak-comma">, </span><span class="oak-stringLiteral">''</span><span class="oak-rightParen">)</span><span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">nextWord</span><span class="oak-leftParen">(</span><span class="oak-identifier">n</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">index </span><span class="oak-plus">+ </span><span class="oak-identifier">n </span><span class="oak-greater">> </span><span class="oak-fnName">len</span><span class="oak-leftParen">(</span><span class="oak-identifier">s</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-trueLiteral">true </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-identifier">index </span><span class="oak-nonlocalAssign">&lt;- </span><span class="oak-fnName">len</span><span class="oak-leftParen">(</span><span class="oak-identifier">s</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-qmark">?</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span><span class="oak-newline">
		</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-identifier">word </span><span class="oak-assign">:= </span><span class="oak-identifier">s </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">slice</span><span class="oak-leftParen">(</span><span class="oak-identifier">index</span><span class="oak-comma">, </span><span class="oak-identifier">index </span><span class="oak-plus">+ </span><span class="oak-identifier">n</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-identifier">index </span><span class="oak-nonlocalAssign">&lt;- </span><span class="oak-identifier">index </span><span class="oak-plus">+ </span><span class="oak-identifier">n</span><span class="oak-newline">
			</span><span class="oak-identifier">word</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-comment">// fast-forward through whitespace</span><span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">forward </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">sub </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">space?</span><span class="oak-leftParen">(</span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-identifier">index </span><span class="oak-nonlocalAssign">&lt;- </span><span class="oak-identifier">index </span><span class="oak-plus">+ </span><span class="oak-numberLiteral">1</span><span class="oak-newline">
			</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span><span class="oak-newline">
		</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span>
<span class="oak-newline">
	</span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-identifier">next</span><span class="oak-colon">: </span><span class="oak-identifier">next</span><span class="oak-newline">
		</span><span class="oak-identifier">peek</span><span class="oak-colon">: </span><span class="oak-identifier">peek</span><span class="oak-newline">
		</span><span class="oak-identifier">forward</span><span class="oak-colon">: </span><span class="oak-identifier">forward</span><span class="oak-newline">
		</span><span class="oak-identifier">nextWord</span><span class="oak-colon">: </span><span class="oak-identifier">nextWord</span><span class="oak-newline">
		</span><span class="oak-identifier">done?</span><span class="oak-colon">: </span><span class="oak-fnKeyword">fn</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-identifier">index </span><span class="oak-geq">>= </span><span class="oak-fnName">len</span><span class="oak-leftParen">(</span><span class="oak-identifier">s</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-identifier">err!</span><span class="oak-colon">: </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-identifier">err? </span><span class="oak-nonlocalAssign">&lt;- </span><span class="oak-trueLiteral">true</span><span class="oak-newline">
			</span><span class="oak-colon">:</span><span class="oak-identifier">error</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span><span class="oak-newline">
		</span><span class="oak-identifier">err?</span><span class="oak-colon">: </span><span class="oak-fnKeyword">fn</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-identifier">err?</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span>
<span class="oak-rightBrace">}</span>

<span class="oak-fnKeyword">fn </span><span class="oak-fnName">parseNull</span><span class="oak-leftParen">(</span><span class="oak-identifier">r</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">r</span><span class="oak-dot">.</span><span class="oak-fnName">nextWord</span><span class="oak-leftParen">(</span><span class="oak-numberLiteral">4</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
	</span><span class="oak-stringLiteral">'null' </span><span class="oak-branchArrow">-> </span><span class="oak-qmark">?</span><span class="oak-newline">
	</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">r</span><span class="oak-dot">.</span><span class="oak-fnName">err!</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span>
<span class="oak-rightBrace">}</span>

<span class="oak-fnKeyword">fn </span><span class="oak-fnName">parseString</span><span class="oak-leftParen">(</span><span class="oak-identifier">r</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
	</span><span class="oak-identifier">next </span><span class="oak-assign">:= </span><span class="oak-identifier">r</span><span class="oak-dot">.</span><span class="oak-identifier">next</span>
<span class="oak-newline">
	</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-comment">// eat the double quote</span>
<span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">acc</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">c </span><span class="oak-assign">:= </span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-stringLiteral">'' </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">r</span><span class="oak-dot">.</span><span class="oak-fnName">err!</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-stringLiteral">'\\' </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">acc </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">c </span><span class="oak-assign">:= </span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-stringLiteral">'t' </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'\t'</span><span class="oak-newline">
			</span><span class="oak-stringLiteral">'n' </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'\n'</span><span class="oak-newline">
			</span><span class="oak-stringLiteral">'r' </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'\r'</span><span class="oak-newline">
			</span><span class="oak-stringLiteral">'f' </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'\f'</span><span class="oak-newline">
			</span><span class="oak-stringLiteral">'"' </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'"'</span><span class="oak-newline">
			</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">c</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-stringLiteral">'"' </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">acc</span><span class="oak-newline">
		</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">acc </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">c</span><span class="oak-rightParen">)</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">''</span><span class="oak-rightParen">)</span>
<span class="oak-rightBrace">}</span>

<span class="oak-fnKeyword">fn </span><span class="oak-fnName">parseNumber</span><span class="oak-leftParen">(</span><span class="oak-identifier">r</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
	</span><span class="oak-identifier">peek </span><span class="oak-assign">:= </span><span class="oak-identifier">r</span><span class="oak-dot">.</span><span class="oak-identifier">peek</span><span class="oak-newline">
	</span><span class="oak-identifier">next </span><span class="oak-assign">:= </span><span class="oak-identifier">r</span><span class="oak-dot">.</span><span class="oak-identifier">next</span>
<span class="oak-newline">
	</span><span class="oak-identifier">decimal? </span><span class="oak-assign">:= </span><span class="oak-falseLiteral">false</span><span class="oak-newline">
	</span><span class="oak-identifier">negate? </span><span class="oak-assign">:= </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-stringLiteral">'-' </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-trueLiteral">true</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span><span class="oak-newline">
		</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-falseLiteral">false</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span>
<span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">acc</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-stringLiteral">'.' </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">decimal? </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-trueLiteral">true </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">r</span><span class="oak-dot">.</span><span class="oak-fnName">err!</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-identifier">decimal? </span><span class="oak-nonlocalAssign">&lt;- </span><span class="oak-trueLiteral">true</span><span class="oak-newline">
				</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">acc </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span><span class="oak-newline">
		</span><span class="oak-stringLiteral">'0'</span><span class="oak-comma">, </span><span class="oak-stringLiteral">'1'</span><span class="oak-comma">, </span><span class="oak-stringLiteral">'2'</span><span class="oak-comma">, </span><span class="oak-stringLiteral">'3'</span><span class="oak-comma">, </span><span class="oak-stringLiteral">'4'</span><span class="oak-newline">
		</span><span class="oak-stringLiteral">'5'</span><span class="oak-comma">, </span><span class="oak-stringLiteral">'6'</span><span class="oak-comma">, </span><span class="oak-stringLiteral">'7'</span><span class="oak-comma">, </span><span class="oak-stringLiteral">'8'</span><span class="oak-comma">, </span><span class="oak-stringLiteral">'9' </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">acc </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">acc</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-identifier">result </span><span class="oak-assign">:= </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">''</span><span class="oak-rightParen">)</span>
<span class="oak-newline">
	</span><span class="oak-ifKeyword">if </span><span class="oak-identifier">parsed </span><span class="oak-assign">:= </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">decimal? </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-trueLiteral">true </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">float</span><span class="oak-leftParen">(</span><span class="oak-identifier">result</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">int</span><span class="oak-leftParen">(</span><span class="oak-identifier">result</span><span class="oak-rightParen">)</span><span class="oak-newline">
	</span><span class="oak-rightBrace">} </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-qmark">? </span><span class="oak-branchArrow">-> </span><span class="oak-colon">:</span><span class="oak-identifier">error</span><span class="oak-newline">
		</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">negate? </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-trueLiteral">true </span><span class="oak-branchArrow">-> </span><span class="oak-minus">-</span><span class="oak-identifier">parsed</span><span class="oak-newline">
			</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">parsed</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span>
<span class="oak-rightBrace">}</span>

<span class="oak-fnKeyword">fn </span><span class="oak-fnName">parseTrue</span><span class="oak-leftParen">(</span><span class="oak-identifier">r</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">r</span><span class="oak-dot">.</span><span class="oak-fnName">nextWord</span><span class="oak-leftParen">(</span><span class="oak-numberLiteral">4</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
	</span><span class="oak-stringLiteral">'true' </span><span class="oak-branchArrow">-> </span><span class="oak-trueLiteral">true</span><span class="oak-newline">
	</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">r</span><span class="oak-dot">.</span><span class="oak-fnName">err!</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span>
<span class="oak-rightBrace">}</span>

<span class="oak-fnKeyword">fn </span><span class="oak-fnName">parseFalse</span><span class="oak-leftParen">(</span><span class="oak-identifier">r</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">r</span><span class="oak-dot">.</span><span class="oak-fnName">nextWord</span><span class="oak-leftParen">(</span><span class="oak-numberLiteral">5</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
	</span><span class="oak-stringLiteral">'false' </span><span class="oak-branchArrow">-> </span><span class="oak-falseLiteral">false</span><span class="oak-newline">
	</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">r</span><span class="oak-dot">.</span><span class="oak-fnName">err!</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span>
<span class="oak-rightBrace">}</span>

<span class="oak-fnKeyword">fn </span><span class="oak-fnName">parseList</span><span class="oak-leftParen">(</span><span class="oak-identifier">r</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
	</span><span class="oak-identifier">err? </span><span class="oak-assign">:= </span><span class="oak-identifier">r</span><span class="oak-dot">.</span><span class="oak-identifier">err?</span><span class="oak-newline">
	</span><span class="oak-identifier">peek </span><span class="oak-assign">:= </span><span class="oak-identifier">r</span><span class="oak-dot">.</span><span class="oak-identifier">peek</span><span class="oak-newline">
	</span><span class="oak-identifier">next </span><span class="oak-assign">:= </span><span class="oak-identifier">r</span><span class="oak-dot">.</span><span class="oak-identifier">next</span><span class="oak-newline">
	</span><span class="oak-identifier">forward </span><span class="oak-assign">:= </span><span class="oak-identifier">r</span><span class="oak-dot">.</span><span class="oak-identifier">forward</span>
<span class="oak-newline">
	</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-comment">// eat the [</span><span class="oak-newline">
	</span><span class="oak-fnName">forward</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span>
<span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">acc</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">err?</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-trueLiteral">true </span><span class="oak-branchArrow">-> </span><span class="oak-colon">:</span><span class="oak-identifier">error</span><span class="oak-newline">
		</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-stringLiteral">'' </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">r</span><span class="oak-dot">.</span><span class="oak-fnName">err!</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-stringLiteral">']' </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-comment">// eat the ]</span><span class="oak-newline">
				</span><span class="oak-identifier">acc</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span><span class="oak-newline">
			</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-identifier">acc </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-fnName">_parseReader</span><span class="oak-leftParen">(</span><span class="oak-identifier">r</span><span class="oak-rightParen">)</span><span class="oak-newline">
				</span><span class="oak-fnName">forward</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
				</span><span class="oak-ifKeyword">if </span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-eq">= </span><span class="oak-stringLiteral">',' </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span>
<span class="oak-newline">
				</span><span class="oak-fnName">forward</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
				</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">acc</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-leftBracket">[</span><span class="oak-rightBracket">]</span><span class="oak-rightParen">)</span>
<span class="oak-rightBrace">}</span>

<span class="oak-fnKeyword">fn </span><span class="oak-fnName">parseObject</span><span class="oak-leftParen">(</span><span class="oak-identifier">r</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
	</span><span class="oak-identifier">err? </span><span class="oak-assign">:= </span><span class="oak-identifier">r</span><span class="oak-dot">.</span><span class="oak-identifier">err?</span><span class="oak-newline">
	</span><span class="oak-identifier">peek </span><span class="oak-assign">:= </span><span class="oak-identifier">r</span><span class="oak-dot">.</span><span class="oak-identifier">peek</span><span class="oak-newline">
	</span><span class="oak-identifier">next </span><span class="oak-assign">:= </span><span class="oak-identifier">r</span><span class="oak-dot">.</span><span class="oak-identifier">next</span><span class="oak-newline">
	</span><span class="oak-identifier">forward </span><span class="oak-assign">:= </span><span class="oak-identifier">r</span><span class="oak-dot">.</span><span class="oak-identifier">forward</span>
<span class="oak-newline">
	</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-comment">// eat the {</span><span class="oak-newline">
	</span><span class="oak-fnName">forward</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span>
<span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">acc</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">err?</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-trueLiteral">true </span><span class="oak-branchArrow">-> </span><span class="oak-colon">:</span><span class="oak-identifier">error</span><span class="oak-newline">
		</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-stringLiteral">'' </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">r</span><span class="oak-dot">.</span><span class="oak-fnName">err!</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-stringLiteral">'}' </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
				</span><span class="oak-identifier">acc</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span><span class="oak-newline">
			</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-identifier">key </span><span class="oak-assign">:= </span><span class="oak-fnName">parseString</span><span class="oak-leftParen">(</span><span class="oak-identifier">r</span><span class="oak-rightParen">)</span><span class="oak-newline">
				</span><span class="oak-ifKeyword">if </span><span class="oak-exclam">!</span><span class="oak-fnName">err?</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-fnName">forward</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-ifKeyword">if </span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-eq">= </span><span class="oak-stringLiteral">':' </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span>
<span class="oak-newline">
					</span><span class="oak-identifier">val </span><span class="oak-assign">:= </span><span class="oak-fnName">_parseReader</span><span class="oak-leftParen">(</span><span class="oak-identifier">r</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-ifKeyword">if </span><span class="oak-exclam">!</span><span class="oak-fnName">err?</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
						</span><span class="oak-fnName">forward</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
						</span><span class="oak-ifKeyword">if </span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-eq">= </span><span class="oak-stringLiteral">',' </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span>
<span class="oak-newline">
						</span><span class="oak-fnName">forward</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
						</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">acc</span><span class="oak-dot">.</span><span class="oak-leftParen">(</span><span class="oak-identifier">key</span><span class="oak-rightParen">) </span><span class="oak-assign">:= </span><span class="oak-identifier">val</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-leftBrace">{</span><span class="oak-rightBrace">}</span><span class="oak-rightParen">)</span>
<span class="oak-rightBrace">}</span>

<span class="oak-fnKeyword">fn </span><span class="oak-fnName">_parseReader</span><span class="oak-leftParen">(</span><span class="oak-identifier">r</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
	</span><span class="oak-comment">// trim preceding whitespace</span><span class="oak-newline">
	</span><span class="oak-identifier">r</span><span class="oak-dot">.</span><span class="oak-fnName">forward</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span>
<span class="oak-newline">
	</span><span class="oak-identifier">result </span><span class="oak-assign">:= </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">r</span><span class="oak-dot">.</span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-stringLiteral">'n' </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">parseNull</span><span class="oak-leftParen">(</span><span class="oak-identifier">r</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-stringLiteral">'"' </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">parseString</span><span class="oak-leftParen">(</span><span class="oak-identifier">r</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-stringLiteral">'t' </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">parseTrue</span><span class="oak-leftParen">(</span><span class="oak-identifier">r</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-stringLiteral">'f' </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">parseFalse</span><span class="oak-leftParen">(</span><span class="oak-identifier">r</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-stringLiteral">'[' </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">parseList</span><span class="oak-leftParen">(</span><span class="oak-identifier">r</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-stringLiteral">'{' </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">parseObject</span><span class="oak-leftParen">(</span><span class="oak-identifier">r</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">parseNumber</span><span class="oak-leftParen">(</span><span class="oak-identifier">r</span><span class="oak-rightParen">)</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span>
<span class="oak-newline">
	</span><span class="oak-comment">// if there was a parse error, return :error</span><span class="oak-newline">
	</span><span class="oak-ifKeyword">if </span><span class="oak-identifier">r</span><span class="oak-dot">.</span><span class="oak-fnName">err?</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-trueLiteral">true </span><span class="oak-branchArrow">-> </span><span class="oak-colon">:</span><span class="oak-identifier">error</span><span class="oak-newline">
		</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">result</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span>
<span class="oak-rightBrace">}</span>

<span class="oak-comment">// parse takes a potentially valid JSON string, and returns its Oak</span>
<span class="oak-comment">// representation if valid JSON, or :error if the parse fails.</span>
<span class="oak-fnKeyword">fn </span><span class="oak-fnName">parse</span><span class="oak-leftParen">(</span><span class="oak-identifier">s</span><span class="oak-rightParen">) </span><span class="oak-fnName">Reader</span><span class="oak-leftParen">(</span><span class="oak-identifier">s</span><span class="oak-rightParen">) </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">_parseReader</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span>

</code></pre>
        </article>
    </main>
    <footer>
        <div class="split overlay">
            <div class="left">
            </div>
            <div class="right">
                - <a href="https://thesephist.com/">Linus</a>
            </div>
        </div>
    </footer>
</body>
