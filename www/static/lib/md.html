<!doctype html>
<head>
    <meta charset="utf-8">
    <title>md.oak | Oak programming language</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/lib.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;700&family=IBM+Plex+Sans:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <div class="overlay">
            <div class="home">
                <a href="/">Oak</a>
            </div>
            <nav>
                <a href="/lib/"><span class="desktop">standard library</span><span class="mobile">stdlib</span></a>
                <a href="#start">download</a>
                <a href="https://github.com/thesephist/oak" target="_blank">source ↗</a>
            </nav>
        </div>
    </header>
    <main aria-role="main">
        <article class="overlay stdlib">
            <h1>md.oak</h1>
            <p class="stdlibLink">
                <a href="/lib/">&larr; Standard library</a>
                <a href="https://github.com/thesephist/oak/blob/main/lib/md.oak">See on GitHub ↗</a>
            </p>
            <pre><code><span class="oak-comment">// libmd implements a Markdown parser and renderer</span>

<span class="oak-leftBrace">{</span><span class="oak-newline">
	</span><span class="oak-identifier">slice</span><span class="oak-colon">: </span><span class="oak-identifier">slice</span><span class="oak-newline">
	</span><span class="oak-identifier">map</span><span class="oak-colon">: </span><span class="oak-identifier">map</span><span class="oak-newline">
	</span><span class="oak-identifier">each</span><span class="oak-colon">: </span><span class="oak-identifier">each</span><span class="oak-newline">
	</span><span class="oak-identifier">filter</span><span class="oak-colon">: </span><span class="oak-identifier">filter</span><span class="oak-newline">
	</span><span class="oak-identifier">reduce</span><span class="oak-colon">: </span><span class="oak-identifier">reduce</span><span class="oak-newline">
	</span><span class="oak-identifier">every</span><span class="oak-colon">: </span><span class="oak-identifier">every</span><span class="oak-newline">
	</span><span class="oak-identifier">append</span><span class="oak-colon">: </span><span class="oak-identifier">append</span>
<span class="oak-rightBrace">} </span><span class="oak-assign">:= </span><span class="oak-fnName">import</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'std'</span><span class="oak-rightParen">)</span>
<span class="oak-leftBrace">{</span><span class="oak-newline">
	</span><span class="oak-identifier">digit?</span><span class="oak-colon">: </span><span class="oak-identifier">digit?</span><span class="oak-newline">
	</span><span class="oak-identifier">letter?</span><span class="oak-colon">: </span><span class="oak-identifier">letter?</span><span class="oak-newline">
	</span><span class="oak-identifier">space?</span><span class="oak-colon">: </span><span class="oak-identifier">space?</span><span class="oak-newline">
	</span><span class="oak-identifier">word?</span><span class="oak-colon">: </span><span class="oak-identifier">word?</span><span class="oak-newline">
	</span><span class="oak-identifier">indexOf</span><span class="oak-colon">: </span><span class="oak-identifier">indexOf</span><span class="oak-newline">
	</span><span class="oak-identifier">startsWith?</span><span class="oak-colon">: </span><span class="oak-identifier">startsWith?</span><span class="oak-newline">
	</span><span class="oak-identifier">endsWith?</span><span class="oak-colon">: </span><span class="oak-identifier">endsWith?</span><span class="oak-newline">
	</span><span class="oak-identifier">trimStart</span><span class="oak-colon">: </span><span class="oak-identifier">trimStart</span><span class="oak-newline">
	</span><span class="oak-identifier">replace</span><span class="oak-colon">: </span><span class="oak-identifier">replace</span><span class="oak-newline">
	</span><span class="oak-identifier">join</span><span class="oak-colon">: </span><span class="oak-identifier">join</span><span class="oak-newline">
	</span><span class="oak-identifier">split</span><span class="oak-colon">: </span><span class="oak-identifier">split</span>
<span class="oak-rightBrace">} </span><span class="oak-assign">:= </span><span class="oak-fnName">import</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'str'</span><span class="oak-rightParen">)</span>
<span class="oak-leftBrace">{</span><span class="oak-newline">
	</span><span class="oak-identifier">format</span><span class="oak-colon">: </span><span class="oak-identifier">format</span>
<span class="oak-rightBrace">} </span><span class="oak-assign">:= </span><span class="oak-fnName">import</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'fmt'</span><span class="oak-rightParen">)</span>

<span class="oak-comment">// Type-generic Reader over an Oak iterable interface, i.e. strings and lists.</span>
<span class="oak-comment">// This Reader is generic so that we can read through either a string (a list</span>
<span class="oak-comment">// of chars) or a list of strings.</span>
<span class="oak-fnKeyword">fn </span><span class="oak-fnName">Reader</span><span class="oak-leftParen">(</span><span class="oak-identifier">s</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
	</span><span class="oak-identifier">i </span><span class="oak-assign">:= </span><span class="oak-numberLiteral">0</span>
<span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">peek </span><span class="oak-identifier">s</span><span class="oak-dot">.</span><span class="oak-leftParen">(</span><span class="oak-identifier">i</span><span class="oak-rightParen">)</span><span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">last </span><span class="oak-identifier">s</span><span class="oak-dot">.</span><span class="oak-leftParen">(</span><span class="oak-identifier">i </span><span class="oak-plus">+ </span><span class="oak-numberLiteral">1</span><span class="oak-rightParen">)</span><span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">back </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">i </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-numberLiteral">0 </span><span class="oak-branchArrow">-> </span><span class="oak-numberLiteral">0</span><span class="oak-newline">
		</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">i </span><span class="oak-nonlocalAssign">&lt;- </span><span class="oak-identifier">i </span><span class="oak-minus">- </span><span class="oak-numberLiteral">1</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">next </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">i </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-fnName">len</span><span class="oak-leftParen">(</span><span class="oak-identifier">s</span><span class="oak-rightParen">) </span><span class="oak-branchArrow">-> </span><span class="oak-qmark">?</span><span class="oak-newline">
		</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-identifier">c </span><span class="oak-assign">:= </span><span class="oak-identifier">s</span><span class="oak-dot">.</span><span class="oak-leftParen">(</span><span class="oak-identifier">i</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-identifier">i </span><span class="oak-nonlocalAssign">&lt;- </span><span class="oak-identifier">i </span><span class="oak-plus">+ </span><span class="oak-numberLiteral">1</span><span class="oak-newline">
			</span><span class="oak-identifier">c</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">expect?</span><span class="oak-leftParen">(</span><span class="oak-identifier">prefix</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">s </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">slice</span><span class="oak-leftParen">(</span><span class="oak-identifier">i</span><span class="oak-rightParen">) </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">startsWith?</span><span class="oak-leftParen">(</span><span class="oak-identifier">prefix</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-trueLiteral">true </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-identifier">i </span><span class="oak-nonlocalAssign">&lt;- </span><span class="oak-identifier">i </span><span class="oak-plus">+ </span><span class="oak-fnName">len</span><span class="oak-leftParen">(</span><span class="oak-identifier">prefix</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-trueLiteral">true</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span><span class="oak-newline">
		</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-falseLiteral">false</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">itemIndex</span><span class="oak-leftParen">(</span><span class="oak-identifier">list</span><span class="oak-comma">, </span><span class="oak-identifier">it</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">i</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">i </span><span class="oak-less">&lt; </span><span class="oak-fnName">len</span><span class="oak-leftParen">(</span><span class="oak-identifier">list</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-trueLiteral">true </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">list</span><span class="oak-dot">.</span><span class="oak-leftParen">(</span><span class="oak-identifier">i</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-identifier">it </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">i</span><span class="oak-newline">
				</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">i </span><span class="oak-plus">+ </span><span class="oak-numberLiteral">1</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span><span class="oak-newline">
			</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-minus">-</span><span class="oak-numberLiteral">1</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span><span class="oak-newline">
		</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-numberLiteral">0</span><span class="oak-rightParen">)</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">readUntil</span><span class="oak-leftParen">(</span><span class="oak-identifier">c</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">index </span><span class="oak-assign">:= </span><span class="oak-identifier">s </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">slice</span><span class="oak-leftParen">(</span><span class="oak-identifier">i</span><span class="oak-rightParen">) </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">itemIndex</span><span class="oak-leftParen">(</span><span class="oak-identifier">c</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-minus">-</span><span class="oak-numberLiteral">1 </span><span class="oak-branchArrow">-> </span><span class="oak-qmark">?</span><span class="oak-newline">
		</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-identifier">substr </span><span class="oak-assign">:= </span><span class="oak-identifier">s </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">slice</span><span class="oak-leftParen">(</span><span class="oak-identifier">i</span><span class="oak-comma">, </span><span class="oak-identifier">i </span><span class="oak-plus">+ </span><span class="oak-identifier">index</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-identifier">i </span><span class="oak-nonlocalAssign">&lt;- </span><span class="oak-identifier">i </span><span class="oak-plus">+ </span><span class="oak-identifier">index</span><span class="oak-newline">
			</span><span class="oak-identifier">substr</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">readUntilPrefix</span><span class="oak-leftParen">(</span><span class="oak-identifier">prefix</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">index</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">index </span><span class="oak-plus">+ </span><span class="oak-fnName">len</span><span class="oak-leftParen">(</span><span class="oak-identifier">prefix</span><span class="oak-rightParen">) </span><span class="oak-leq">&lt;= </span><span class="oak-fnName">len</span><span class="oak-leftParen">(</span><span class="oak-identifier">s</span><span class="oak-rightParen">) </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-ifKeyword">if </span><span class="oak-identifier">part </span><span class="oak-assign">:= </span><span class="oak-identifier">s </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">slice</span><span class="oak-leftParen">(</span><span class="oak-identifier">index</span><span class="oak-comma">, </span><span class="oak-identifier">index </span><span class="oak-plus">+ </span><span class="oak-fnName">len</span><span class="oak-leftParen">(</span><span class="oak-identifier">prefix</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-identifier">prefix </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-identifier">substr </span><span class="oak-assign">:= </span><span class="oak-identifier">s </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">slice</span><span class="oak-leftParen">(</span><span class="oak-identifier">i</span><span class="oak-comma">, </span><span class="oak-identifier">index</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-identifier">i </span><span class="oak-nonlocalAssign">&lt;- </span><span class="oak-identifier">index</span><span class="oak-newline">
					</span><span class="oak-identifier">substr</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">i </span><span class="oak-plus">+ </span><span class="oak-numberLiteral">1</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span><span class="oak-newline">
		</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">i</span><span class="oak-rightParen">)</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">readUntilEnd </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-identifier">substr </span><span class="oak-assign">:= </span><span class="oak-identifier">s </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">slice</span><span class="oak-leftParen">(</span><span class="oak-identifier">i</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-identifier">i </span><span class="oak-nonlocalAssign">&lt;- </span><span class="oak-fnName">len</span><span class="oak-leftParen">(</span><span class="oak-identifier">s</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-identifier">substr</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-comment">// readUntilMatchingDelim is a helper specifically for parsing delimited</span><span class="oak-newline">
	</span><span class="oak-comment">// expressions like text in [] or (), that will attempt to read until a</span><span class="oak-newline">
	</span><span class="oak-comment">// matching delimiter and return that read if the match exists, and return</span><span class="oak-newline">
	</span><span class="oak-comment">// () if no match exists. This fn accounts for nested delimiters and</span><span class="oak-newline">
	</span><span class="oak-comment">// ignores matching pairs within the delimited text expression.</span><span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">readUntilMatchingDelim</span><span class="oak-leftParen">(</span><span class="oak-identifier">left</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-identifier">right </span><span class="oak-assign">:= </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">left </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-comment">// currently only supports [] and () (for Markdown links)</span><span class="oak-newline">
			</span><span class="oak-stringLiteral">'[' </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">']'</span><span class="oak-newline">
			</span><span class="oak-stringLiteral">'(' </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">')'</span><span class="oak-newline">
			</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-qmark">?</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span>
<span class="oak-newline">
		</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">index</span><span class="oak-comma">, </span><span class="oak-identifier">stack</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">stack </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-numberLiteral">0 </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">index </span><span class="oak-minus">- </span><span class="oak-numberLiteral">1</span><span class="oak-newline">
			</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">c </span><span class="oak-assign">:= </span><span class="oak-identifier">s</span><span class="oak-dot">.</span><span class="oak-leftParen">(</span><span class="oak-identifier">index</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-qmark">? </span><span class="oak-branchArrow">-> </span><span class="oak-minus">-</span><span class="oak-numberLiteral">1</span><span class="oak-newline">
				</span><span class="oak-identifier">left </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">index </span><span class="oak-plus">+ </span><span class="oak-numberLiteral">1</span><span class="oak-comma">, </span><span class="oak-identifier">stack </span><span class="oak-plus">+ </span><span class="oak-numberLiteral">1</span><span class="oak-rightParen">)</span><span class="oak-newline">
				</span><span class="oak-identifier">right </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">index </span><span class="oak-plus">+ </span><span class="oak-numberLiteral">1</span><span class="oak-comma">, </span><span class="oak-identifier">stack </span><span class="oak-minus">- </span><span class="oak-numberLiteral">1</span><span class="oak-rightParen">)</span><span class="oak-newline">
				</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">index </span><span class="oak-plus">+ </span><span class="oak-numberLiteral">1</span><span class="oak-comma">, </span><span class="oak-identifier">stack</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span>
<span class="oak-newline">
		</span><span class="oak-ifKeyword">if </span><span class="oak-identifier">matchingDelimIdx </span><span class="oak-assign">:= </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">i</span><span class="oak-comma">, </span><span class="oak-numberLiteral">1</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-minus">-</span><span class="oak-numberLiteral">1 </span><span class="oak-branchArrow">-> </span><span class="oak-qmark">?</span><span class="oak-newline">
			</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-identifier">substr </span><span class="oak-assign">:= </span><span class="oak-identifier">s </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">slice</span><span class="oak-leftParen">(</span><span class="oak-identifier">i</span><span class="oak-comma">, </span><span class="oak-identifier">matchingDelimIdx</span><span class="oak-rightParen">)</span><span class="oak-newline">
				</span><span class="oak-identifier">i </span><span class="oak-nonlocalAssign">&lt;- </span><span class="oak-identifier">matchingDelimIdx</span><span class="oak-newline">
				</span><span class="oak-identifier">substr</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span>
<span class="oak-newline">
	</span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-identifier">peek</span><span class="oak-colon">: </span><span class="oak-identifier">peek</span><span class="oak-newline">
		</span><span class="oak-identifier">last</span><span class="oak-colon">: </span><span class="oak-identifier">last</span><span class="oak-newline">
		</span><span class="oak-identifier">back</span><span class="oak-colon">: </span><span class="oak-identifier">back</span><span class="oak-newline">
		</span><span class="oak-identifier">next</span><span class="oak-colon">: </span><span class="oak-identifier">next</span><span class="oak-newline">
		</span><span class="oak-identifier">expect?</span><span class="oak-colon">: </span><span class="oak-identifier">expect?</span><span class="oak-newline">
		</span><span class="oak-identifier">readUntil</span><span class="oak-colon">: </span><span class="oak-identifier">readUntil</span><span class="oak-newline">
		</span><span class="oak-identifier">readUntilPrefix</span><span class="oak-colon">: </span><span class="oak-identifier">readUntilPrefix</span><span class="oak-newline">
		</span><span class="oak-identifier">readUntilEnd</span><span class="oak-colon">: </span><span class="oak-identifier">readUntilEnd</span><span class="oak-newline">
		</span><span class="oak-identifier">readUntilMatchingDelim</span><span class="oak-colon">: </span><span class="oak-identifier">readUntilMatchingDelim</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span>
<span class="oak-rightBrace">}</span>

<span class="oak-comment">// uword? reports whether a given character is a "word character", i.e. whether</span>
<span class="oak-comment">// it is a part of a normal word. It intends to be UTF8 Unicode-aware and is</span>
<span class="oak-comment">// used for text token disambiguation.</span>
<span class="oak-fnKeyword">fn </span><span class="oak-fnName">uword?</span><span class="oak-leftParen">(</span><span class="oak-identifier">c</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">word?</span><span class="oak-leftParen">(</span><span class="oak-identifier">c</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
	</span><span class="oak-trueLiteral">true </span><span class="oak-branchArrow">-> </span><span class="oak-trueLiteral">true</span><span class="oak-newline">
	</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">codepoint</span><span class="oak-leftParen">(</span><span class="oak-identifier">c</span><span class="oak-rightParen">) </span><span class="oak-greater">> </span><span class="oak-numberLiteral">127</span>
<span class="oak-rightBrace">}</span>

<span class="oak-comment">// tokenizeText tokenizes a paragraph or paragraph-like Markdown text (like</span>
<span class="oak-comment">// headers) into a token stream</span>
<span class="oak-comment">//</span>
<span class="oak-comment">// This function encapsulates all disambiguation rules for e.g. parens inside A</span>
<span class="oak-comment">// (link) tag parens, underscores inside words, and escaped special characters</span>
<span class="oak-comment">// with backslashes.</span>
<span class="oak-fnKeyword">fn </span><span class="oak-fnName">tokenizeText</span><span class="oak-leftParen">(</span><span class="oak-identifier">line</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
	</span><span class="oak-identifier">reader </span><span class="oak-assign">:= </span><span class="oak-fnName">Reader</span><span class="oak-leftParen">(</span><span class="oak-identifier">line</span><span class="oak-rightParen">)</span>
<span class="oak-newline">
	</span><span class="oak-identifier">peek </span><span class="oak-assign">:= </span><span class="oak-identifier">reader</span><span class="oak-dot">.</span><span class="oak-identifier">peek</span><span class="oak-newline">
	</span><span class="oak-identifier">next </span><span class="oak-assign">:= </span><span class="oak-identifier">reader</span><span class="oak-dot">.</span><span class="oak-identifier">next</span>
<span class="oak-newline">
	</span><span class="oak-identifier">tokens </span><span class="oak-assign">:= </span><span class="oak-leftBracket">[</span><span class="oak-stringLiteral">''</span><span class="oak-rightBracket">]</span><span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">push</span><span class="oak-leftParen">(</span><span class="oak-identifier">tok</span><span class="oak-rightParen">) </span><span class="oak-identifier">tokens </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">tok </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-stringLiteral">''</span><span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">append</span><span class="oak-leftParen">(</span><span class="oak-identifier">suffix</span><span class="oak-rightParen">) </span><span class="oak-identifier">tokens</span><span class="oak-dot">.</span><span class="oak-leftParen">(</span><span class="oak-fnName">len</span><span class="oak-leftParen">(</span><span class="oak-identifier">tokens</span><span class="oak-rightParen">) </span><span class="oak-minus">- </span><span class="oak-numberLiteral">1</span><span class="oak-rightParen">) </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">suffix</span>
<span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">sub </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">c </span><span class="oak-assign">:= </span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-qmark">? </span><span class="oak-branchArrow">-> </span><span class="oak-qmark">?</span><span class="oak-newline">
		</span><span class="oak-comment">// italics &amp; bold</span><span class="oak-newline">
		</span><span class="oak-stringLiteral">'_'</span><span class="oak-comma">, </span><span class="oak-stringLiteral">'*' </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-ifKeyword">if </span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-identifier">c </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-fnName">push</span><span class="oak-leftParen">(</span><span class="oak-identifier">c </span><span class="oak-plus">+ </span><span class="oak-identifier">c</span><span class="oak-rightParen">)</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">push</span><span class="oak-leftParen">(</span><span class="oak-identifier">c</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span><span class="oak-newline">
			</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span><span class="oak-newline">
		</span><span class="oak-comment">// \ escapes any character</span><span class="oak-newline">
		</span><span class="oak-stringLiteral">'\\' </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">d </span><span class="oak-assign">:= </span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-qmark">? </span><span class="oak-branchArrow">-> </span><span class="oak-qmark">?</span><span class="oak-newline">
			</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-fnName">append</span><span class="oak-leftParen">(</span><span class="oak-identifier">d</span><span class="oak-rightParen">)</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span><span class="oak-newline">
		</span><span class="oak-comment">// code snippet</span><span class="oak-newline">
		</span><span class="oak-stringLiteral">'`'</span><span class="oak-newline">
		</span><span class="oak-comment">// strikethrough</span><span class="oak-newline">
		</span><span class="oak-stringLiteral">'~'</span><span class="oak-newline">
		</span><span class="oak-comment">// image</span><span class="oak-newline">
		</span><span class="oak-stringLiteral">'!'</span><span class="oak-comma">, </span><span class="oak-stringLiteral">'['</span><span class="oak-comma">, </span><span class="oak-stringLiteral">']'</span><span class="oak-comma">, </span><span class="oak-stringLiteral">'('</span><span class="oak-comma">, </span><span class="oak-stringLiteral">')' </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-fnName">push</span><span class="oak-leftParen">(</span><span class="oak-identifier">c</span><span class="oak-rightParen">)</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-fnName">append</span><span class="oak-leftParen">(</span><span class="oak-identifier">c</span><span class="oak-rightParen">)</span><span class="oak-rightParen">)</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span>
<span class="oak-newline">
	</span><span class="oak-identifier">tokens </span><span class="oak-pipeArrow">|> </span><span class="oak-withKeyword">with </span><span class="oak-fnName">filter</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn</span><span class="oak-leftParen">(</span><span class="oak-identifier">tok</span><span class="oak-rightParen">) </span><span class="oak-identifier">tok </span><span class="oak-neq">!= </span><span class="oak-stringLiteral">''</span>
<span class="oak-rightBrace">}</span>

<span class="oak-comment">// unifyTextNodes normalizes a Markdown AST so that runs of consecutive plain</span>
<span class="oak-comment">// text nodes (strings) are combined into single plain text nodes.</span>
<span class="oak-fnKeyword">fn </span><span class="oak-fnName">unifyTextNodes</span><span class="oak-leftParen">(</span><span class="oak-identifier">nodes</span><span class="oak-comma">, </span><span class="oak-identifier">joiner</span><span class="oak-rightParen">) </span><span class="oak-identifier">nodes </span><span class="oak-pipeArrow">|> </span><span class="oak-withKeyword">with </span><span class="oak-fnName">reduce</span><span class="oak-leftParen">(</span><span class="oak-leftBracket">[</span><span class="oak-rightBracket">]</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn</span><span class="oak-leftParen">(</span><span class="oak-identifier">acc</span><span class="oak-comma">, </span><span class="oak-identifier">child</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">type</span><span class="oak-leftParen">(</span><span class="oak-identifier">child</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
	</span><span class="oak-colon">:</span><span class="oak-identifier">string </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">type</span><span class="oak-leftParen">(</span><span class="oak-identifier">acc</span><span class="oak-dot">.</span><span class="oak-leftParen">(</span><span class="oak-fnName">len</span><span class="oak-leftParen">(</span><span class="oak-identifier">acc</span><span class="oak-rightParen">) </span><span class="oak-minus">- </span><span class="oak-numberLiteral">1</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">string </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-identifier">acc</span><span class="oak-dot">.</span><span class="oak-leftParen">(</span><span class="oak-fnName">len</span><span class="oak-leftParen">(</span><span class="oak-identifier">acc</span><span class="oak-rightParen">) </span><span class="oak-minus">- </span><span class="oak-numberLiteral">1</span><span class="oak-rightParen">) </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">joiner </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">child</span><span class="oak-newline">
			</span><span class="oak-identifier">acc</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span><span class="oak-newline">
		</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">acc </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">child</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">acc </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">child</span><span class="oak-dot">.</span><span class="oak-identifier">children </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-qmark">? </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">child</span><span class="oak-newline">
		</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">child</span><span class="oak-dot">.</span><span class="oak-identifier">children </span><span class="oak-assign">:= </span><span class="oak-fnName">unifyTextNodes</span><span class="oak-leftParen">(</span><span class="oak-identifier">child</span><span class="oak-dot">.</span><span class="oak-identifier">children</span><span class="oak-comma">, </span><span class="oak-identifier">joiner</span><span class="oak-rightParen">)</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span>
<span class="oak-rightBrace">}</span>

<span class="oak-comment">// parseText takes a stream of inline tokens from a header or paragraph section</span>
<span class="oak-comment">// of a Markdown document and produces a list of inline AST nodes to be</span>
<span class="oak-comment">// included in a Node.H or Node.P.</span>
<span class="oak-fnKeyword">fn </span><span class="oak-fnName">parseText</span><span class="oak-leftParen">(</span><span class="oak-identifier">tokens</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
	</span><span class="oak-identifier">reader </span><span class="oak-assign">:= </span><span class="oak-fnName">Reader</span><span class="oak-leftParen">(</span><span class="oak-identifier">tokens</span><span class="oak-rightParen">)</span>
<span class="oak-newline">
	</span><span class="oak-identifier">peek </span><span class="oak-assign">:= </span><span class="oak-identifier">reader</span><span class="oak-dot">.</span><span class="oak-identifier">peek</span><span class="oak-newline">
	</span><span class="oak-identifier">next </span><span class="oak-assign">:= </span><span class="oak-identifier">reader</span><span class="oak-dot">.</span><span class="oak-identifier">next</span><span class="oak-newline">
	</span><span class="oak-identifier">readUntil </span><span class="oak-assign">:= </span><span class="oak-identifier">reader</span><span class="oak-dot">.</span><span class="oak-identifier">readUntil</span><span class="oak-newline">
	</span><span class="oak-identifier">readUntilMatchingDelim </span><span class="oak-assign">:= </span><span class="oak-identifier">reader</span><span class="oak-dot">.</span><span class="oak-identifier">readUntilMatchingDelim</span>
<span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">handleDelimitedRange</span><span class="oak-leftParen">(</span><span class="oak-identifier">tok</span><span class="oak-comma">, </span><span class="oak-identifier">tag</span><span class="oak-comma">, </span><span class="oak-identifier">nodes</span><span class="oak-comma">, </span><span class="oak-identifier">sub</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">range </span><span class="oak-assign">:= </span><span class="oak-fnName">readUntil</span><span class="oak-leftParen">(</span><span class="oak-identifier">tok</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-qmark">? </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">nodes </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">tok</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-comment">// eat trailing tok</span><span class="oak-newline">
			</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">nodes </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-identifier">tag</span><span class="oak-colon">: </span><span class="oak-identifier">tag</span><span class="oak-newline">
				</span><span class="oak-identifier">children</span><span class="oak-colon">: </span><span class="oak-fnName">parseText</span><span class="oak-leftParen">(</span><span class="oak-identifier">range</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span>
<span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">nodes</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">tok </span><span class="oak-assign">:= </span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-qmark">? </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">nodes</span><span class="oak-newline">
		</span><span class="oak-stringLiteral">'_' </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">handleDelimitedRange</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'_'</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">em</span><span class="oak-comma">, </span><span class="oak-identifier">nodes</span><span class="oak-comma">, </span><span class="oak-identifier">sub</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-stringLiteral">'__' </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">handleDelimitedRange</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'__'</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">strong</span><span class="oak-comma">, </span><span class="oak-identifier">nodes</span><span class="oak-comma">, </span><span class="oak-identifier">sub</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-stringLiteral">'*' </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">handleDelimitedRange</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'*'</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">em</span><span class="oak-comma">, </span><span class="oak-identifier">nodes</span><span class="oak-comma">, </span><span class="oak-identifier">sub</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-stringLiteral">'**' </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">handleDelimitedRange</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'**'</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">strong</span><span class="oak-comma">, </span><span class="oak-identifier">nodes</span><span class="oak-comma">, </span><span class="oak-identifier">sub</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-stringLiteral">'`' </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">handleDelimitedRange</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'`'</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">code</span><span class="oak-comma">, </span><span class="oak-identifier">nodes</span><span class="oak-comma">, </span><span class="oak-identifier">sub</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-stringLiteral">'~' </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">handleDelimitedRange</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'~'</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">strike</span><span class="oak-comma">, </span><span class="oak-identifier">nodes</span><span class="oak-comma">, </span><span class="oak-identifier">sub</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-stringLiteral">'[' </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">range </span><span class="oak-assign">:= </span><span class="oak-fnName">readUntilMatchingDelim</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'['</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-qmark">? </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">nodes </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">tok</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-leftBracket">[</span><span class="oak-stringLiteral">'x'</span><span class="oak-rightBracket">] </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-comment">// eat matching ]</span><span class="oak-newline">
				</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">nodes </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-identifier">tag</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">checkbox</span><span class="oak-newline">
					</span><span class="oak-identifier">checked</span><span class="oak-colon">: </span><span class="oak-trueLiteral">true</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span><span class="oak-newline">
			</span><span class="oak-leftBracket">[</span><span class="oak-stringLiteral">' '</span><span class="oak-rightBracket">] </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-comment">// eat matching ]</span><span class="oak-newline">
				</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">nodes </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-identifier">tag</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">checkbox</span><span class="oak-newline">
					</span><span class="oak-identifier">checked</span><span class="oak-colon">: </span><span class="oak-falseLiteral">false</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span><span class="oak-newline">
			</span><span class="oak-comment">// eat matching ], then (</span><span class="oak-newline">
			</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">c </span><span class="oak-assign">:= </span><span class="oak-leftParen">(</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-comma">, </span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-stringLiteral">'(' </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">urlRange </span><span class="oak-assign">:= </span><span class="oak-fnName">readUntilMatchingDelim</span><span class="oak-leftParen">(</span><span class="oak-identifier">c</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-qmark">? </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">nodes </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">tok </span><span class="oak-plus">+ </span><span class="oak-fnName">join</span><span class="oak-leftParen">(</span><span class="oak-identifier">range</span><span class="oak-rightParen">) </span><span class="oak-plus">+ </span><span class="oak-stringLiteral">']' </span><span class="oak-plus">+ </span><span class="oak-identifier">c</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
						</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-comment">// swallow matching )</span><span class="oak-newline">
						</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">nodes </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-leftBrace">{</span><span class="oak-newline">
							</span><span class="oak-identifier">tag</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">a</span><span class="oak-newline">
							</span><span class="oak-identifier">href</span><span class="oak-colon">: </span><span class="oak-fnName">join</span><span class="oak-leftParen">(</span><span class="oak-identifier">urlRange</span><span class="oak-rightParen">)</span><span class="oak-newline">
							</span><span class="oak-identifier">children</span><span class="oak-colon">: </span><span class="oak-fnName">parseText</span><span class="oak-leftParen">(</span><span class="oak-identifier">range</span><span class="oak-rightParen">)</span><span class="oak-newline">
						</span><span class="oak-rightBrace">}</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-qmark">? </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">nodes </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">tok </span><span class="oak-plus">+ </span><span class="oak-fnName">join</span><span class="oak-leftParen">(</span><span class="oak-identifier">range</span><span class="oak-rightParen">) </span><span class="oak-plus">+ </span><span class="oak-stringLiteral">']'</span><span class="oak-rightParen">)</span><span class="oak-newline">
				</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">nodes </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">tok </span><span class="oak-plus">+ </span><span class="oak-fnName">join</span><span class="oak-leftParen">(</span><span class="oak-identifier">range</span><span class="oak-rightParen">) </span><span class="oak-plus">+ </span><span class="oak-stringLiteral">']' </span><span class="oak-plus">+ </span><span class="oak-identifier">c</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span><span class="oak-newline">
		</span><span class="oak-stringLiteral">'!' </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-stringLiteral">'[' </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">range </span><span class="oak-assign">:= </span><span class="oak-leftParen">(</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-comma">, </span><span class="oak-fnName">readUntilMatchingDelim</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'['</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-qmark">? </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">nodes </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">tok </span><span class="oak-plus">+ </span><span class="oak-stringLiteral">'['</span><span class="oak-rightParen">)</span><span class="oak-newline">
				</span><span class="oak-leftBracket">[</span><span class="oak-stringLiteral">'x'</span><span class="oak-rightBracket">] </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-comment">// eat matching ]</span><span class="oak-newline">
					</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">nodes </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">tok </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-leftBrace">{</span><span class="oak-newline">
						</span><span class="oak-identifier">tag</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">checkbox</span><span class="oak-newline">
						</span><span class="oak-identifier">checked</span><span class="oak-colon">: </span><span class="oak-trueLiteral">true</span><span class="oak-newline">
					</span><span class="oak-rightBrace">}</span><span class="oak-rightParen">)</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-leftBracket">[</span><span class="oak-stringLiteral">' '</span><span class="oak-rightBracket">] </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-comment">// eat matching ]</span><span class="oak-newline">
					</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">nodes </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">tok </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-leftBrace">{</span><span class="oak-newline">
						</span><span class="oak-identifier">tag</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">checkbox</span><span class="oak-newline">
						</span><span class="oak-identifier">checked</span><span class="oak-colon">: </span><span class="oak-falseLiteral">false</span><span class="oak-newline">
					</span><span class="oak-rightBrace">}</span><span class="oak-rightParen">)</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-comment">// eat matching ], then (</span><span class="oak-newline">
				</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">c </span><span class="oak-assign">:= </span><span class="oak-leftParen">(</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-comma">, </span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-stringLiteral">'(' </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">urlRange </span><span class="oak-assign">:= </span><span class="oak-fnName">readUntilMatchingDelim</span><span class="oak-leftParen">(</span><span class="oak-identifier">c</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
						</span><span class="oak-qmark">? </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">nodes </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">tok </span><span class="oak-plus">+ </span><span class="oak-stringLiteral">'[' </span><span class="oak-plus">+ </span><span class="oak-fnName">join</span><span class="oak-leftParen">(</span><span class="oak-identifier">range</span><span class="oak-rightParen">) </span><span class="oak-plus">+ </span><span class="oak-stringLiteral">']' </span><span class="oak-plus">+ </span><span class="oak-identifier">c</span><span class="oak-rightParen">)</span><span class="oak-newline">
						</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
							</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-comment">// swallow matching )</span><span class="oak-newline">
							</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">nodes </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-leftBrace">{</span><span class="oak-newline">
								</span><span class="oak-identifier">tag</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">img</span><span class="oak-newline">
								</span><span class="oak-identifier">alt</span><span class="oak-colon">: </span><span class="oak-fnName">join</span><span class="oak-leftParen">(</span><span class="oak-identifier">range</span><span class="oak-rightParen">)</span><span class="oak-newline">
								</span><span class="oak-identifier">src</span><span class="oak-colon">: </span><span class="oak-fnName">join</span><span class="oak-leftParen">(</span><span class="oak-identifier">urlRange</span><span class="oak-rightParen">)</span><span class="oak-newline">
							</span><span class="oak-rightBrace">}</span><span class="oak-rightParen">)</span><span class="oak-newline">
						</span><span class="oak-rightBrace">}</span><span class="oak-newline">
					</span><span class="oak-rightBrace">}</span><span class="oak-newline">
					</span><span class="oak-qmark">? </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">nodes </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">tok </span><span class="oak-plus">+ </span><span class="oak-stringLiteral">'[' </span><span class="oak-plus">+ </span><span class="oak-fnName">join</span><span class="oak-leftParen">(</span><span class="oak-identifier">range</span><span class="oak-rightParen">) </span><span class="oak-plus">+ </span><span class="oak-stringLiteral">']'</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">nodes </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">tok </span><span class="oak-plus">+ </span><span class="oak-stringLiteral">'[' </span><span class="oak-plus">+ </span><span class="oak-fnName">join</span><span class="oak-leftParen">(</span><span class="oak-identifier">range</span><span class="oak-rightParen">) </span><span class="oak-plus">+ </span><span class="oak-stringLiteral">']' </span><span class="oak-plus">+ </span><span class="oak-identifier">c</span><span class="oak-rightParen">)</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span><span class="oak-newline">
			</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">nodes </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">tok</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span><span class="oak-newline">
		</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">nodes </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">tok</span><span class="oak-rightParen">)</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-leftBracket">[</span><span class="oak-rightBracket">]</span><span class="oak-rightParen">) </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">unifyTextNodes</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">''</span><span class="oak-rightParen">)</span>
<span class="oak-rightBrace">}</span>

<span class="oak-fnKeyword">fn </span><span class="oak-fnName">uListItemLine?</span><span class="oak-leftParen">(</span><span class="oak-identifier">line</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">line </span><span class="oak-leftBrace">{</span><span class="oak-newline">
	</span><span class="oak-qmark">? </span><span class="oak-branchArrow">-> </span><span class="oak-falseLiteral">false</span><span class="oak-newline">
	</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">line </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">trimStart</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">' '</span><span class="oak-rightParen">) </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">trimStart</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'\t'</span><span class="oak-rightParen">) </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">startsWith?</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'- '</span><span class="oak-rightParen">)</span>
<span class="oak-rightBrace">}</span>

<span class="oak-fnKeyword">fn </span><span class="oak-fnName">oListItemLine?</span><span class="oak-leftParen">(</span><span class="oak-identifier">line</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">line </span><span class="oak-leftBrace">{</span><span class="oak-newline">
	</span><span class="oak-qmark">? </span><span class="oak-branchArrow">-> </span><span class="oak-falseLiteral">false</span><span class="oak-newline">
	</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-identifier">trimmedStart </span><span class="oak-assign">:= </span><span class="oak-identifier">line </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">trimStart</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">' '</span><span class="oak-rightParen">) </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">trimStart</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'\t'</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-ifKeyword">if </span><span class="oak-identifier">dotIdx </span><span class="oak-assign">:= </span><span class="oak-identifier">trimmedStart </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">indexOf</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'. '</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-minus">-</span><span class="oak-numberLiteral">1</span><span class="oak-comma">, </span><span class="oak-numberLiteral">0 </span><span class="oak-branchArrow">-> </span><span class="oak-falseLiteral">false</span><span class="oak-newline">
			</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">trimmedStart </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">slice</span><span class="oak-leftParen">(</span><span class="oak-numberLiteral">0</span><span class="oak-comma">, </span><span class="oak-identifier">dotIdx</span><span class="oak-rightParen">) </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">split</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">every</span><span class="oak-leftParen">(</span><span class="oak-identifier">digit?</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span>
<span class="oak-rightBrace">}</span>

<span class="oak-fnKeyword">fn </span><span class="oak-fnName">listItemLine?</span><span class="oak-leftParen">(</span><span class="oak-identifier">line</span><span class="oak-rightParen">) </span><span class="oak-fnName">uListItemLine?</span><span class="oak-leftParen">(</span><span class="oak-identifier">line</span><span class="oak-rightParen">) </span><span class="oak-or">| </span><span class="oak-fnName">oListItemLine?</span><span class="oak-leftParen">(</span><span class="oak-identifier">line</span><span class="oak-rightParen">)</span>

<span class="oak-fnKeyword">fn </span><span class="oak-fnName">trimUListGetLevel</span><span class="oak-leftParen">(</span><span class="oak-identifier">reader</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
	</span><span class="oak-identifier">level </span><span class="oak-assign">:= </span><span class="oak-fnName">len</span><span class="oak-leftParen">(</span><span class="oak-identifier">reader</span><span class="oak-dot">.</span><span class="oak-fnName">readUntil</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'-'</span><span class="oak-rightParen">)</span><span class="oak-rightParen">)</span><span class="oak-newline">
	</span><span class="oak-identifier">reader</span><span class="oak-dot">.</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-comment">// '-'</span><span class="oak-newline">
	</span><span class="oak-identifier">reader</span><span class="oak-dot">.</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-comment">// ' '</span><span class="oak-newline">
	</span><span class="oak-identifier">level</span>
<span class="oak-rightBrace">}</span>

<span class="oak-fnKeyword">fn </span><span class="oak-fnName">trimOListGetLevel</span><span class="oak-leftParen">(</span><span class="oak-identifier">reader</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
	</span><span class="oak-identifier">peek </span><span class="oak-assign">:= </span><span class="oak-identifier">reader</span><span class="oak-dot">.</span><span class="oak-identifier">peek</span><span class="oak-newline">
	</span><span class="oak-identifier">next </span><span class="oak-assign">:= </span><span class="oak-identifier">reader</span><span class="oak-dot">.</span><span class="oak-identifier">next</span>
<span class="oak-newline">
	</span><span class="oak-comment">// read while whitespace</span><span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">i</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">space?</span><span class="oak-leftParen">(</span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-trueLiteral">true </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">i </span><span class="oak-plus">+ </span><span class="oak-numberLiteral">1</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span><span class="oak-newline">
		</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">i</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-identifier">level </span><span class="oak-assign">:= </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-numberLiteral">0</span><span class="oak-rightParen">)</span>
<span class="oak-newline">
	</span><span class="oak-comment">// eat until dot</span><span class="oak-newline">
	</span><span class="oak-identifier">reader</span><span class="oak-dot">.</span><span class="oak-fnName">readUntil</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'.'</span><span class="oak-rightParen">)</span><span class="oak-newline">
	</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-comment">// eat the .</span>
<span class="oak-newline">
	</span><span class="oak-comment">// if space after dot, swallow it</span><span class="oak-newline">
	</span><span class="oak-ifKeyword">if </span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-stringLiteral">' ' </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-identifier">level</span>
<span class="oak-rightBrace">}</span>

<span class="oak-comment">// lineNodeType reports the node type of a particular Markdown line for parsing</span>
<span class="oak-fnKeyword">fn </span><span class="oak-fnName">lineNodeType</span><span class="oak-leftParen">(</span><span class="oak-identifier">line</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-leftBrace">{</span><span class="oak-newline">
	</span><span class="oak-identifier">line </span><span class="oak-eq">= </span><span class="oak-qmark">? </span><span class="oak-branchArrow">-> </span><span class="oak-qmark">?</span><span class="oak-newline">
	</span><span class="oak-identifier">line </span><span class="oak-eq">= </span><span class="oak-stringLiteral">'' </span><span class="oak-branchArrow">-> </span><span class="oak-colon">:</span><span class="oak-identifier">empty</span><span class="oak-newline">
	</span><span class="oak-fnName">startsWith?</span><span class="oak-leftParen">(</span><span class="oak-identifier">line</span><span class="oak-comma">, </span><span class="oak-stringLiteral">'# '</span><span class="oak-rightParen">) </span><span class="oak-branchArrow">-> </span><span class="oak-colon">:</span><span class="oak-identifier">h1</span><span class="oak-newline">
	</span><span class="oak-fnName">startsWith?</span><span class="oak-leftParen">(</span><span class="oak-identifier">line</span><span class="oak-comma">, </span><span class="oak-stringLiteral">'## '</span><span class="oak-rightParen">) </span><span class="oak-branchArrow">-> </span><span class="oak-colon">:</span><span class="oak-identifier">h2</span><span class="oak-newline">
	</span><span class="oak-fnName">startsWith?</span><span class="oak-leftParen">(</span><span class="oak-identifier">line</span><span class="oak-comma">, </span><span class="oak-stringLiteral">'### '</span><span class="oak-rightParen">) </span><span class="oak-branchArrow">-> </span><span class="oak-colon">:</span><span class="oak-identifier">h3</span><span class="oak-newline">
	</span><span class="oak-fnName">startsWith?</span><span class="oak-leftParen">(</span><span class="oak-identifier">line</span><span class="oak-comma">, </span><span class="oak-stringLiteral">'#### '</span><span class="oak-rightParen">) </span><span class="oak-branchArrow">-> </span><span class="oak-colon">:</span><span class="oak-identifier">h4</span><span class="oak-newline">
	</span><span class="oak-fnName">startsWith?</span><span class="oak-leftParen">(</span><span class="oak-identifier">line</span><span class="oak-comma">, </span><span class="oak-stringLiteral">'##### '</span><span class="oak-rightParen">) </span><span class="oak-branchArrow">-> </span><span class="oak-colon">:</span><span class="oak-identifier">h5</span><span class="oak-newline">
	</span><span class="oak-fnName">startsWith?</span><span class="oak-leftParen">(</span><span class="oak-identifier">line</span><span class="oak-comma">, </span><span class="oak-stringLiteral">'###### '</span><span class="oak-rightParen">) </span><span class="oak-branchArrow">-> </span><span class="oak-colon">:</span><span class="oak-identifier">h6</span><span class="oak-newline">
	</span><span class="oak-fnName">startsWith?</span><span class="oak-leftParen">(</span><span class="oak-identifier">line</span><span class="oak-comma">, </span><span class="oak-stringLiteral">'>'</span><span class="oak-rightParen">) </span><span class="oak-branchArrow">-> </span><span class="oak-colon">:</span><span class="oak-identifier">blockquote</span><span class="oak-newline">
	</span><span class="oak-fnName">startsWith?</span><span class="oak-leftParen">(</span><span class="oak-identifier">line</span><span class="oak-comma">, </span><span class="oak-stringLiteral">'```'</span><span class="oak-rightParen">) </span><span class="oak-branchArrow">-> </span><span class="oak-colon">:</span><span class="oak-identifier">pre</span><span class="oak-newline">
	</span><span class="oak-fnName">startsWith?</span><span class="oak-leftParen">(</span><span class="oak-identifier">line</span><span class="oak-comma">, </span><span class="oak-stringLiteral">'---'</span><span class="oak-rightParen">)</span><span class="oak-comma">, </span><span class="oak-fnName">startsWith?</span><span class="oak-leftParen">(</span><span class="oak-identifier">line</span><span class="oak-comma">, </span><span class="oak-stringLiteral">'***'</span><span class="oak-rightParen">) </span><span class="oak-branchArrow">-> </span><span class="oak-colon">:</span><span class="oak-identifier">hr</span><span class="oak-newline">
	</span><span class="oak-fnName">startsWith?</span><span class="oak-leftParen">(</span><span class="oak-identifier">line</span><span class="oak-comma">, </span><span class="oak-stringLiteral">'!html'</span><span class="oak-rightParen">) </span><span class="oak-branchArrow">-> </span><span class="oak-colon">:</span><span class="oak-identifier">rawHTML</span><span class="oak-newline">
	</span><span class="oak-fnName">uListItemLine?</span><span class="oak-leftParen">(</span><span class="oak-identifier">line</span><span class="oak-rightParen">) </span><span class="oak-branchArrow">-> </span><span class="oak-colon">:</span><span class="oak-identifier">ul</span><span class="oak-newline">
	</span><span class="oak-fnName">oListItemLine?</span><span class="oak-leftParen">(</span><span class="oak-identifier">line</span><span class="oak-rightParen">) </span><span class="oak-branchArrow">-> </span><span class="oak-colon">:</span><span class="oak-identifier">ol</span><span class="oak-newline">
	</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-colon">:</span><span class="oak-identifier">p</span>
<span class="oak-rightBrace">}</span>

<span class="oak-comment">// parse parses a byte string of Markdown formatted text into a Markdown AST,</span>
<span class="oak-comment">// by looking at each line and either changing internal state if the line is a</span>
<span class="oak-comment">// special line like a code fence or a raw HTML literal, or calling</span>
<span class="oak-comment">// tokenizeText() if the line is a raw paragraph or header.</span>
<span class="oak-fnKeyword">fn </span><span class="oak-fnName">parse</span><span class="oak-leftParen">(</span><span class="oak-identifier">text</span><span class="oak-rightParen">) </span><span class="oak-identifier">text </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">split</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'\n'</span><span class="oak-rightParen">) </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">Reader</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">parseDoc</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span>

<span class="oak-comment">// parseDoc parses a Markdown docment from a line Reader. This allows</span>
<span class="oak-comment">// sub-sections of the document to re-use this document parser to parse e.g.</span>
<span class="oak-comment">// quoted sections that should be parsed as an independent subsection by</span>
<span class="oak-comment">// providing a line Reader interface.</span>
<span class="oak-fnKeyword">fn </span><span class="oak-fnName">parseDoc</span><span class="oak-leftParen">(</span><span class="oak-identifier">lineReader</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">doc</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">nodeType </span><span class="oak-assign">:= </span><span class="oak-fnName">lineNodeType</span><span class="oak-leftParen">(</span><span class="oak-identifier">lineReader</span><span class="oak-dot">.</span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">h1</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">h2</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">h3</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">h4</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">h5</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">h6 </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">doc </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-fnName">parseHeader</span><span class="oak-leftParen">(</span><span class="oak-identifier">nodeType</span><span class="oak-comma">, </span><span class="oak-identifier">lineReader</span><span class="oak-rightParen">)</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">blockquote </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">doc </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-fnName">parseBlockQuote</span><span class="oak-leftParen">(</span><span class="oak-identifier">lineReader</span><span class="oak-rightParen">)</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">pre </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">doc </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-fnName">parseCodeBlock</span><span class="oak-leftParen">(</span><span class="oak-identifier">lineReader</span><span class="oak-rightParen">)</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">ul</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">ol </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">doc </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-fnName">parseList</span><span class="oak-leftParen">(</span><span class="oak-identifier">lineReader</span><span class="oak-comma">, </span><span class="oak-identifier">nodeType</span><span class="oak-rightParen">)</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">rawHTML </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">doc </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-fnName">parseRawHTML</span><span class="oak-leftParen">(</span><span class="oak-identifier">lineReader</span><span class="oak-rightParen">)</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">p </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">doc </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-fnName">parseParagraph</span><span class="oak-leftParen">(</span><span class="oak-identifier">lineReader</span><span class="oak-rightParen">)</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">hr </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-identifier">lineReader</span><span class="oak-dot">.</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">doc </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-leftBrace">{ </span><span class="oak-identifier">tag</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">hr </span><span class="oak-rightBrace">}</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">empty </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-identifier">lineReader</span><span class="oak-dot">.</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">doc</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span><span class="oak-newline">
		</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">doc</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-leftBracket">[</span><span class="oak-rightBracket">]</span><span class="oak-rightParen">)</span>
<span class="oak-rightBrace">}</span>

<span class="oak-fnKeyword">fn </span><span class="oak-fnName">parseHeader</span><span class="oak-leftParen">(</span><span class="oak-identifier">nodeType</span><span class="oak-comma">, </span><span class="oak-identifier">lineReader</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
	</span><span class="oak-identifier">reader </span><span class="oak-assign">:= </span><span class="oak-fnName">Reader</span><span class="oak-leftParen">(</span><span class="oak-identifier">lineReader</span><span class="oak-dot">.</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">)</span><span class="oak-newline">
	</span><span class="oak-identifier">reader</span><span class="oak-dot">.</span><span class="oak-fnName">readUntil</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">' '</span><span class="oak-rightParen">)</span><span class="oak-newline">
	</span><span class="oak-identifier">reader</span><span class="oak-dot">.</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span>
<span class="oak-newline">
	</span><span class="oak-identifier">text </span><span class="oak-assign">:= </span><span class="oak-identifier">reader</span><span class="oak-dot">.</span><span class="oak-fnName">readUntilEnd</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
	</span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-identifier">tag</span><span class="oak-colon">: </span><span class="oak-identifier">nodeType</span><span class="oak-newline">
		</span><span class="oak-identifier">children</span><span class="oak-colon">: </span><span class="oak-fnName">tokenizeText</span><span class="oak-leftParen">(</span><span class="oak-identifier">text</span><span class="oak-rightParen">) </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">parseText</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span>
<span class="oak-rightBrace">}</span>

<span class="oak-fnKeyword">fn </span><span class="oak-fnName">parseBlockQuote</span><span class="oak-leftParen">(</span><span class="oak-identifier">lineReader</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
	</span><span class="oak-identifier">peek </span><span class="oak-assign">:= </span><span class="oak-identifier">lineReader</span><span class="oak-dot">.</span><span class="oak-identifier">peek</span><span class="oak-newline">
	</span><span class="oak-identifier">next </span><span class="oak-assign">:= </span><span class="oak-identifier">lineReader</span><span class="oak-dot">.</span><span class="oak-identifier">next</span>
<span class="oak-newline">
	</span><span class="oak-comment">// A piece of a document inside a quoted block needs to be parsed as if it</span><span class="oak-newline">
	</span><span class="oak-comment">// were its own document. The BlockQuotedLineReader provides a line Reader</span><span class="oak-newline">
	</span><span class="oak-comment">// that masquerades as a document reader to parseDoc.</span><span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">BlockQuoteLineReader</span><span class="oak-leftParen">(</span><span class="oak-identifier">lineReader</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">returnIfQuoted</span><span class="oak-leftParen">(</span><span class="oak-identifier">line</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">lineNodeType</span><span class="oak-leftParen">(</span><span class="oak-identifier">line</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-colon">:</span><span class="oak-identifier">blockquote </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">line </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">slice</span><span class="oak-leftParen">(</span><span class="oak-numberLiteral">1</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-qmark">?</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span>
<span class="oak-newline">
		</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">peek </span><span class="oak-fnName">returnIfQuoted</span><span class="oak-leftParen">(</span><span class="oak-identifier">lineReader</span><span class="oak-dot">.</span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">last </span><span class="oak-fnName">returnIfQuoted</span><span class="oak-leftParen">(</span><span class="oak-identifier">lineReader</span><span class="oak-dot">.</span><span class="oak-fnName">last</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">back </span><span class="oak-identifier">lineReader</span><span class="oak-dot">.</span><span class="oak-fnName">back</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">next </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">lineNodeType</span><span class="oak-leftParen">(</span><span class="oak-identifier">lineReader</span><span class="oak-dot">.</span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-colon">:</span><span class="oak-identifier">blockquote </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">lineReader</span><span class="oak-dot">.</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">trimStart</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'>'</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-qmark">?</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span><span class="oak-newline">
		</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">expect? </span><span class="oak-qmark">? </span><span class="oak-comment">// NOTE: not implemented</span><span class="oak-newline">
		</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">readUntil</span><span class="oak-leftParen">(</span><span class="oak-identifier">c</span><span class="oak-rightParen">) </span><span class="oak-identifier">lineReader</span><span class="oak-dot">.</span><span class="oak-fnName">readdUntil</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'>' </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">c</span><span class="oak-rightParen">) </span><span class="oak-pipeArrow">|></span><span class="oak-newline">
			</span><span class="oak-withKeyword">with </span><span class="oak-fnName">map</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn</span><span class="oak-leftParen">(</span><span class="oak-identifier">line</span><span class="oak-rightParen">) </span><span class="oak-identifier">line </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">slice</span><span class="oak-leftParen">(</span><span class="oak-numberLiteral">1</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">readUntilPrefix</span><span class="oak-leftParen">(</span><span class="oak-identifier">prefix</span><span class="oak-rightParen">) </span><span class="oak-identifier">lineReader</span><span class="oak-dot">.</span><span class="oak-fnName">readUntilPrefix</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'>' </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">c</span><span class="oak-rightParen">) </span><span class="oak-pipeArrow">|></span><span class="oak-newline">
			</span><span class="oak-withKeyword">with </span><span class="oak-fnName">map</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn</span><span class="oak-leftParen">(</span><span class="oak-identifier">line</span><span class="oak-rightParen">) </span><span class="oak-identifier">line </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">slice</span><span class="oak-leftParen">(</span><span class="oak-numberLiteral">1</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">readUntilMatchingDelim </span><span class="oak-qmark">? </span><span class="oak-comment">// NOTE: not implemented</span>
<span class="oak-newline">
		</span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-identifier">peek</span><span class="oak-colon">: </span><span class="oak-identifier">peek</span><span class="oak-newline">
			</span><span class="oak-identifier">last</span><span class="oak-colon">: </span><span class="oak-identifier">last</span><span class="oak-newline">
			</span><span class="oak-identifier">back</span><span class="oak-colon">: </span><span class="oak-identifier">back</span><span class="oak-newline">
			</span><span class="oak-identifier">next</span><span class="oak-colon">: </span><span class="oak-identifier">next</span><span class="oak-newline">
			</span><span class="oak-identifier">expect?</span><span class="oak-colon">: </span><span class="oak-identifier">expect?</span><span class="oak-newline">
			</span><span class="oak-identifier">readUntil</span><span class="oak-colon">: </span><span class="oak-identifier">readUntil</span><span class="oak-newline">
			</span><span class="oak-identifier">readUntilPrefix</span><span class="oak-colon">: </span><span class="oak-identifier">readUntilPrefix</span><span class="oak-newline">
			</span><span class="oak-identifier">readUntilEnd</span><span class="oak-colon">: </span><span class="oak-identifier">lineReader</span><span class="oak-dot">.</span><span class="oak-identifier">readUntilEnd</span><span class="oak-newline">
			</span><span class="oak-identifier">readUntilMatchingDelim</span><span class="oak-colon">: </span><span class="oak-identifier">readUntilMatchingDelim</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span>
<span class="oak-newline">
	</span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-identifier">tag</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">blockquote</span><span class="oak-newline">
		</span><span class="oak-identifier">children</span><span class="oak-colon">: </span><span class="oak-fnName">BlockQuoteLineReader</span><span class="oak-leftParen">(</span><span class="oak-identifier">lineReader</span><span class="oak-rightParen">) </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">parseDoc</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span>
<span class="oak-rightBrace">}</span>

<span class="oak-fnKeyword">fn </span><span class="oak-fnName">parseCodeBlock</span><span class="oak-leftParen">(</span><span class="oak-identifier">lineReader</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
	</span><span class="oak-identifier">peek </span><span class="oak-assign">:= </span><span class="oak-identifier">lineReader</span><span class="oak-dot">.</span><span class="oak-identifier">peek</span><span class="oak-newline">
	</span><span class="oak-identifier">next </span><span class="oak-assign">:= </span><span class="oak-identifier">lineReader</span><span class="oak-dot">.</span><span class="oak-identifier">next</span>
<span class="oak-newline">
	</span><span class="oak-identifier">startTag </span><span class="oak-assign">:= </span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-comment">// eat starting pre tag</span><span class="oak-newline">
	</span><span class="oak-identifier">lang </span><span class="oak-assign">:= </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">rest </span><span class="oak-assign">:= </span><span class="oak-identifier">startTag </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">slice</span><span class="oak-leftParen">(</span><span class="oak-numberLiteral">3</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-stringLiteral">'' </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">''</span><span class="oak-newline">
		</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">rest</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span>
<span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">lines</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">lineNodeType</span><span class="oak-leftParen">(</span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">pre</span><span class="oak-comma">, </span><span class="oak-qmark">? </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">lines</span><span class="oak-newline">
		</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">lines </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">)</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-identifier">children </span><span class="oak-assign">:= </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-leftBracket">[</span><span class="oak-rightBracket">]</span><span class="oak-rightParen">)</span>
<span class="oak-newline">
	</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-comment">// eat ending pre tag</span>
<span class="oak-newline">
	</span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-identifier">tag</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">pre</span><span class="oak-newline">
		</span><span class="oak-identifier">children</span><span class="oak-colon">: </span><span class="oak-leftBracket">[</span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-identifier">tag</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">code</span><span class="oak-newline">
			</span><span class="oak-identifier">lang</span><span class="oak-colon">: </span><span class="oak-identifier">lang</span><span class="oak-newline">
			</span><span class="oak-identifier">children</span><span class="oak-colon">: </span><span class="oak-fnName">unifyTextNodes</span><span class="oak-leftParen">(</span><span class="oak-identifier">children</span><span class="oak-comma">, </span><span class="oak-stringLiteral">'\n'</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span><span class="oak-rightBracket">]</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span>
<span class="oak-rightBrace">}</span>

<span class="oak-fnKeyword">fn </span><span class="oak-fnName">parseRawHTML</span><span class="oak-leftParen">(</span><span class="oak-identifier">lineReader</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
	</span><span class="oak-identifier">peek </span><span class="oak-assign">:= </span><span class="oak-identifier">lineReader</span><span class="oak-dot">.</span><span class="oak-identifier">peek</span><span class="oak-newline">
	</span><span class="oak-identifier">next </span><span class="oak-assign">:= </span><span class="oak-identifier">lineReader</span><span class="oak-dot">.</span><span class="oak-identifier">next</span>
<span class="oak-newline">
	</span><span class="oak-identifier">startMarkLine </span><span class="oak-assign">:= </span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
	</span><span class="oak-identifier">firstLine </span><span class="oak-assign">:= </span><span class="oak-identifier">startMarkLine </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">slice</span><span class="oak-leftParen">(</span><span class="oak-fnName">len</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'!html '</span><span class="oak-rightParen">)</span><span class="oak-rightParen">)</span>
<span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">lines</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">lineNodeType</span><span class="oak-leftParen">(</span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">empty</span><span class="oak-comma">, </span><span class="oak-qmark">? </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">lines</span><span class="oak-newline">
		</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">lines </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">)</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-identifier">children </span><span class="oak-assign">:= </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-leftBracket">[</span><span class="oak-identifier">firstLine</span><span class="oak-rightBracket">]</span><span class="oak-rightParen">)</span>
<span class="oak-newline">
	</span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-identifier">tag</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">rawHTML</span><span class="oak-newline">
		</span><span class="oak-identifier">children</span><span class="oak-colon">: </span><span class="oak-fnName">unifyTextNodes</span><span class="oak-leftParen">(</span><span class="oak-identifier">children</span><span class="oak-comma">, </span><span class="oak-stringLiteral">'\n'</span><span class="oak-rightParen">)</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span>
<span class="oak-rightBrace">}</span>

<span class="oak-fnKeyword">fn </span><span class="oak-fnName">parseList</span><span class="oak-leftParen">(</span><span class="oak-identifier">lineReader</span><span class="oak-comma">, </span><span class="oak-identifier">listType</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
	</span><span class="oak-identifier">peek </span><span class="oak-assign">:= </span><span class="oak-identifier">lineReader</span><span class="oak-dot">.</span><span class="oak-identifier">peek</span><span class="oak-newline">
	</span><span class="oak-identifier">next </span><span class="oak-assign">:= </span><span class="oak-identifier">lineReader</span><span class="oak-dot">.</span><span class="oak-identifier">next</span>
<span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">items</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">listItemLine?</span><span class="oak-leftParen">(</span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-falseLiteral">false </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">items</span><span class="oak-newline">
		</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-comment">// TODO: provide a way for one listItem to contain 2+ paragraphs</span><span class="oak-newline">
			</span><span class="oak-comment">// The current convention seems to be that if there is at least one</span><span class="oak-newline">
			</span><span class="oak-comment">// multi-paragraph listItem in a UL, every listItem in the UL gets</span><span class="oak-newline">
			</span><span class="oak-comment">// &lt;p>s rather than inline text nodes as content.</span><span class="oak-newline">
			</span><span class="oak-identifier">line </span><span class="oak-assign">:= </span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-identifier">lineType </span><span class="oak-assign">:= </span><span class="oak-fnName">lineNodeType</span><span class="oak-leftParen">(</span><span class="oak-identifier">line</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-identifier">reader </span><span class="oak-assign">:= </span><span class="oak-fnName">Reader</span><span class="oak-leftParen">(</span><span class="oak-identifier">line</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-identifier">trimmer </span><span class="oak-assign">:= </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">lineType </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-colon">:</span><span class="oak-identifier">ul </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">trimUListGetLevel</span><span class="oak-newline">
				</span><span class="oak-colon">:</span><span class="oak-identifier">ol </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">trimOListGetLevel</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span><span class="oak-newline">
			</span><span class="oak-identifier">level </span><span class="oak-assign">:= </span><span class="oak-fnName">trimmer</span><span class="oak-leftParen">(</span><span class="oak-identifier">reader</span><span class="oak-rightParen">)</span>
<span class="oak-newline">
			</span><span class="oak-identifier">text </span><span class="oak-assign">:= </span><span class="oak-identifier">reader</span><span class="oak-dot">.</span><span class="oak-fnName">readUntilEnd</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-identifier">listItem </span><span class="oak-assign">:= </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-identifier">tag</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">li</span><span class="oak-newline">
				</span><span class="oak-identifier">level</span><span class="oak-colon">: </span><span class="oak-identifier">level</span><span class="oak-newline">
				</span><span class="oak-identifier">children</span><span class="oak-colon">: </span><span class="oak-fnName">tokenizeText</span><span class="oak-leftParen">(</span><span class="oak-identifier">text</span><span class="oak-rightParen">) </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">parseText</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span>
<span class="oak-newline">
			</span><span class="oak-comment">// handle list items that have distinct levels</span><span class="oak-newline">
			</span><span class="oak-ifKeyword">if </span><span class="oak-identifier">lastItem </span><span class="oak-assign">:= </span><span class="oak-identifier">items</span><span class="oak-dot">.</span><span class="oak-leftParen">(</span><span class="oak-fnName">len</span><span class="oak-leftParen">(</span><span class="oak-identifier">items</span><span class="oak-rightParen">) </span><span class="oak-minus">- </span><span class="oak-numberLiteral">1</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-qmark">? </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">items </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">listItem</span><span class="oak-rightParen">)</span><span class="oak-newline">
				</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-identifier">lastItem</span><span class="oak-dot">.</span><span class="oak-identifier">level </span><span class="oak-eq">= </span><span class="oak-identifier">level </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">lineType </span><span class="oak-leftBrace">{</span><span class="oak-newline">
						</span><span class="oak-comment">// continue if same list type; otherwise re-parse</span><span class="oak-newline">
						</span><span class="oak-identifier">listType </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">items </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">listItem</span><span class="oak-rightParen">)</span><span class="oak-newline">
						</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
							</span><span class="oak-identifier">lineReader</span><span class="oak-dot">.</span><span class="oak-fnName">back</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
							</span><span class="oak-identifier">items</span><span class="oak-newline">
						</span><span class="oak-rightBrace">}</span><span class="oak-newline">
					</span><span class="oak-rightBrace">}</span><span class="oak-newline">
					</span><span class="oak-identifier">lastItem</span><span class="oak-dot">.</span><span class="oak-identifier">level </span><span class="oak-less">&lt; </span><span class="oak-identifier">level </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
						</span><span class="oak-comment">// indent in: begin parsing a separate list</span><span class="oak-newline">
						</span><span class="oak-identifier">lineReader</span><span class="oak-dot">.</span><span class="oak-fnName">back</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
						</span><span class="oak-identifier">list </span><span class="oak-assign">:= </span><span class="oak-fnName">parseList</span><span class="oak-leftParen">(</span><span class="oak-identifier">lineReader</span><span class="oak-comma">, </span><span class="oak-identifier">lineType</span><span class="oak-rightParen">)</span><span class="oak-newline">
						</span><span class="oak-identifier">lastItem</span><span class="oak-dot">.</span><span class="oak-identifier">children </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">list</span><span class="oak-newline">
						</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">items</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-rightBrace">}</span><span class="oak-newline">
					</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
						</span><span class="oak-comment">// indent out: give up control in this parsing depth</span><span class="oak-newline">
						</span><span class="oak-identifier">lineReader</span><span class="oak-dot">.</span><span class="oak-fnName">back</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
						</span><span class="oak-identifier">items</span><span class="oak-newline">
					</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-identifier">children </span><span class="oak-assign">:= </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-leftBracket">[</span><span class="oak-rightBracket">]</span><span class="oak-rightParen">)</span>
<span class="oak-newline">
	</span><span class="oak-comment">// remove the level annotations</span><span class="oak-newline">
	</span><span class="oak-identifier">children </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">each</span><span class="oak-leftParen">(</span><span class="oak-fnKeyword">fn</span><span class="oak-leftParen">(</span><span class="oak-identifier">child</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">child</span><span class="oak-dot">.</span><span class="oak-identifier">tag </span><span class="oak-eq">= </span><span class="oak-colon">:</span><span class="oak-identifier">li </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">child</span><span class="oak-dot">.</span><span class="oak-identifier">level </span><span class="oak-assign">:= </span><span class="oak-underscore">_</span><span class="oak-rightParen">)</span>
<span class="oak-newline">
	</span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-identifier">tag</span><span class="oak-colon">: </span><span class="oak-identifier">listType</span><span class="oak-newline">
		</span><span class="oak-identifier">children</span><span class="oak-colon">: </span><span class="oak-identifier">children</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span>
<span class="oak-rightBrace">}</span>

<span class="oak-fnKeyword">fn </span><span class="oak-fnName">parseParagraph</span><span class="oak-leftParen">(</span><span class="oak-identifier">lineReader</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
	</span><span class="oak-identifier">peek </span><span class="oak-assign">:= </span><span class="oak-identifier">lineReader</span><span class="oak-dot">.</span><span class="oak-identifier">peek</span><span class="oak-newline">
	</span><span class="oak-identifier">next </span><span class="oak-assign">:= </span><span class="oak-identifier">lineReader</span><span class="oak-dot">.</span><span class="oak-identifier">next</span>
<span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">lines</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">lineNodeType</span><span class="oak-leftParen">(</span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">p </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-identifier">text </span><span class="oak-assign">:= </span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-ifKeyword">if </span><span class="oak-leftBracket">[</span><span class="oak-identifier">text </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">endsWith?</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'  '</span><span class="oak-rightParen">)</span><span class="oak-comma">, </span><span class="oak-identifier">text</span><span class="oak-dot">.</span><span class="oak-leftParen">(</span><span class="oak-fnName">len</span><span class="oak-leftParen">(</span><span class="oak-identifier">text</span><span class="oak-rightParen">) </span><span class="oak-minus">- </span><span class="oak-numberLiteral">1</span><span class="oak-rightParen">)</span><span class="oak-rightBracket">] </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-leftBracket">[</span><span class="oak-trueLiteral">true</span><span class="oak-comma">, </span><span class="oak-underscore">_</span><span class="oak-rightBracket">] </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-identifier">lines </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">append</span><span class="oak-leftParen">(</span><span class="oak-identifier">text </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">slice</span><span class="oak-leftParen">(</span><span class="oak-numberLiteral">0</span><span class="oak-comma">, </span><span class="oak-fnName">len</span><span class="oak-leftParen">(</span><span class="oak-identifier">text</span><span class="oak-rightParen">) </span><span class="oak-minus">- </span><span class="oak-numberLiteral">2</span><span class="oak-rightParen">) </span><span class="oak-pipeArrow">|></span><span class="oak-newline">
						</span><span class="oak-fnName">tokenizeText</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">parseText</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">lines </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-leftBrace">{ </span><span class="oak-identifier">tag</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">br </span><span class="oak-rightBrace">}</span><span class="oak-rightParen">)</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-leftBracket">[</span><span class="oak-underscore">_</span><span class="oak-comma">, </span><span class="oak-stringLiteral">'\\'</span><span class="oak-rightBracket">] </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-identifier">lines </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">append</span><span class="oak-leftParen">(</span><span class="oak-identifier">text </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">slice</span><span class="oak-leftParen">(</span><span class="oak-numberLiteral">0</span><span class="oak-comma">, </span><span class="oak-fnName">len</span><span class="oak-leftParen">(</span><span class="oak-identifier">text</span><span class="oak-rightParen">) </span><span class="oak-minus">- </span><span class="oak-numberLiteral">1</span><span class="oak-rightParen">) </span><span class="oak-pipeArrow">|></span><span class="oak-newline">
						</span><span class="oak-fnName">tokenizeText</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">parseText</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">lines </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-leftBrace">{ </span><span class="oak-identifier">tag</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">br </span><span class="oak-rightBrace">}</span><span class="oak-rightParen">)</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">lines </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">append</span><span class="oak-leftParen">(</span><span class="oak-fnName">tokenizeText</span><span class="oak-leftParen">(</span><span class="oak-identifier">text</span><span class="oak-rightParen">) </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">parseText</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">)</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span><span class="oak-newline">
		</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">lines</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span>
<span class="oak-newline">
	</span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-identifier">tag</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">p</span><span class="oak-newline">
		</span><span class="oak-identifier">children</span><span class="oak-colon">: </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-leftBracket">[</span><span class="oak-rightBracket">]</span><span class="oak-rightParen">) </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">unifyTextNodes</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">' '</span><span class="oak-rightParen">)</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span>
<span class="oak-rightBrace">}</span>

<span class="oak-comment">// compile transforms a Markdown AST node to HTML</span>
<span class="oak-fnKeyword">fn </span><span class="oak-fnName">compile</span><span class="oak-leftParen">(</span><span class="oak-identifier">nodes</span><span class="oak-rightParen">) </span><span class="oak-identifier">nodes </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">map</span><span class="oak-leftParen">(</span><span class="oak-identifier">compileNode</span><span class="oak-rightParen">) </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">join</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span>

<span class="oak-fnKeyword">fn </span><span class="oak-fnName">wrap</span><span class="oak-leftParen">(</span><span class="oak-identifier">tag</span><span class="oak-comma">, </span><span class="oak-identifier">node</span><span class="oak-rightParen">) </span><span class="oak-stringLiteral">'&lt;' </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">tag </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-stringLiteral">'>' </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-fnName">compile</span><span class="oak-leftParen">(</span><span class="oak-identifier">node</span><span class="oak-dot">.</span><span class="oak-identifier">children</span><span class="oak-rightParen">) </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-stringLiteral">'&lt;/' </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">tag </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-stringLiteral">'>'</span>

<span class="oak-comment">// compileNode transforms an individual Markdown AST node into HTML</span>
<span class="oak-fnKeyword">fn </span><span class="oak-fnName">compileNode</span><span class="oak-leftParen">(</span><span class="oak-identifier">node</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">type</span><span class="oak-leftParen">(</span><span class="oak-identifier">node</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
	</span><span class="oak-colon">:</span><span class="oak-identifier">string </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">node </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">map</span><span class="oak-leftParen">(</span><span class="oak-fnKeyword">fn</span><span class="oak-leftParen">(</span><span class="oak-identifier">c</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">c </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-stringLiteral">'&amp;' </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'&amp;amp;'</span><span class="oak-newline">
		</span><span class="oak-stringLiteral">'&lt;' </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'&amp;lt;'</span><span class="oak-newline">
		</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">c</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span><span class="oak-rightParen">)</span><span class="oak-newline">
	</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">node</span><span class="oak-dot">.</span><span class="oak-identifier">tag </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">p</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">em</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">strong</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">strike</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">h1</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">h2</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">h3</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">h4</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">h5</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">h6</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">pre</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">ul</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">ol</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">li</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">blockquote </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">wrap</span><span class="oak-leftParen">(</span><span class="oak-identifier">node</span><span class="oak-dot">.</span><span class="oak-identifier">tag </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">string</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-comma">, </span><span class="oak-identifier">node</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">a </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'&lt;a href="{{0}}">{{1}}&lt;/a>' </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">format</span><span class="oak-leftParen">(</span><span class="oak-identifier">node</span><span class="oak-dot">.</span><span class="oak-identifier">href</span><span class="oak-comma">, </span><span class="oak-fnName">compile</span><span class="oak-leftParen">(</span><span class="oak-identifier">node</span><span class="oak-dot">.</span><span class="oak-identifier">children</span><span class="oak-rightParen">)</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">img </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'&lt;img alt="{{0}}" src="{{1}}"/>' </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">format</span><span class="oak-leftParen">(</span><span class="oak-identifier">node</span><span class="oak-dot">.</span><span class="oak-identifier">alt</span><span class="oak-comma">, </span><span class="oak-identifier">node</span><span class="oak-dot">.</span><span class="oak-identifier">src</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">code </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">node</span><span class="oak-dot">.</span><span class="oak-identifier">lang </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-stringLiteral">''</span><span class="oak-comma">, </span><span class="oak-qmark">? </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">wrap</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'code'</span><span class="oak-comma">, </span><span class="oak-identifier">node</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'&lt;code data-lang="{{0}}">{{1}}&lt;/code>' </span><span class="oak-pipeArrow">|></span><span class="oak-newline">
				</span><span class="oak-fnName">format</span><span class="oak-leftParen">(</span><span class="oak-identifier">node</span><span class="oak-dot">.</span><span class="oak-identifier">lang</span><span class="oak-comma">, </span><span class="oak-fnName">compile</span><span class="oak-leftParen">(</span><span class="oak-identifier">node</span><span class="oak-dot">.</span><span class="oak-identifier">children</span><span class="oak-rightParen">)</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">checkbox </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'&lt;input type="checkbox" ' </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">node</span><span class="oak-dot">.</span><span class="oak-identifier">checked </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-trueLiteral">true </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'checked'</span><span class="oak-newline">
			</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">''</span><span class="oak-newline">
		</span><span class="oak-rightBrace">} </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-stringLiteral">'/>'</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">br </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'&lt;br/>'</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">hr </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'&lt;hr/>'</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">rawHTML </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">node</span><span class="oak-dot">.</span><span class="oak-identifier">children</span><span class="oak-dot">.</span><span class="oak-numberLiteral">0</span><span class="oak-newline">
		</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'&lt;span style="color:red">Unknown Markdown node {{0}}&lt;/span>' </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">format</span><span class="oak-leftParen">(</span><span class="oak-fnName">string</span><span class="oak-leftParen">(</span><span class="oak-identifier">node</span><span class="oak-rightParen">)</span><span class="oak-rightParen">)</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span>
<span class="oak-rightBrace">}</span>

<span class="oak-comment">// transform wraps the Markdown parser and compiler into a single function to be</span>
<span class="oak-comment">// invoked by the library consumer.</span>
<span class="oak-fnKeyword">fn </span><span class="oak-fnName">transform</span><span class="oak-leftParen">(</span><span class="oak-identifier">text</span><span class="oak-rightParen">) </span><span class="oak-identifier">text </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">parse</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">compile</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span>

</code></pre>
        </article>
    </main>
    <footer>
        <div class="split overlay">
            <div class="left">
            </div>
            <div class="right">
                - <a href="https://thesephist.com/">Linus</a>
            </div>
        </div>
    </footer>
</body>
