<!doctype html>
<head>
    <meta charset="utf-8">
    <title>syntax.oak | Oak programming language</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/lib.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;700&family=IBM+Plex+Sans:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <div class="overlay">
            <div class="home">
                <a href="/">Oak</a>
            </div>
            <nav>
                <a href="/lib/"><span class="desktop">standard library</span><span class="mobile">stdlib</span></a>
                <a href="/posts/">blog</a>
                <a href="/#start">download</a>
                <a href="https://github.com/thesephist/oak" target="_blank">source ↗</a>
            </nav>
        </div>
    </header>
    <main aria-role="main">
        <article class="overlay stdlib">
            <h1>syntax.oak</h1>
            <p class="meta">
                <a href="/lib/">&larr; Standard library</a>
                <a href="https://github.com/thesephist/oak/blob/main/lib/syntax.oak">See on GitHub ↗</a>
            </p>
            <pre><code><span class="oak-comment">// libsyntax implements a tokenizer, parser, and code formatter for Oak</span>

<span class="oak-leftBrace">{</span><span class="oak-newline">
	</span><span class="oak-identifier">default</span><span class="oak-colon">: </span><span class="oak-identifier">default</span><span class="oak-newline">
	</span><span class="oak-identifier">fromHex</span><span class="oak-colon">: </span><span class="oak-identifier">fromHex</span><span class="oak-newline">
	</span><span class="oak-identifier">range</span><span class="oak-colon">: </span><span class="oak-identifier">range</span><span class="oak-newline">
	</span><span class="oak-identifier">slice</span><span class="oak-colon">: </span><span class="oak-identifier">slice</span><span class="oak-newline">
	</span><span class="oak-identifier">append</span><span class="oak-colon">: </span><span class="oak-identifier">append</span><span class="oak-newline">
	</span><span class="oak-identifier">contains?</span><span class="oak-colon">: </span><span class="oak-identifier">contains?</span><span class="oak-newline">
	</span><span class="oak-identifier">map</span><span class="oak-colon">: </span><span class="oak-identifier">map</span><span class="oak-newline">
	</span><span class="oak-identifier">each</span><span class="oak-colon">: </span><span class="oak-identifier">each</span><span class="oak-newline">
	</span><span class="oak-identifier">last</span><span class="oak-colon">: </span><span class="oak-identifier">last</span><span class="oak-newline">
	</span><span class="oak-identifier">take</span><span class="oak-colon">: </span><span class="oak-identifier">take</span><span class="oak-newline">
	</span><span class="oak-identifier">first</span><span class="oak-colon">: </span><span class="oak-identifier">first</span><span class="oak-newline">
	</span><span class="oak-identifier">filter</span><span class="oak-colon">: </span><span class="oak-identifier">filter</span><span class="oak-newline">
	</span><span class="oak-identifier">reduce</span><span class="oak-colon">: </span><span class="oak-identifier">reduce</span>
<span class="oak-rightBrace">} </span><span class="oak-assign">:= </span><span class="oak-fnName">import</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'std'</span><span class="oak-rightParen">)</span>
<span class="oak-leftBrace">{</span><span class="oak-newline">
	</span><span class="oak-identifier">digit?</span><span class="oak-colon">: </span><span class="oak-identifier">digit?</span><span class="oak-newline">
	</span><span class="oak-identifier">word?</span><span class="oak-colon">: </span><span class="oak-identifier">word?</span><span class="oak-newline">
	</span><span class="oak-identifier">space?</span><span class="oak-colon">: </span><span class="oak-identifier">space?</span><span class="oak-newline">
	</span><span class="oak-identifier">cut</span><span class="oak-colon">: </span><span class="oak-identifier">cut</span><span class="oak-newline">
	</span><span class="oak-identifier">contains?</span><span class="oak-colon">: </span><span class="oak-identifier">strContains?</span><span class="oak-newline">
	</span><span class="oak-identifier">join</span><span class="oak-colon">: </span><span class="oak-identifier">join</span><span class="oak-newline">
	</span><span class="oak-identifier">replace</span><span class="oak-colon">: </span><span class="oak-identifier">replace</span><span class="oak-newline">
	</span><span class="oak-identifier">startsWith?</span><span class="oak-colon">: </span><span class="oak-identifier">startsWith?</span><span class="oak-newline">
	</span><span class="oak-identifier">trimStart</span><span class="oak-colon">: </span><span class="oak-identifier">trimStart</span><span class="oak-newline">
	</span><span class="oak-identifier">trimEnd</span><span class="oak-colon">: </span><span class="oak-identifier">trimEnd</span><span class="oak-newline">
	</span><span class="oak-identifier">trim</span><span class="oak-colon">: </span><span class="oak-identifier">trim</span>
<span class="oak-rightBrace">} </span><span class="oak-assign">:= </span><span class="oak-fnName">import</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'str'</span><span class="oak-rightParen">)</span>
<span class="oak-leftBrace">{</span><span class="oak-newline">
	</span><span class="oak-identifier">min</span><span class="oak-colon">: </span><span class="oak-identifier">min</span><span class="oak-newline">
	</span><span class="oak-identifier">max</span><span class="oak-colon">: </span><span class="oak-identifier">max</span>
<span class="oak-rightBrace">} </span><span class="oak-assign">:= </span><span class="oak-fnName">import</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'math'</span><span class="oak-rightParen">)</span>
<span class="oak-leftBrace">{</span><span class="oak-newline">
	</span><span class="oak-identifier">format</span><span class="oak-colon">: </span><span class="oak-identifier">format</span><span class="oak-newline">
	</span><span class="oak-identifier">printf</span><span class="oak-colon">: </span><span class="oak-identifier">printf</span>
<span class="oak-rightBrace">} </span><span class="oak-assign">:= </span><span class="oak-fnName">import</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'fmt'</span><span class="oak-rightParen">)</span>

<span class="oak-fnKeyword">fn </span><span class="oak-fnName">shebang?</span><span class="oak-leftParen">(</span><span class="oak-identifier">text</span><span class="oak-rightParen">) </span><span class="oak-identifier">text </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">startsWith?</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'#!'</span><span class="oak-rightParen">)</span>

<span class="oak-fnKeyword">fn </span><span class="oak-fnName">renderPos</span><span class="oak-leftParen">(</span><span class="oak-identifier">pos</span><span class="oak-rightParen">) </span><span class="oak-stringLiteral">'[' </span><span class="oak-plus">+ </span><span class="oak-fnName">string</span><span class="oak-leftParen">(</span><span class="oak-identifier">pos</span><span class="oak-dot">.</span><span class="oak-numberLiteral">1</span><span class="oak-rightParen">) </span><span class="oak-plus">+ </span><span class="oak-stringLiteral">':' </span><span class="oak-plus">+ </span><span class="oak-fnName">string</span><span class="oak-leftParen">(</span><span class="oak-identifier">pos</span><span class="oak-dot">.</span><span class="oak-numberLiteral">2</span><span class="oak-rightParen">) </span><span class="oak-plus">+ </span><span class="oak-stringLiteral">']'</span>

<span class="oak-fnKeyword">fn </span><span class="oak-fnName">renderToken</span><span class="oak-leftParen">(</span><span class="oak-identifier">token</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">token</span><span class="oak-dot">.</span><span class="oak-identifier">val </span><span class="oak-leftBrace">{</span><span class="oak-newline">
	</span><span class="oak-qmark">? </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">format</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'{{ 0 }} {{ 1 }}'</span><span class="oak-comma">, </span><span class="oak-fnName">string</span><span class="oak-leftParen">(</span><span class="oak-identifier">token</span><span class="oak-dot">.</span><span class="oak-identifier">type</span><span class="oak-rightParen">)</span><span class="oak-comma">, </span><span class="oak-fnName">renderPos</span><span class="oak-leftParen">(</span><span class="oak-identifier">token</span><span class="oak-dot">.</span><span class="oak-identifier">pos</span><span class="oak-rightParen">)</span><span class="oak-rightParen">)</span><span class="oak-newline">
	</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">format</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'{{ 0 }}({{ 1 }}) {{ 2 }}'</span><span class="oak-comma">, </span><span class="oak-fnName">string</span><span class="oak-leftParen">(</span><span class="oak-identifier">token</span><span class="oak-dot">.</span><span class="oak-identifier">type</span><span class="oak-rightParen">)</span><span class="oak-comma">, </span><span class="oak-identifier">token</span><span class="oak-dot">.</span><span class="oak-identifier">val</span><span class="oak-comma">, </span><span class="oak-fnName">renderPos</span><span class="oak-leftParen">(</span><span class="oak-identifier">token</span><span class="oak-dot">.</span><span class="oak-identifier">pos</span><span class="oak-rightParen">)</span><span class="oak-rightParen">)</span>
<span class="oak-rightBrace">}</span>

<span class="oak-comment">// Tokenizer is a full-fidelity, lossless tokenizer for Oak. It produces a</span>
<span class="oak-comment">// stream of valid Oak token types, plus any shebang, newlines, and comments it</span>
<span class="oak-comment">// finds. To produce an AST, those non-standard non-AST tokens should be</span>
<span class="oak-comment">// filtered out of the list first.</span>
<span class="oak-comment">//</span>
<span class="oak-comment">// Methods:</span>
<span class="oak-comment">//</span>
<span class="oak-comment">// fn tokenize()    returns a list of tokens</span>
<span class="oak-fnKeyword">fn </span><span class="oak-fnName">Tokenizer</span><span class="oak-leftParen">(</span><span class="oak-identifier">source</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
	</span><span class="oak-identifier">index </span><span class="oak-assign">:= </span><span class="oak-numberLiteral">0</span><span class="oak-newline">
	</span><span class="oak-identifier">line </span><span class="oak-assign">:= </span><span class="oak-numberLiteral">1</span><span class="oak-newline">
	</span><span class="oak-identifier">col </span><span class="oak-assign">:= </span><span class="oak-numberLiteral">1</span>
<span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">TokenAt</span><span class="oak-leftParen">(</span><span class="oak-identifier">type</span><span class="oak-comma">, </span><span class="oak-identifier">pos</span><span class="oak-comma">, </span><span class="oak-identifier">val</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-identifier">type</span><span class="oak-colon">: </span><span class="oak-identifier">type</span><span class="oak-newline">
		</span><span class="oak-identifier">val</span><span class="oak-colon">: </span><span class="oak-identifier">val</span><span class="oak-newline">
		</span><span class="oak-identifier">pos</span><span class="oak-colon">: </span><span class="oak-identifier">pos</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span>
<span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">Token</span><span class="oak-leftParen">(</span><span class="oak-identifier">type</span><span class="oak-comma">, </span><span class="oak-identifier">val</span><span class="oak-rightParen">) </span><span class="oak-fnName">TokenAt</span><span class="oak-leftParen">(</span><span class="oak-identifier">type</span><span class="oak-comma">, </span><span class="oak-leftBracket">[</span><span class="oak-identifier">index</span><span class="oak-comma">, </span><span class="oak-identifier">line</span><span class="oak-comma">, </span><span class="oak-identifier">col</span><span class="oak-rightBracket">]</span><span class="oak-comma">, </span><span class="oak-identifier">val</span><span class="oak-rightParen">)</span>
<span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">eof? </span><span class="oak-identifier">index </span><span class="oak-eq">= </span><span class="oak-fnName">len</span><span class="oak-leftParen">(</span><span class="oak-identifier">source</span><span class="oak-rightParen">)</span><span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">peek </span><span class="oak-identifier">source</span><span class="oak-dot">.</span><span class="oak-leftParen">(</span><span class="oak-identifier">index</span><span class="oak-rightParen">)</span><span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">peekAhead</span><span class="oak-leftParen">(</span><span class="oak-identifier">n</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">index </span><span class="oak-plus">+ </span><span class="oak-identifier">n </span><span class="oak-geq">>= </span><span class="oak-fnName">len</span><span class="oak-leftParen">(</span><span class="oak-identifier">source</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-trueLiteral">true </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">' '</span><span class="oak-newline">
		</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">source</span><span class="oak-dot">.</span><span class="oak-leftParen">(</span><span class="oak-identifier">index </span><span class="oak-plus">+ </span><span class="oak-identifier">n</span><span class="oak-rightParen">)</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">next </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-identifier">char </span><span class="oak-assign">:= </span><span class="oak-identifier">source</span><span class="oak-dot">.</span><span class="oak-leftParen">(</span><span class="oak-identifier">index</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-ifKeyword">if </span><span class="oak-identifier">index </span><span class="oak-less">&lt; </span><span class="oak-fnName">len</span><span class="oak-leftParen">(</span><span class="oak-identifier">source</span><span class="oak-rightParen">) </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">index </span><span class="oak-nonlocalAssign">&lt;- </span><span class="oak-identifier">index </span><span class="oak-plus">+ </span><span class="oak-numberLiteral">1</span><span class="oak-newline">
		</span><span class="oak-ifKeyword">if </span><span class="oak-identifier">char </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-stringLiteral">'\n' </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-identifier">line </span><span class="oak-nonlocalAssign">&lt;- </span><span class="oak-identifier">line </span><span class="oak-plus">+ </span><span class="oak-numberLiteral">1</span><span class="oak-newline">
				</span><span class="oak-identifier">col </span><span class="oak-nonlocalAssign">&lt;- </span><span class="oak-numberLiteral">1</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span><span class="oak-newline">
			</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">col </span><span class="oak-nonlocalAssign">&lt;- </span><span class="oak-identifier">col </span><span class="oak-plus">+ </span><span class="oak-numberLiteral">1</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span><span class="oak-newline">
		</span><span class="oak-identifier">char</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">back </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-ifKeyword">if </span><span class="oak-identifier">index </span><span class="oak-greater">> </span><span class="oak-numberLiteral">0 </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">index </span><span class="oak-nonlocalAssign">&lt;- </span><span class="oak-identifier">index </span><span class="oak-minus">- </span><span class="oak-numberLiteral">1</span><span class="oak-newline">
		</span><span class="oak-ifKeyword">if </span><span class="oak-identifier">source</span><span class="oak-dot">.</span><span class="oak-leftParen">(</span><span class="oak-identifier">index</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-comment">// TODO: reset col correctly on backtrack</span><span class="oak-newline">
			</span><span class="oak-stringLiteral">'\n' </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">line </span><span class="oak-nonlocalAssign">&lt;- </span><span class="oak-identifier">line </span><span class="oak-minus">- </span><span class="oak-numberLiteral">1</span><span class="oak-newline">
			</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">col </span><span class="oak-nonlocalAssign">&lt;- </span><span class="oak-identifier">col </span><span class="oak-minus">- </span><span class="oak-numberLiteral">1</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span>
<span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">readUntilChar</span><span class="oak-leftParen">(</span><span class="oak-identifier">c</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">acc</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-exclam">!</span><span class="oak-fnName">eof?</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-and">&amp; </span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-neq">!= </span><span class="oak-identifier">c </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-trueLiteral">true </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">acc </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">acc</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span><span class="oak-newline">
		</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">''</span><span class="oak-rightParen">)</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">readValidIdentifier </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">acc</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">eof?</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-trueLiteral">true </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">acc</span><span class="oak-newline">
			</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-identifier">c </span><span class="oak-assign">:= </span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
				</span><span class="oak-ifKeyword">if </span><span class="oak-fnName">word?</span><span class="oak-leftParen">(</span><span class="oak-identifier">c</span><span class="oak-rightParen">) </span><span class="oak-or">| </span><span class="oak-identifier">c </span><span class="oak-eq">= </span><span class="oak-stringLiteral">'_' </span><span class="oak-or">| </span><span class="oak-identifier">c </span><span class="oak-eq">= </span><span class="oak-stringLiteral">'?' </span><span class="oak-or">| </span><span class="oak-identifier">c </span><span class="oak-eq">= </span><span class="oak-stringLiteral">'!' </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-trueLiteral">true </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">acc </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">c</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
						</span><span class="oak-fnName">back</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
						</span><span class="oak-identifier">acc</span><span class="oak-newline">
					</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span><span class="oak-newline">
		</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">''</span><span class="oak-rightParen">)</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">readValidNumeral </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-identifier">sawDot? </span><span class="oak-assign">:= </span><span class="oak-falseLiteral">false</span><span class="oak-newline">
		</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">acc</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">eof?</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-trueLiteral">true </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">acc</span><span class="oak-newline">
			</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-identifier">c </span><span class="oak-assign">:= </span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
				</span><span class="oak-ifKeyword">if </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-fnName">digit?</span><span class="oak-leftParen">(</span><span class="oak-identifier">c</span><span class="oak-rightParen">) </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">acc </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">c</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-identifier">c </span><span class="oak-eq">= </span><span class="oak-stringLiteral">'.' </span><span class="oak-and">&amp; </span><span class="oak-exclam">!</span><span class="oak-identifier">sawDot? </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
						</span><span class="oak-identifier">sawDot? </span><span class="oak-nonlocalAssign">&lt;- </span><span class="oak-trueLiteral">true</span><span class="oak-newline">
						</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">acc </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">c</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-rightBrace">}</span><span class="oak-newline">
					</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
						</span><span class="oak-fnName">back</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
						</span><span class="oak-identifier">acc</span><span class="oak-newline">
					</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span><span class="oak-newline">
		</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">''</span><span class="oak-rightParen">)</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">nextToken </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-identifier">pos </span><span class="oak-assign">:= </span><span class="oak-leftBracket">[</span><span class="oak-identifier">index</span><span class="oak-comma">, </span><span class="oak-identifier">line</span><span class="oak-comma">, </span><span class="oak-identifier">col</span><span class="oak-rightBracket">]</span><span class="oak-newline">
		</span><span class="oak-ifKeyword">if </span><span class="oak-identifier">c </span><span class="oak-assign">:= </span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-stringLiteral">',' </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">TokenAt</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">comma</span><span class="oak-comma">, </span><span class="oak-identifier">pos</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-stringLiteral">'.' </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-eq">= </span><span class="oak-stringLiteral">'.' </span><span class="oak-and">&amp; </span><span class="oak-fnName">peekAhead</span><span class="oak-leftParen">(</span><span class="oak-numberLiteral">1</span><span class="oak-rightParen">) </span><span class="oak-eq">= </span><span class="oak-stringLiteral">'.' </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-trueLiteral">true </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-fnName">TokenAt</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">ellipsis</span><span class="oak-comma">, </span><span class="oak-identifier">pos</span><span class="oak-rightParen">)</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">TokenAt</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">dot</span><span class="oak-comma">, </span><span class="oak-identifier">pos</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span><span class="oak-newline">
			</span><span class="oak-stringLiteral">'(' </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">TokenAt</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">leftParen</span><span class="oak-comma">, </span><span class="oak-identifier">pos</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-stringLiteral">')' </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">TokenAt</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">rightParen</span><span class="oak-comma">, </span><span class="oak-identifier">pos</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-stringLiteral">'[' </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">TokenAt</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">leftBracket</span><span class="oak-comma">, </span><span class="oak-identifier">pos</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-stringLiteral">']' </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">TokenAt</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">rightBracket</span><span class="oak-comma">, </span><span class="oak-identifier">pos</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-stringLiteral">'{' </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">TokenAt</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">leftBrace</span><span class="oak-comma">, </span><span class="oak-identifier">pos</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-stringLiteral">'}' </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">TokenAt</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">rightBrace</span><span class="oak-comma">, </span><span class="oak-identifier">pos</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-stringLiteral">':' </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-stringLiteral">'=' </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-fnName">TokenAt</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">assign</span><span class="oak-comma">, </span><span class="oak-identifier">pos</span><span class="oak-rightParen">)</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">TokenAt</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">colon</span><span class="oak-comma">, </span><span class="oak-identifier">pos</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span><span class="oak-newline">
			</span><span class="oak-stringLiteral">'&lt;' </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-stringLiteral">'&lt;' </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-fnName">TokenAt</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">pushArrow</span><span class="oak-comma">, </span><span class="oak-identifier">pos</span><span class="oak-rightParen">)</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-stringLiteral">'-' </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-fnName">TokenAt</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">nonlocalAssign</span><span class="oak-comma">, </span><span class="oak-identifier">pos</span><span class="oak-rightParen">)</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-stringLiteral">'=' </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-fnName">TokenAt</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">leq</span><span class="oak-comma">, </span><span class="oak-identifier">pos</span><span class="oak-rightParen">)</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">TokenAt</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">less</span><span class="oak-comma">, </span><span class="oak-identifier">pos</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span><span class="oak-newline">
			</span><span class="oak-stringLiteral">'?' </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">TokenAt</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">qmark</span><span class="oak-comma">, </span><span class="oak-identifier">pos</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-stringLiteral">'!' </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-stringLiteral">'=' </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-fnName">TokenAt</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">neq</span><span class="oak-comma">, </span><span class="oak-identifier">pos</span><span class="oak-rightParen">)</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">TokenAt</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">exclam</span><span class="oak-comma">, </span><span class="oak-identifier">pos</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span><span class="oak-newline">
			</span><span class="oak-stringLiteral">'+' </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">TokenAt</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">plus</span><span class="oak-comma">, </span><span class="oak-identifier">pos</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-stringLiteral">'-' </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-stringLiteral">'>' </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-fnName">TokenAt</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">branchArrow</span><span class="oak-comma">, </span><span class="oak-identifier">pos</span><span class="oak-rightParen">)</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">TokenAt</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">minus</span><span class="oak-comma">, </span><span class="oak-identifier">pos</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span><span class="oak-newline">
			</span><span class="oak-stringLiteral">'*' </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">TokenAt</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">times</span><span class="oak-comma">, </span><span class="oak-identifier">pos</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-stringLiteral">'/' </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-stringLiteral">'/' </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-comment">// line comment</span><span class="oak-newline">
					</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-identifier">commentString </span><span class="oak-assign">:= </span><span class="oak-fnName">readUntilChar</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'\n'</span><span class="oak-rightParen">) </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">trimEnd</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-ifKeyword">if </span><span class="oak-identifier">commentString </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">trim</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-eq">= </span><span class="oak-stringLiteral">'' </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">commentString </span><span class="oak-nonlocalAssign">&lt;- </span><span class="oak-stringLiteral">''</span><span class="oak-newline">
					</span><span class="oak-fnName">TokenAt</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">comment</span><span class="oak-comma">, </span><span class="oak-identifier">pos</span><span class="oak-comma">, </span><span class="oak-identifier">commentString</span><span class="oak-rightParen">)</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">TokenAt</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">divide</span><span class="oak-comma">, </span><span class="oak-identifier">pos</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span><span class="oak-newline">
			</span><span class="oak-stringLiteral">'%' </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">TokenAt</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">modulus</span><span class="oak-comma">, </span><span class="oak-identifier">pos</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-stringLiteral">'^' </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">TokenAt</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">xor</span><span class="oak-comma">, </span><span class="oak-identifier">pos</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-stringLiteral">'&amp;' </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">TokenAt</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">and</span><span class="oak-comma">, </span><span class="oak-identifier">pos</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-stringLiteral">'|' </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-stringLiteral">'>' </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-fnName">TokenAt</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">pipeArrow</span><span class="oak-comma">, </span><span class="oak-identifier">pos</span><span class="oak-rightParen">)</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">TokenAt</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">or</span><span class="oak-comma">, </span><span class="oak-identifier">pos</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span><span class="oak-newline">
			</span><span class="oak-stringLiteral">'>' </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-stringLiteral">'=' </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-fnName">TokenAt</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">geq</span><span class="oak-comma">, </span><span class="oak-identifier">pos</span><span class="oak-rightParen">)</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">TokenAt</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">greater</span><span class="oak-comma">, </span><span class="oak-identifier">pos</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span><span class="oak-newline">
			</span><span class="oak-stringLiteral">'=' </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">TokenAt</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">eq</span><span class="oak-comma">, </span><span class="oak-identifier">pos</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-stringLiteral">'\'' </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">payload</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">charInString </span><span class="oak-assign">:= </span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-qmark">?</span><span class="oak-comma">, </span><span class="oak-stringLiteral">'\'' </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">payload</span><span class="oak-newline">
					</span><span class="oak-stringLiteral">'\\' </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">c </span><span class="oak-assign">:= </span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
						</span><span class="oak-qmark">? </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">payload</span><span class="oak-newline">
						</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">payload </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-stringLiteral">'\\' </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">c</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-rightBrace">}</span><span class="oak-newline">
					</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">payload </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">charInString</span><span class="oak-rightParen">)</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-fnName">TokenAt</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">stringLiteral</span><span class="oak-comma">, </span><span class="oak-identifier">pos</span><span class="oak-comma">, </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">''</span><span class="oak-rightParen">)</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span><span class="oak-newline">
			</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-fnName">digit?</span><span class="oak-leftParen">(</span><span class="oak-identifier">c</span><span class="oak-rightParen">) </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">TokenAt</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">numberLiteral</span><span class="oak-comma">, </span><span class="oak-identifier">pos</span><span class="oak-comma">, </span><span class="oak-identifier">c </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-fnName">readValidNumeral</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">)</span><span class="oak-newline">
				</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">payload </span><span class="oak-assign">:= </span><span class="oak-identifier">c </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-fnName">readValidIdentifier</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-stringLiteral">'_' </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">TokenAt</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">underscore</span><span class="oak-comma">, </span><span class="oak-identifier">pos</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-stringLiteral">'if' </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">TokenAt</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">ifKeyword</span><span class="oak-comma">, </span><span class="oak-identifier">pos</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-stringLiteral">'fn' </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">TokenAt</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">fnKeyword</span><span class="oak-comma">, </span><span class="oak-identifier">pos</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-stringLiteral">'with' </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">TokenAt</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">withKeyword</span><span class="oak-comma">, </span><span class="oak-identifier">pos</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-stringLiteral">'true' </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">TokenAt</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">trueLiteral</span><span class="oak-comma">, </span><span class="oak-identifier">pos</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-stringLiteral">'false' </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">TokenAt</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">falseLiteral</span><span class="oak-comma">, </span><span class="oak-identifier">pos</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">TokenAt</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">identifier</span><span class="oak-comma">, </span><span class="oak-identifier">pos</span><span class="oak-comma">, </span><span class="oak-identifier">payload</span><span class="oak-rightParen">)</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">tokenize </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-identifier">tokens </span><span class="oak-assign">:= </span><span class="oak-leftBracket">[</span><span class="oak-rightBracket">]</span>
<span class="oak-newline">
		</span><span class="oak-comment">// the tokenizer itself completely ignores shebang lines, as it is not</span><span class="oak-newline">
		</span><span class="oak-comment">// a language concern -- it is the responsibility of the caller to</span><span class="oak-newline">
		</span><span class="oak-comment">// process or ignore shebang lines as necessary</span><span class="oak-newline">
		</span><span class="oak-ifKeyword">if </span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-eq">= </span><span class="oak-stringLiteral">'#' </span><span class="oak-and">&amp; </span><span class="oak-fnName">peekAhead</span><span class="oak-leftParen">(</span><span class="oak-numberLiteral">1</span><span class="oak-rightParen">) </span><span class="oak-eq">= </span><span class="oak-stringLiteral">'!' </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-fnName">readUntilChar</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'\n'</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-ifKeyword">if </span><span class="oak-exclam">!</span><span class="oak-fnName">eof?</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span>
<span class="oak-newline">
		</span><span class="oak-comment">// snip whitespace before</span><span class="oak-newline">
		</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">eatSpace </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">space?</span><span class="oak-leftParen">(</span><span class="oak-identifier">sp </span><span class="oak-assign">:= </span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-ifKeyword">if </span><span class="oak-identifier">sp </span><span class="oak-eq">= </span><span class="oak-stringLiteral">'\n' </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">tokens </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-fnName">Token</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">newline</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-fnName">eatSpace</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span><span class="oak-newline">
		</span><span class="oak-fnName">eatSpace</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span>
<span class="oak-newline">
		</span><span class="oak-identifier">lastTok </span><span class="oak-assign">:= </span><span class="oak-fnName">Token</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">comma</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">sub </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-identifier">nextTok </span><span class="oak-assign">:= </span><span class="oak-fnName">nextToken</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span>
<span class="oak-newline">
			</span><span class="oak-ifKeyword">if </span><span class="oak-exclam">!</span><span class="oak-leftParen">(</span><span class="oak-newline">
				</span><span class="oak-leftBracket">[</span><span class="oak-colon">:</span><span class="oak-identifier">leftParen</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">leftBracket</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">leftBrace</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">comma</span><span class="oak-rightBracket">] </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">contains?</span><span class="oak-leftParen">(</span><span class="oak-identifier">lastTok</span><span class="oak-dot">.</span><span class="oak-identifier">type</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-rightParen">) </span><span class="oak-and">&amp; </span><span class="oak-leftBracket">[</span><span class="oak-colon">:</span><span class="oak-identifier">rightParen</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">rightBracket</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">rightBrace</span><span class="oak-rightBracket">] </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">contains?</span><span class="oak-leftParen">(</span><span class="oak-identifier">nextTok</span><span class="oak-dot">.</span><span class="oak-identifier">type</span><span class="oak-rightParen">) </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">tokens </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-fnName">TokenAt</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">comma</span><span class="oak-comma">, </span><span class="oak-identifier">nextTok</span><span class="oak-dot">.</span><span class="oak-identifier">pos</span><span class="oak-rightParen">)</span>
<span class="oak-newline">
			</span><span class="oak-identifier">tokens </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">nextTok</span><span class="oak-newline">
			</span><span class="oak-ifKeyword">if </span><span class="oak-identifier">nextTok</span><span class="oak-dot">.</span><span class="oak-identifier">type </span><span class="oak-eq">= </span><span class="oak-colon">:</span><span class="oak-identifier">comment </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">nextTok </span><span class="oak-assign">:= </span><span class="oak-identifier">lastTok</span>
<span class="oak-newline">
			</span><span class="oak-comment">// snip whitespace after</span><span class="oak-newline">
			</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">eatSpaceAutoInsertComma </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">space?</span><span class="oak-leftParen">(</span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-ifKeyword">if </span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-stringLiteral">'\n' </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
						</span><span class="oak-ifKeyword">if </span><span class="oak-identifier">nextTok</span><span class="oak-dot">.</span><span class="oak-identifier">type </span><span class="oak-leftBrace">{</span><span class="oak-newline">
							</span><span class="oak-colon">:</span><span class="oak-identifier">comma</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">leftParen</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">leftBracket</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">leftBrace</span><span class="oak-newline">
							</span><span class="oak-colon">:</span><span class="oak-identifier">plus</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">minus</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">times</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">divide</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">modulus</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">xor</span><span class="oak-newline">
							</span><span class="oak-colon">:</span><span class="oak-identifier">and</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">or</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">exclam</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">greater</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">less</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">eq</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">geq</span><span class="oak-newline">
							</span><span class="oak-colon">:</span><span class="oak-identifier">leq</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">assign</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">nonlocalAssign</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">dot</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">colon</span><span class="oak-newline">
							</span><span class="oak-colon">:</span><span class="oak-identifier">fnKeyword</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">ifKeyword</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">withKeyword</span><span class="oak-newline">
							</span><span class="oak-colon">:</span><span class="oak-identifier">pipeArrow</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">branchArrow</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">pushArrow </span><span class="oak-branchArrow">-> </span><span class="oak-qmark">?</span><span class="oak-newline">
							</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
								</span><span class="oak-identifier">nextTok </span><span class="oak-nonlocalAssign">&lt;- </span><span class="oak-fnName">Token</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">comma</span><span class="oak-rightParen">)</span><span class="oak-newline">
								</span><span class="oak-identifier">tokens </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">nextTok</span><span class="oak-newline">
							</span><span class="oak-rightBrace">}</span><span class="oak-newline">
						</span><span class="oak-rightBrace">}</span><span class="oak-newline">
						</span><span class="oak-identifier">tokens </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-fnName">Token</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">newline</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
				</span><span class="oak-fnName">eatSpaceAutoInsertComma</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span><span class="oak-newline">
			</span><span class="oak-fnName">eatSpaceAutoInsertComma</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span>
<span class="oak-newline">
			</span><span class="oak-ifKeyword">if </span><span class="oak-identifier">nextTok</span><span class="oak-dot">.</span><span class="oak-identifier">type </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-colon">:</span><span class="oak-identifier">comment </span><span class="oak-branchArrow">-> </span><span class="oak-qmark">?</span><span class="oak-newline">
				</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">lastTok </span><span class="oak-nonlocalAssign">&lt;- </span><span class="oak-identifier">nextTok</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span>
<span class="oak-newline">
			</span><span class="oak-ifKeyword">if </span><span class="oak-exclam">!</span><span class="oak-fnName">eof?</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span>
<span class="oak-newline">
		</span><span class="oak-comment">// do not start tokenizing into empty file</span><span class="oak-newline">
		</span><span class="oak-ifKeyword">if </span><span class="oak-exclam">!</span><span class="oak-fnName">eof?</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span>
<span class="oak-newline">
		</span><span class="oak-ifKeyword">if </span><span class="oak-identifier">lastTok</span><span class="oak-dot">.</span><span class="oak-identifier">type </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-colon">:</span><span class="oak-identifier">comma </span><span class="oak-branchArrow">-> </span><span class="oak-qmark">?</span><span class="oak-newline">
			</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">tokens </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-fnName">TokenAt</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">comma</span><span class="oak-comma">, </span><span class="oak-leftBracket">[</span><span class="oak-newline">
				</span><span class="oak-fnName">len</span><span class="oak-leftParen">(</span><span class="oak-identifier">source</span><span class="oak-rightParen">)</span><span class="oak-newline">
				</span><span class="oak-identifier">line</span><span class="oak-newline">
				</span><span class="oak-identifier">col</span><span class="oak-newline">
			</span><span class="oak-rightBracket">]</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span>
<span class="oak-newline">
		</span><span class="oak-identifier">tokens</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span>
<span class="oak-newline">
	</span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-comment">// undocumented API for libsyntax.print</span><span class="oak-newline">
		</span><span class="oak-identifier">readUntilChar</span><span class="oak-colon">: </span><span class="oak-identifier">readUntilChar</span><span class="oak-newline">
		</span><span class="oak-identifier">tokenize</span><span class="oak-colon">: </span><span class="oak-identifier">tokenize</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span>
<span class="oak-rightBrace">}</span>

<span class="oak-comment">// tokenize takes Oak source text and returns a list of tokens</span>
<span class="oak-fnKeyword">fn </span><span class="oak-fnName">tokenize</span><span class="oak-leftParen">(</span><span class="oak-identifier">text</span><span class="oak-rightParen">) </span><span class="oak-fnName">Tokenizer</span><span class="oak-leftParen">(</span><span class="oak-identifier">text</span><span class="oak-rightParen">)</span><span class="oak-dot">.</span><span class="oak-fnName">tokenize</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span>

<span class="oak-comment">// Parser takes a raw token stream, potentially including newlines and</span>
<span class="oak-comment">// comments, and generates a list of clean Oak AST nodes.</span>
<span class="oak-comment">//</span>
<span class="oak-comment">// Methods:</span>
<span class="oak-comment">//</span>
<span class="oak-comment">// fn parse()   returns a list of AST nodes</span>
<span class="oak-fnKeyword">fn </span><span class="oak-fnName">Parser</span><span class="oak-leftParen">(</span><span class="oak-identifier">tokens</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
	</span><span class="oak-identifier">index </span><span class="oak-assign">:= </span><span class="oak-numberLiteral">0</span><span class="oak-newline">
	</span><span class="oak-identifier">minBinaryPrec </span><span class="oak-assign">:= </span><span class="oak-leftBracket">[</span><span class="oak-numberLiteral">0</span><span class="oak-rightBracket">]</span>
<span class="oak-newline">
	</span><span class="oak-comment">// for parsing purposes, we must ignore non-semantic tokens</span><span class="oak-newline">
	</span><span class="oak-identifier">tokens </span><span class="oak-assign">:= </span><span class="oak-identifier">tokens </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">filter</span><span class="oak-leftParen">(</span><span class="oak-fnKeyword">fn</span><span class="oak-leftParen">(</span><span class="oak-identifier">tok</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">tok</span><span class="oak-dot">.</span><span class="oak-identifier">type </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">newline</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">comment </span><span class="oak-branchArrow">-> </span><span class="oak-falseLiteral">false</span><span class="oak-newline">
		</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-trueLiteral">true</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span><span class="oak-rightParen">)</span>
<span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">error</span><span class="oak-leftParen">(</span><span class="oak-identifier">msg</span><span class="oak-comma">, </span><span class="oak-identifier">pos</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-identifier">type</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">error</span><span class="oak-newline">
		</span><span class="oak-identifier">error</span><span class="oak-colon">: </span><span class="oak-identifier">msg</span><span class="oak-newline">
		</span><span class="oak-identifier">pos</span><span class="oak-colon">: </span><span class="oak-identifier">pos</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span>
<span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">lastMinPrec </span><span class="oak-identifier">minBinaryPrec</span><span class="oak-dot">.</span><span class="oak-leftParen">(</span><span class="oak-fnName">len</span><span class="oak-leftParen">(</span><span class="oak-identifier">minBinaryPrec</span><span class="oak-rightParen">) </span><span class="oak-minus">- </span><span class="oak-numberLiteral">1</span><span class="oak-rightParen">)</span><span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">pushMinPrec</span><span class="oak-leftParen">(</span><span class="oak-identifier">prec</span><span class="oak-rightParen">) </span><span class="oak-identifier">minBinaryPrec </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">prec</span><span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">popMinPrec </span><span class="oak-identifier">minBinaryPrec </span><span class="oak-nonlocalAssign">&lt;- </span><span class="oak-fnName">slice</span><span class="oak-leftParen">(</span><span class="oak-identifier">minBinaryPrec</span><span class="oak-comma">, </span><span class="oak-numberLiteral">0</span><span class="oak-comma">, </span><span class="oak-fnName">len</span><span class="oak-leftParen">(</span><span class="oak-identifier">minBinaryPrec</span><span class="oak-rightParen">) </span><span class="oak-minus">- </span><span class="oak-numberLiteral">1</span><span class="oak-rightParen">)</span><span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">eof? </span><span class="oak-identifier">index </span><span class="oak-eq">= </span><span class="oak-fnName">len</span><span class="oak-leftParen">(</span><span class="oak-identifier">tokens</span><span class="oak-rightParen">)</span><span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">peek </span><span class="oak-identifier">tokens</span><span class="oak-dot">.</span><span class="oak-leftParen">(</span><span class="oak-identifier">index</span><span class="oak-rightParen">)</span><span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">peekAhead</span><span class="oak-leftParen">(</span><span class="oak-identifier">n</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">index </span><span class="oak-plus">+ </span><span class="oak-identifier">n </span><span class="oak-greater">> </span><span class="oak-fnName">len</span><span class="oak-leftParen">(</span><span class="oak-identifier">tokens</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-trueLiteral">true </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{ </span><span class="oak-identifier">type</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">comma </span><span class="oak-rightBrace">}</span><span class="oak-newline">
		</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">tokens</span><span class="oak-dot">.</span><span class="oak-leftParen">(</span><span class="oak-identifier">index </span><span class="oak-plus">+ </span><span class="oak-identifier">n</span><span class="oak-rightParen">)</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">next </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-identifier">tok </span><span class="oak-assign">:= </span><span class="oak-identifier">tokens</span><span class="oak-dot">.</span><span class="oak-leftParen">(</span><span class="oak-identifier">index</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-ifKeyword">if </span><span class="oak-identifier">index </span><span class="oak-less">&lt; </span><span class="oak-fnName">len</span><span class="oak-leftParen">(</span><span class="oak-identifier">tokens</span><span class="oak-rightParen">) </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">index </span><span class="oak-nonlocalAssign">&lt;- </span><span class="oak-identifier">index </span><span class="oak-plus">+ </span><span class="oak-numberLiteral">1</span><span class="oak-newline">
		</span><span class="oak-identifier">tok</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">back </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">index </span><span class="oak-greater">> </span><span class="oak-numberLiteral">0 </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">index </span><span class="oak-nonlocalAssign">&lt;- </span><span class="oak-identifier">index </span><span class="oak-minus">- </span><span class="oak-numberLiteral">1</span><span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">lastTokenPos </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">lastTok </span><span class="oak-assign">:= </span><span class="oak-fnName">last</span><span class="oak-leftParen">(</span><span class="oak-identifier">tokens</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-qmark">? </span><span class="oak-branchArrow">-> </span><span class="oak-qmark">?</span><span class="oak-newline">
		</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">lastTok</span><span class="oak-dot">.</span><span class="oak-identifier">pos</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">expect</span><span class="oak-leftParen">(</span><span class="oak-identifier">type</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">eof?</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-trueLiteral">true </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">error</span><span class="oak-leftParen">(</span><span class="oak-fnName">format</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'Unexpected end of input, expected {{0}}'</span><span class="oak-comma">, </span><span class="oak-identifier">type</span><span class="oak-rightParen">)</span><span class="oak-comma">, </span><span class="oak-fnName">lastTokenPos</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-identifier">nextTok </span><span class="oak-assign">:= </span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-ifKeyword">if </span><span class="oak-identifier">nextTok</span><span class="oak-dot">.</span><span class="oak-identifier">type </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-identifier">type </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">nextTok</span><span class="oak-newline">
				</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">error</span><span class="oak-leftParen">(</span><span class="oak-fnName">format</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'Unexpected token {{0}}, expected {{1}}'</span><span class="oak-comma">, </span><span class="oak-fnName">renderToken</span><span class="oak-leftParen">(</span><span class="oak-identifier">nextTok</span><span class="oak-rightParen">)</span><span class="oak-comma">, </span><span class="oak-identifier">type</span><span class="oak-rightParen">)</span><span class="oak-comma">, </span><span class="oak-identifier">nextTok</span><span class="oak-dot">.</span><span class="oak-identifier">pos</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">readUntilTokenType</span><span class="oak-leftParen">(</span><span class="oak-identifier">type</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-identifier">tokens </span><span class="oak-assign">:= </span><span class="oak-leftBracket">[</span><span class="oak-rightBracket">]</span><span class="oak-newline">
		</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">sub </span><span class="oak-ifKeyword">if </span><span class="oak-exclam">!</span><span class="oak-fnName">eof</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-and">&amp; </span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-dot">.</span><span class="oak-identifier">type </span><span class="oak-neq">!= </span><span class="oak-identifier">type </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-trueLiteral">true </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-identifier">tokens </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
				</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span><span class="oak-newline">
			</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">tokens</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span><span class="oak-newline">
		</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span>
<span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-identifier">x</span><span class="oak-comma">, </span><span class="oak-identifier">withNotErr</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">x </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-leftBrace">{ </span><span class="oak-identifier">type</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">error</span><span class="oak-comma">, </span><span class="oak-identifier">error</span><span class="oak-colon">: </span><span class="oak-underscore">_</span><span class="oak-comma">, </span><span class="oak-identifier">pos</span><span class="oak-colon">: </span><span class="oak-underscore">_ </span><span class="oak-rightBrace">} </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">x</span><span class="oak-newline">
		</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">withNotErr</span><span class="oak-leftParen">(</span><span class="oak-identifier">x</span><span class="oak-rightParen">)</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span>
<span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">parseAssignment</span><span class="oak-leftParen">(</span><span class="oak-identifier">left</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-dot">.</span><span class="oak-identifier">type </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">assign</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">nonlocalAssign </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-identifier">nxt </span><span class="oak-assign">:= </span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-identifier">node </span><span class="oak-assign">:= </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-identifier">type</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">assignment</span><span class="oak-newline">
				</span><span class="oak-identifier">tok</span><span class="oak-colon">: </span><span class="oak-identifier">nxt</span><span class="oak-newline">
				</span><span class="oak-identifier">local?</span><span class="oak-colon">: </span><span class="oak-identifier">nxt</span><span class="oak-dot">.</span><span class="oak-identifier">type </span><span class="oak-eq">= </span><span class="oak-colon">:</span><span class="oak-identifier">assign</span><span class="oak-newline">
				</span><span class="oak-identifier">left</span><span class="oak-colon">: </span><span class="oak-identifier">left</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span>
<span class="oak-newline">
			</span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-identifier">right </span><span class="oak-assign">:= </span><span class="oak-fnName">parseNode</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-identifier">node</span><span class="oak-dot">.</span><span class="oak-identifier">right </span><span class="oak-assign">:= </span><span class="oak-identifier">right</span><span class="oak-newline">
				</span><span class="oak-identifier">node</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span><span class="oak-newline">
		</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">left</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span>
<span class="oak-newline">
	</span><span class="oak-comment">// parseUnit is responsible for parsing the smallest complete syntactic</span><span class="oak-newline">
	</span><span class="oak-comment">// "units" of Oak's syntax, like literals including function literals,</span><span class="oak-newline">
	</span><span class="oak-comment">// grouped expressions in blocks, and if/with expressions.</span><span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">parseUnit </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">eof?</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-trueLiteral">true </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">error</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'Unexpected end of input'</span><span class="oak-comma">, </span><span class="oak-fnName">lastTokenPos</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-identifier">tok </span><span class="oak-assign">:= </span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-ifKeyword">if </span><span class="oak-identifier">tok</span><span class="oak-dot">.</span><span class="oak-identifier">type </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-colon">:</span><span class="oak-identifier">qmark </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{ </span><span class="oak-identifier">type</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">null</span><span class="oak-comma">, </span><span class="oak-identifier">tok</span><span class="oak-colon">: </span><span class="oak-identifier">tok </span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-colon">:</span><span class="oak-identifier">stringLiteral </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-identifier">type</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">string</span><span class="oak-newline">
					</span><span class="oak-identifier">tok</span><span class="oak-colon">: </span><span class="oak-identifier">tok</span><span class="oak-newline">
					</span><span class="oak-identifier">val</span><span class="oak-colon">: </span><span class="oak-leftBrace">{</span><span class="oak-newline">
						</span><span class="oak-identifier">verbatim </span><span class="oak-assign">:= </span><span class="oak-identifier">tok</span><span class="oak-dot">.</span><span class="oak-identifier">val</span><span class="oak-newline">
						</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">parsed</span><span class="oak-comma">, </span><span class="oak-identifier">i</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">c </span><span class="oak-assign">:= </span><span class="oak-identifier">verbatim</span><span class="oak-dot">.</span><span class="oak-leftParen">(</span><span class="oak-identifier">i</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
							</span><span class="oak-qmark">? </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">parsed</span><span class="oak-newline">
							</span><span class="oak-stringLiteral">'\\' </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">escapedChar </span><span class="oak-assign">:= </span><span class="oak-identifier">verbatim</span><span class="oak-dot">.</span><span class="oak-leftParen">(</span><span class="oak-identifier">i </span><span class="oak-plus">+ </span><span class="oak-numberLiteral">1</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
								</span><span class="oak-stringLiteral">'t' </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">parsed </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-stringLiteral">'\t'</span><span class="oak-comma">, </span><span class="oak-identifier">i </span><span class="oak-plus">+ </span><span class="oak-numberLiteral">2</span><span class="oak-rightParen">)</span><span class="oak-newline">
								</span><span class="oak-stringLiteral">'n' </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">parsed </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-stringLiteral">'\n'</span><span class="oak-comma">, </span><span class="oak-identifier">i </span><span class="oak-plus">+ </span><span class="oak-numberLiteral">2</span><span class="oak-rightParen">)</span><span class="oak-newline">
								</span><span class="oak-stringLiteral">'r' </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">parsed </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-stringLiteral">'\r'</span><span class="oak-comma">, </span><span class="oak-identifier">i </span><span class="oak-plus">+ </span><span class="oak-numberLiteral">2</span><span class="oak-rightParen">)</span><span class="oak-newline">
								</span><span class="oak-stringLiteral">'f' </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">parsed </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-stringLiteral">'\f'</span><span class="oak-comma">, </span><span class="oak-identifier">i </span><span class="oak-plus">+ </span><span class="oak-numberLiteral">2</span><span class="oak-rightParen">)</span><span class="oak-newline">
								</span><span class="oak-stringLiteral">'x' </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">c1 </span><span class="oak-assign">:= </span><span class="oak-identifier">verbatim</span><span class="oak-dot">.</span><span class="oak-leftParen">(</span><span class="oak-identifier">i </span><span class="oak-plus">+ </span><span class="oak-numberLiteral">2</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
									</span><span class="oak-qmark">? </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">parsed </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">escapedChar</span><span class="oak-comma">, </span><span class="oak-identifier">i </span><span class="oak-plus">+ </span><span class="oak-numberLiteral">2</span><span class="oak-rightParen">)</span><span class="oak-newline">
									</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">c2 </span><span class="oak-assign">:= </span><span class="oak-identifier">verbatim</span><span class="oak-dot">.</span><span class="oak-leftParen">(</span><span class="oak-identifier">i </span><span class="oak-plus">+ </span><span class="oak-numberLiteral">3</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
										</span><span class="oak-qmark">? </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">parsed </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">escapedChar </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">c1</span><span class="oak-comma">, </span><span class="oak-identifier">i </span><span class="oak-plus">+ </span><span class="oak-numberLiteral">3</span><span class="oak-rightParen">)</span><span class="oak-newline">
										</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">code </span><span class="oak-assign">:= </span><span class="oak-fnName">fromHex</span><span class="oak-leftParen">(</span><span class="oak-identifier">c1 </span><span class="oak-plus">+ </span><span class="oak-identifier">c2</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
											</span><span class="oak-qmark">? </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">parsed </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">escapedChar </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">c1 </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">c2</span><span class="oak-comma">, </span><span class="oak-identifier">i </span><span class="oak-plus">+ </span><span class="oak-numberLiteral">4</span><span class="oak-rightParen">)</span><span class="oak-newline">
											</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">parsed </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-fnName">char</span><span class="oak-leftParen">(</span><span class="oak-identifier">code</span><span class="oak-rightParen">)</span><span class="oak-comma">, </span><span class="oak-identifier">i </span><span class="oak-plus">+ </span><span class="oak-numberLiteral">4</span><span class="oak-rightParen">)</span><span class="oak-newline">
										</span><span class="oak-rightBrace">}</span><span class="oak-newline">
									</span><span class="oak-rightBrace">}</span><span class="oak-newline">
								</span><span class="oak-rightBrace">}</span><span class="oak-newline">
								</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">parsed </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">escapedChar</span><span class="oak-comma">, </span><span class="oak-identifier">i </span><span class="oak-plus">+ </span><span class="oak-numberLiteral">2</span><span class="oak-rightParen">)</span><span class="oak-newline">
							</span><span class="oak-rightBrace">}</span><span class="oak-newline">
							</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">parsed </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">c</span><span class="oak-comma">, </span><span class="oak-identifier">i </span><span class="oak-plus">+ </span><span class="oak-numberLiteral">1</span><span class="oak-rightParen">)</span><span class="oak-newline">
						</span><span class="oak-rightBrace">}</span><span class="oak-newline">
						</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">''</span><span class="oak-comma">, </span><span class="oak-numberLiteral">0</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-colon">:</span><span class="oak-identifier">numberLiteral </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">tok</span><span class="oak-dot">.</span><span class="oak-identifier">val </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">strContains?</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'.'</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-trueLiteral">true </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">parsed </span><span class="oak-assign">:= </span><span class="oak-fnName">float</span><span class="oak-leftParen">(</span><span class="oak-identifier">tok</span><span class="oak-dot">.</span><span class="oak-identifier">val</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
						</span><span class="oak-qmark">? </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">error</span><span class="oak-leftParen">(</span><span class="oak-fnName">format</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'Could not parse floating point number {{0}}'</span><span class="oak-comma">, </span><span class="oak-identifier">tok</span><span class="oak-dot">.</span><span class="oak-identifier">val</span><span class="oak-rightParen">)</span><span class="oak-comma">, </span><span class="oak-identifier">tok</span><span class="oak-dot">.</span><span class="oak-identifier">pos</span><span class="oak-rightParen">)</span><span class="oak-newline">
						</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
							</span><span class="oak-identifier">type</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">float</span><span class="oak-newline">
							</span><span class="oak-identifier">tok</span><span class="oak-colon">: </span><span class="oak-identifier">tok</span><span class="oak-newline">
							</span><span class="oak-identifier">val</span><span class="oak-colon">: </span><span class="oak-identifier">parsed</span><span class="oak-newline">
						</span><span class="oak-rightBrace">}</span><span class="oak-newline">
					</span><span class="oak-rightBrace">}</span><span class="oak-newline">
					</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">parsed </span><span class="oak-assign">:= </span><span class="oak-fnName">int</span><span class="oak-leftParen">(</span><span class="oak-identifier">tok</span><span class="oak-dot">.</span><span class="oak-identifier">val</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
						</span><span class="oak-qmark">? </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">error</span><span class="oak-leftParen">(</span><span class="oak-fnName">format</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'Could not parse integer number {{0}}'</span><span class="oak-comma">, </span><span class="oak-identifier">tok</span><span class="oak-dot">.</span><span class="oak-identifier">val</span><span class="oak-rightParen">)</span><span class="oak-comma">, </span><span class="oak-identifier">tok</span><span class="oak-dot">.</span><span class="oak-identifier">pos</span><span class="oak-rightParen">)</span><span class="oak-newline">
						</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
							</span><span class="oak-identifier">type</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">int</span><span class="oak-newline">
							</span><span class="oak-identifier">tok</span><span class="oak-colon">: </span><span class="oak-identifier">tok</span><span class="oak-newline">
							</span><span class="oak-identifier">val</span><span class="oak-colon">: </span><span class="oak-identifier">parsed</span><span class="oak-newline">
						</span><span class="oak-rightBrace">}</span><span class="oak-newline">
					</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-colon">:</span><span class="oak-identifier">trueLiteral </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-identifier">type</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">bool</span><span class="oak-newline">
					</span><span class="oak-identifier">tok</span><span class="oak-colon">: </span><span class="oak-identifier">tok</span><span class="oak-newline">
					</span><span class="oak-identifier">val</span><span class="oak-colon">: </span><span class="oak-trueLiteral">true</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-colon">:</span><span class="oak-identifier">falseLiteral </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-identifier">type</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">bool</span><span class="oak-newline">
					</span><span class="oak-identifier">tok</span><span class="oak-colon">: </span><span class="oak-identifier">tok</span><span class="oak-newline">
					</span><span class="oak-identifier">val</span><span class="oak-colon">: </span><span class="oak-falseLiteral">false</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-colon">:</span><span class="oak-identifier">colon </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-dot">.</span><span class="oak-identifier">type </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-colon">:</span><span class="oak-identifier">identifier </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
						</span><span class="oak-identifier">type</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">atom</span><span class="oak-newline">
						</span><span class="oak-identifier">tok</span><span class="oak-colon">: </span><span class="oak-identifier">tok</span><span class="oak-newline">
						</span><span class="oak-identifier">val</span><span class="oak-colon">: </span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-dot">.</span><span class="oak-identifier">val</span><span class="oak-newline">
					</span><span class="oak-rightBrace">}</span><span class="oak-newline">
					</span><span class="oak-colon">:</span><span class="oak-identifier">ifKeyword </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
						</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
						</span><span class="oak-leftBrace">{ </span><span class="oak-identifier">type</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">atom</span><span class="oak-comma">, </span><span class="oak-identifier">tok</span><span class="oak-colon">: </span><span class="oak-identifier">tok</span><span class="oak-comma">, </span><span class="oak-identifier">val</span><span class="oak-colon">: </span><span class="oak-stringLiteral">'if' </span><span class="oak-rightBrace">}</span><span class="oak-newline">
					</span><span class="oak-rightBrace">}</span><span class="oak-newline">
					</span><span class="oak-colon">:</span><span class="oak-identifier">fnKeyword </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
						</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
						</span><span class="oak-leftBrace">{ </span><span class="oak-identifier">type</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">atom</span><span class="oak-comma">, </span><span class="oak-identifier">tok</span><span class="oak-colon">: </span><span class="oak-identifier">tok</span><span class="oak-comma">, </span><span class="oak-identifier">val</span><span class="oak-colon">: </span><span class="oak-stringLiteral">'fn' </span><span class="oak-rightBrace">}</span><span class="oak-newline">
					</span><span class="oak-rightBrace">}</span><span class="oak-newline">
					</span><span class="oak-colon">:</span><span class="oak-identifier">withKeyword </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
						</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
						</span><span class="oak-leftBrace">{ </span><span class="oak-identifier">type</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">atom</span><span class="oak-comma">, </span><span class="oak-identifier">tok</span><span class="oak-colon">: </span><span class="oak-identifier">tok</span><span class="oak-comma">, </span><span class="oak-identifier">val</span><span class="oak-colon">: </span><span class="oak-stringLiteral">'with' </span><span class="oak-rightBrace">}</span><span class="oak-newline">
					</span><span class="oak-rightBrace">}</span><span class="oak-newline">
					</span><span class="oak-colon">:</span><span class="oak-identifier">trueLiteral </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
						</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
						</span><span class="oak-leftBrace">{ </span><span class="oak-identifier">type</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">atom</span><span class="oak-comma">, </span><span class="oak-identifier">tok</span><span class="oak-colon">: </span><span class="oak-identifier">tok</span><span class="oak-comma">, </span><span class="oak-identifier">val</span><span class="oak-colon">: </span><span class="oak-stringLiteral">'true' </span><span class="oak-rightBrace">}</span><span class="oak-newline">
					</span><span class="oak-rightBrace">}</span><span class="oak-newline">
					</span><span class="oak-colon">:</span><span class="oak-identifier">falseLiteral </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
						</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
						</span><span class="oak-leftBrace">{ </span><span class="oak-identifier">type</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">atom</span><span class="oak-comma">, </span><span class="oak-identifier">tok</span><span class="oak-colon">: </span><span class="oak-identifier">tok</span><span class="oak-comma">, </span><span class="oak-identifier">val</span><span class="oak-colon">: </span><span class="oak-stringLiteral">'false' </span><span class="oak-rightBrace">}</span><span class="oak-newline">
					</span><span class="oak-rightBrace">}</span><span class="oak-newline">
					</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">error</span><span class="oak-leftParen">(</span><span class="oak-fnName">format</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'Expected identifier after ":", got {{0}}'</span><span class="oak-comma">, </span><span class="oak-fnName">renderToken</span><span class="oak-leftParen">(</span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">)</span><span class="oak-rightParen">)</span><span class="oak-comma">, </span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-dot">.</span><span class="oak-identifier">pos</span><span class="oak-rightParen">)</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-colon">:</span><span class="oak-identifier">leftBracket </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-fnName">pushMinPrec</span><span class="oak-leftParen">(</span><span class="oak-numberLiteral">0</span><span class="oak-rightParen">)</span>
<span class="oak-newline">
					</span><span class="oak-identifier">itemNodes </span><span class="oak-assign">:= </span><span class="oak-leftBracket">[</span><span class="oak-rightBracket">]</span><span class="oak-newline">
					</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">sub </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">eof?</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
						</span><span class="oak-trueLiteral">true </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">error</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'Unexpected end of input inside list'</span><span class="oak-comma">, </span><span class="oak-fnName">lastTokenPos</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">)</span><span class="oak-newline">
						</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-dot">.</span><span class="oak-identifier">type </span><span class="oak-leftBrace">{</span><span class="oak-newline">
							</span><span class="oak-colon">:</span><span class="oak-identifier">rightBracket </span><span class="oak-branchArrow">-> </span><span class="oak-qmark">?</span><span class="oak-newline">
							</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-identifier">node </span><span class="oak-assign">:= </span><span class="oak-fnName">parseNode</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
								</span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-identifier">err </span><span class="oak-assign">:= </span><span class="oak-fnName">expect</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">comma</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
									</span><span class="oak-identifier">itemNodes </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">node</span><span class="oak-newline">
									</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
								</span><span class="oak-rightBrace">}</span><span class="oak-newline">
							</span><span class="oak-rightBrace">}</span><span class="oak-newline">
						</span><span class="oak-rightBrace">}</span><span class="oak-newline">
					</span><span class="oak-rightBrace">}</span><span class="oak-newline">
					</span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
						</span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-identifier">err </span><span class="oak-assign">:= </span><span class="oak-fnName">expect</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">rightBracket</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
							</span><span class="oak-fnName">popMinPrec</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span>
<span class="oak-newline">
							</span><span class="oak-leftBrace">{</span><span class="oak-newline">
								</span><span class="oak-identifier">type</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">list</span><span class="oak-newline">
								</span><span class="oak-identifier">tok</span><span class="oak-colon">: </span><span class="oak-identifier">tok</span><span class="oak-newline">
								</span><span class="oak-identifier">elems</span><span class="oak-colon">: </span><span class="oak-identifier">itemNodes</span><span class="oak-newline">
							</span><span class="oak-rightBrace">}</span><span class="oak-newline">
						</span><span class="oak-rightBrace">}</span><span class="oak-newline">
					</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-colon">:</span><span class="oak-identifier">leftBrace </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-fnName">pushMinPrec</span><span class="oak-leftParen">(</span><span class="oak-numberLiteral">0</span><span class="oak-rightParen">)</span>
<span class="oak-newline">
					</span><span class="oak-comment">// empty {} is always considered an object -- an empty block is illegal</span><span class="oak-newline">
					</span><span class="oak-ifKeyword">if </span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-dot">.</span><span class="oak-identifier">type </span><span class="oak-leftBrace">{</span><span class="oak-newline">
						</span><span class="oak-colon">:</span><span class="oak-identifier">rightBrace </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
							</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-comment">// eat the rightBrace</span><span class="oak-newline">
							</span><span class="oak-fnName">popMinPrec</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span>
<span class="oak-newline">
							</span><span class="oak-leftBrace">{</span><span class="oak-newline">
								</span><span class="oak-identifier">type</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">object</span><span class="oak-newline">
								</span><span class="oak-identifier">tok</span><span class="oak-colon">: </span><span class="oak-identifier">tok</span><span class="oak-newline">
								</span><span class="oak-identifier">entries</span><span class="oak-colon">: </span><span class="oak-leftBracket">[</span><span class="oak-rightBracket">]</span><span class="oak-newline">
							</span><span class="oak-rightBrace">}</span><span class="oak-newline">
						</span><span class="oak-rightBrace">}</span><span class="oak-newline">
						</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-identifier">firstExpr </span><span class="oak-assign">:= </span><span class="oak-fnName">parseNode</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">eof?</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
							</span><span class="oak-trueLiteral">true </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">error</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'Unexpected end of input inside block or object'</span><span class="oak-comma">, </span><span class="oak-fnName">lastTokenPos</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">)</span><span class="oak-newline">
							</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-dot">.</span><span class="oak-identifier">type </span><span class="oak-leftBrace">{</span><span class="oak-newline">
								</span><span class="oak-colon">:</span><span class="oak-identifier">colon </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
									</span><span class="oak-comment">// it's an object</span><span class="oak-newline">
									</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-comment">// eat the colon</span><span class="oak-newline">
									</span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-identifier">valExpr </span><span class="oak-assign">:= </span><span class="oak-fnName">parseNode</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
										</span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-fnName">expect</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">comma</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
											</span><span class="oak-identifier">entries </span><span class="oak-assign">:= </span><span class="oak-leftBracket">[</span><span class="oak-leftBrace">{ </span><span class="oak-identifier">key</span><span class="oak-colon">: </span><span class="oak-identifier">firstExpr</span><span class="oak-comma">, </span><span class="oak-identifier">val</span><span class="oak-colon">: </span><span class="oak-identifier">valExpr </span><span class="oak-rightBrace">}</span><span class="oak-rightBracket">]</span>
<span class="oak-newline">
											</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">sub </span><span class="oak-ifKeyword">if </span><span class="oak-exclam">!</span><span class="oak-fnName">eof?</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-dot">.</span><span class="oak-identifier">type </span><span class="oak-leftBrace">{</span><span class="oak-newline">
												</span><span class="oak-colon">:</span><span class="oak-identifier">rightBrace </span><span class="oak-branchArrow">-> </span><span class="oak-qmark">?</span><span class="oak-newline">
												</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-identifier">key </span><span class="oak-assign">:= </span><span class="oak-fnName">parseNode</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
													</span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-fnName">expect</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">colon</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
														</span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-identifier">val </span><span class="oak-assign">:= </span><span class="oak-fnName">parseNode</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
															</span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-fnName">expect</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">comma</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
																</span><span class="oak-identifier">entries </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-leftBrace">{ </span><span class="oak-identifier">key</span><span class="oak-colon">: </span><span class="oak-identifier">key</span><span class="oak-comma">, </span><span class="oak-identifier">val</span><span class="oak-colon">: </span><span class="oak-identifier">val </span><span class="oak-rightBrace">}</span><span class="oak-newline">
																</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
															</span><span class="oak-rightBrace">}</span><span class="oak-newline">
														</span><span class="oak-rightBrace">}</span><span class="oak-newline">
													</span><span class="oak-rightBrace">}</span><span class="oak-newline">
												</span><span class="oak-rightBrace">}</span><span class="oak-newline">
											</span><span class="oak-rightBrace">}</span><span class="oak-newline">
											</span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
												</span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-fnName">expect</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">rightBrace</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
													</span><span class="oak-fnName">popMinPrec</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span>
<span class="oak-newline">
													</span><span class="oak-leftBrace">{</span><span class="oak-newline">
														</span><span class="oak-identifier">type</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">object</span><span class="oak-newline">
														</span><span class="oak-identifier">tok</span><span class="oak-colon">: </span><span class="oak-identifier">tok</span><span class="oak-newline">
														</span><span class="oak-identifier">entries</span><span class="oak-colon">: </span><span class="oak-identifier">entries</span><span class="oak-newline">
													</span><span class="oak-rightBrace">}</span><span class="oak-newline">
												</span><span class="oak-rightBrace">}</span><span class="oak-newline">
											</span><span class="oak-rightBrace">}</span><span class="oak-newline">
										</span><span class="oak-rightBrace">}</span><span class="oak-newline">
									</span><span class="oak-rightBrace">}</span><span class="oak-newline">
								</span><span class="oak-rightBrace">}</span><span class="oak-newline">
								</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-fnName">expect</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">comma</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
									</span><span class="oak-comment">// it's a block</span><span class="oak-newline">
									</span><span class="oak-identifier">exprs </span><span class="oak-assign">:= </span><span class="oak-leftBracket">[</span><span class="oak-identifier">firstExpr</span><span class="oak-rightBracket">]</span>
<span class="oak-newline">
									</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">sub </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">eof?</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
										</span><span class="oak-trueLiteral">true </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">error</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'Unexpected end of input inside block or object'</span><span class="oak-comma">, </span><span class="oak-fnName">lastTokenPos</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">)</span><span class="oak-newline">
										</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-dot">.</span><span class="oak-identifier">type </span><span class="oak-leftBrace">{</span><span class="oak-newline">
											</span><span class="oak-colon">:</span><span class="oak-identifier">rightBrace </span><span class="oak-branchArrow">-> </span><span class="oak-qmark">?</span><span class="oak-newline">
											</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-identifier">expr </span><span class="oak-assign">:= </span><span class="oak-fnName">parseNode</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
												</span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-fnName">expect</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">comma</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
													</span><span class="oak-identifier">exprs </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">expr</span><span class="oak-newline">
													</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
												</span><span class="oak-rightBrace">}</span><span class="oak-newline">
											</span><span class="oak-rightBrace">}</span><span class="oak-newline">
										</span><span class="oak-rightBrace">}</span><span class="oak-newline">
									</span><span class="oak-rightBrace">}</span><span class="oak-newline">
									</span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
										</span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-fnName">expect</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">rightBrace</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
											</span><span class="oak-fnName">popMinPrec</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span>
<span class="oak-newline">
											</span><span class="oak-leftBrace">{</span><span class="oak-newline">
												</span><span class="oak-identifier">type</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">block</span><span class="oak-newline">
												</span><span class="oak-identifier">tok</span><span class="oak-colon">: </span><span class="oak-identifier">tok</span><span class="oak-newline">
												</span><span class="oak-identifier">exprs</span><span class="oak-colon">: </span><span class="oak-identifier">exprs</span><span class="oak-newline">
											</span><span class="oak-rightBrace">}</span><span class="oak-newline">
										</span><span class="oak-rightBrace">}</span><span class="oak-newline">
									</span><span class="oak-rightBrace">}</span><span class="oak-newline">
								</span><span class="oak-rightBrace">}</span><span class="oak-newline">
							</span><span class="oak-rightBrace">}</span><span class="oak-newline">
						</span><span class="oak-rightBrace">}</span><span class="oak-newline">
					</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-colon">:</span><span class="oak-identifier">fnKeyword </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-fnName">pushMinPrec</span><span class="oak-leftParen">(</span><span class="oak-numberLiteral">0</span><span class="oak-rightParen">)</span>
<span class="oak-newline">
					</span><span class="oak-identifier">name </span><span class="oak-assign">:= </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-dot">.</span><span class="oak-identifier">type </span><span class="oak-leftBrace">{</span><span class="oak-newline">
						</span><span class="oak-comment">// optional named fn</span><span class="oak-newline">
						</span><span class="oak-colon">:</span><span class="oak-identifier">identifier </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-dot">.</span><span class="oak-identifier">val</span><span class="oak-newline">
						</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">''</span><span class="oak-newline">
					</span><span class="oak-rightBrace">}</span>
<span class="oak-newline">
					</span><span class="oak-identifier">args </span><span class="oak-assign">:= </span><span class="oak-leftBracket">[</span><span class="oak-rightBracket">]</span><span class="oak-newline">
					</span><span class="oak-identifier">restArg </span><span class="oak-assign">:= </span><span class="oak-stringLiteral">''</span>
<span class="oak-newline">
					</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">parseBody </span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-identifier">body </span><span class="oak-assign">:= </span><span class="oak-fnName">parseNode</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
						</span><span class="oak-comment">// Exception to the "{} is empty object" rule is that `fn</span><span class="oak-newline">
						</span><span class="oak-comment">// {}` parses as a function with an empty block as a body.</span><span class="oak-newline">
						</span><span class="oak-ifKeyword">if </span><span class="oak-identifier">body </span><span class="oak-leftBrace">{</span><span class="oak-newline">
							</span><span class="oak-leftBrace">{ </span><span class="oak-identifier">type</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">object</span><span class="oak-comma">, </span><span class="oak-identifier">tok</span><span class="oak-colon">: </span><span class="oak-underscore">_</span><span class="oak-comma">, </span><span class="oak-identifier">entries</span><span class="oak-colon">: </span><span class="oak-leftBracket">[</span><span class="oak-rightBracket">] </span><span class="oak-rightBrace">} </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">body </span><span class="oak-nonlocalAssign">&lt;- </span><span class="oak-leftBrace">{</span><span class="oak-newline">
								</span><span class="oak-identifier">type</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">block</span><span class="oak-newline">
								</span><span class="oak-identifier">tok</span><span class="oak-colon">: </span><span class="oak-identifier">body</span><span class="oak-dot">.</span><span class="oak-identifier">tok</span><span class="oak-newline">
								</span><span class="oak-identifier">exprs</span><span class="oak-colon">: </span><span class="oak-leftBracket">[</span><span class="oak-rightBracket">]</span><span class="oak-newline">
							</span><span class="oak-rightBrace">}</span><span class="oak-newline">
						</span><span class="oak-rightBrace">}</span><span class="oak-newline">
						</span><span class="oak-fnName">popMinPrec</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span>
<span class="oak-newline">
						</span><span class="oak-leftBrace">{</span><span class="oak-newline">
							</span><span class="oak-identifier">type</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">function</span><span class="oak-newline">
							</span><span class="oak-identifier">name</span><span class="oak-colon">: </span><span class="oak-identifier">name</span><span class="oak-newline">
							</span><span class="oak-identifier">tok</span><span class="oak-colon">: </span><span class="oak-identifier">tok</span><span class="oak-newline">
							</span><span class="oak-identifier">args</span><span class="oak-colon">: </span><span class="oak-identifier">args</span><span class="oak-newline">
							</span><span class="oak-identifier">restArg</span><span class="oak-colon">: </span><span class="oak-identifier">restArg</span><span class="oak-newline">
							</span><span class="oak-identifier">body</span><span class="oak-colon">: </span><span class="oak-identifier">body</span><span class="oak-newline">
						</span><span class="oak-rightBrace">}</span><span class="oak-newline">
					</span><span class="oak-rightBrace">}</span>
<span class="oak-newline">
					</span><span class="oak-ifKeyword">if </span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-dot">.</span><span class="oak-identifier">type </span><span class="oak-leftBrace">{</span><span class="oak-newline">
						</span><span class="oak-colon">:</span><span class="oak-identifier">leftParen </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
							</span><span class="oak-comment">// optional argument list</span><span class="oak-newline">
							</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-comment">// eat the leftParen</span>
<span class="oak-newline">
							</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">sub </span><span class="oak-ifKeyword">if </span><span class="oak-exclam">!</span><span class="oak-fnName">eof?</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-dot">.</span><span class="oak-identifier">type </span><span class="oak-leftBrace">{</span><span class="oak-newline">
								</span><span class="oak-colon">:</span><span class="oak-identifier">rightParen </span><span class="oak-branchArrow">-> </span><span class="oak-qmark">?</span><span class="oak-newline">
								</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
									</span><span class="oak-identifier">arg </span><span class="oak-assign">:= </span><span class="oak-fnName">expect</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">identifier</span><span class="oak-rightParen">)</span><span class="oak-newline">
									</span><span class="oak-ifKeyword">if </span><span class="oak-identifier">arg</span><span class="oak-dot">.</span><span class="oak-identifier">type </span><span class="oak-leftBrace">{</span><span class="oak-newline">
										</span><span class="oak-colon">:</span><span class="oak-identifier">error </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
											</span><span class="oak-fnName">back</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-comment">// try again</span>
<span class="oak-newline">
											</span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-fnName">expect</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">underscore</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
												</span><span class="oak-identifier">args </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-stringLiteral">'_'</span><span class="oak-newline">
												</span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-fnName">expect</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">comma</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
													</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
												</span><span class="oak-rightBrace">}</span><span class="oak-newline">
											</span><span class="oak-rightBrace">}</span><span class="oak-newline">
										</span><span class="oak-rightBrace">}</span><span class="oak-newline">
										</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-dot">.</span><span class="oak-identifier">type </span><span class="oak-leftBrace">{</span><span class="oak-newline">
											</span><span class="oak-colon">:</span><span class="oak-identifier">ellipsis </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
												</span><span class="oak-identifier">restArg </span><span class="oak-nonlocalAssign">&lt;- </span><span class="oak-identifier">arg</span><span class="oak-dot">.</span><span class="oak-identifier">val</span><span class="oak-newline">
												</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-comment">// eat the ellipsis</span><span class="oak-newline">
												</span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-fnName">expect</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">comma</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
													</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
												</span><span class="oak-rightBrace">}</span><span class="oak-newline">
											</span><span class="oak-rightBrace">}</span><span class="oak-newline">
											</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
												</span><span class="oak-identifier">args </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">arg</span><span class="oak-dot">.</span><span class="oak-identifier">val</span><span class="oak-newline">
												</span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-fnName">expect</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">comma</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
													</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
												</span><span class="oak-rightBrace">}</span><span class="oak-newline">
											</span><span class="oak-rightBrace">}</span><span class="oak-newline">
										</span><span class="oak-rightBrace">}</span><span class="oak-newline">
									</span><span class="oak-rightBrace">}</span><span class="oak-newline">
								</span><span class="oak-rightBrace">}</span><span class="oak-newline">
							</span><span class="oak-rightBrace">}</span><span class="oak-newline">
							</span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
								</span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-fnName">expect</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">rightParen</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
									</span><span class="oak-fnName">parseBody</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
								</span><span class="oak-rightBrace">}</span><span class="oak-newline">
							</span><span class="oak-rightBrace">}</span><span class="oak-newline">
						</span><span class="oak-rightBrace">}</span><span class="oak-newline">
						</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">parseBody</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-colon">:</span><span class="oak-identifier">underscore </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-identifier">type</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">empty</span><span class="oak-newline">
					</span><span class="oak-identifier">tok</span><span class="oak-colon">: </span><span class="oak-identifier">tok</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-colon">:</span><span class="oak-identifier">identifier </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-identifier">type</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">identifier</span><span class="oak-newline">
					</span><span class="oak-identifier">tok</span><span class="oak-colon">: </span><span class="oak-identifier">tok</span><span class="oak-newline">
					</span><span class="oak-identifier">val</span><span class="oak-colon">: </span><span class="oak-identifier">tok</span><span class="oak-dot">.</span><span class="oak-identifier">val</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-colon">:</span><span class="oak-identifier">minus</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">exclam </span><span class="oak-branchArrow">-> </span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-identifier">right </span><span class="oak-assign">:= </span><span class="oak-fnName">parseSubNode</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-identifier">type</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">unary</span><span class="oak-newline">
					</span><span class="oak-identifier">tok</span><span class="oak-colon">: </span><span class="oak-identifier">tok</span><span class="oak-newline">
					</span><span class="oak-identifier">op</span><span class="oak-colon">: </span><span class="oak-identifier">tok</span><span class="oak-dot">.</span><span class="oak-identifier">type</span><span class="oak-newline">
					</span><span class="oak-identifier">right</span><span class="oak-colon">: </span><span class="oak-identifier">right</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-colon">:</span><span class="oak-identifier">ifKeyword </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-comment">// We want to support multi-target branches, but don't want to</span><span class="oak-newline">
					</span><span class="oak-comment">// incur the performance overhead in the interpreter/evaluator</span><span class="oak-newline">
					</span><span class="oak-comment">// of keeping every single target as a Go slice, when the vast</span><span class="oak-newline">
					</span><span class="oak-comment">// majority of targets will be single-value, which requires</span><span class="oak-newline">
					</span><span class="oak-comment">// just a pointer to an astNode.</span><span class="oak-newline">
					</span><span class="oak-comment">//</span><span class="oak-newline">
					</span><span class="oak-comment">// So instead of doing that, we penalize the multi-value case</span><span class="oak-newline">
					</span><span class="oak-comment">// by essentially considering it syntax sugar and splitting</span><span class="oak-newline">
					</span><span class="oak-comment">// such branches into multiple AST branches, each with one</span><span class="oak-newline">
					</span><span class="oak-comment">// target value.</span><span class="oak-newline">
					</span><span class="oak-fnName">pushMinPrec</span><span class="oak-leftParen">(</span><span class="oak-numberLiteral">0</span><span class="oak-rightParen">)</span>
<span class="oak-newline">
					</span><span class="oak-comment">// if no explicit condition is provided (i.e. if the keyword is</span><span class="oak-newline">
					</span><span class="oak-comment">// followed by a { ... }), we assume the condition is "true" to</span><span class="oak-newline">
					</span><span class="oak-comment">// allow for the useful `if { case, case ... }` pattern.</span><span class="oak-newline">
					</span><span class="oak-identifier">condNode </span><span class="oak-assign">:= </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-dot">.</span><span class="oak-identifier">type </span><span class="oak-leftBrace">{</span><span class="oak-newline">
						</span><span class="oak-colon">:</span><span class="oak-identifier">leftBrace </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
							</span><span class="oak-identifier">type</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">bool</span><span class="oak-newline">
							</span><span class="oak-identifier">val</span><span class="oak-colon">: </span><span class="oak-trueLiteral">true</span><span class="oak-newline">
							</span><span class="oak-identifier">tok</span><span class="oak-colon">: </span><span class="oak-identifier">tok</span><span class="oak-newline">
						</span><span class="oak-rightBrace">}</span><span class="oak-newline">
						</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">parseNode</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-rightBrace">}</span>
<span class="oak-newline">
					</span><span class="oak-ifKeyword">if </span><span class="oak-fnName">eof?</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
						</span><span class="oak-trueLiteral">true </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">error</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'Unexpected end of input in if expression'</span><span class="oak-comma">, </span><span class="oak-fnName">lastTokenPos</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">)</span><span class="oak-newline">
						</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-dot">.</span><span class="oak-identifier">type </span><span class="oak-leftBrace">{</span><span class="oak-newline">
							</span><span class="oak-colon">:</span><span class="oak-identifier">branchArrow </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
								</span><span class="oak-identifier">arrowTok </span><span class="oak-assign">:= </span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
								</span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-identifier">body </span><span class="oak-assign">:= </span><span class="oak-fnName">parseNode</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
									</span><span class="oak-leftBrace">{</span><span class="oak-newline">
										</span><span class="oak-identifier">type</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">ifExpr</span><span class="oak-newline">
										</span><span class="oak-identifier">tok</span><span class="oak-colon">: </span><span class="oak-identifier">tok</span><span class="oak-newline">
										</span><span class="oak-identifier">cond</span><span class="oak-colon">: </span><span class="oak-identifier">condNode</span><span class="oak-newline">
										</span><span class="oak-identifier">branches</span><span class="oak-colon">: </span><span class="oak-leftBracket">[</span><span class="oak-leftBrace">{</span><span class="oak-newline">
											</span><span class="oak-identifier">type</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">ifBranch</span><span class="oak-newline">
											</span><span class="oak-identifier">target</span><span class="oak-colon">: </span><span class="oak-leftBrace">{</span><span class="oak-newline">
												</span><span class="oak-identifier">type</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">bool</span><span class="oak-newline">
												</span><span class="oak-identifier">val</span><span class="oak-colon">: </span><span class="oak-trueLiteral">true</span><span class="oak-newline">
												</span><span class="oak-identifier">tok</span><span class="oak-colon">: </span><span class="oak-identifier">arrowTok</span><span class="oak-newline">
											</span><span class="oak-rightBrace">}</span><span class="oak-newline">
											</span><span class="oak-identifier">body</span><span class="oak-colon">: </span><span class="oak-identifier">body</span><span class="oak-newline">
										</span><span class="oak-rightBrace">}</span><span class="oak-rightBracket">]</span><span class="oak-newline">
									</span><span class="oak-rightBrace">}</span><span class="oak-newline">
								</span><span class="oak-rightBrace">}</span><span class="oak-newline">
							</span><span class="oak-rightBrace">}</span><span class="oak-newline">
							</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-identifier">condNode</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
								</span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-fnName">expect</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">leftBrace</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
									</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">subBranch</span><span class="oak-leftParen">(</span><span class="oak-identifier">branches</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">eof?</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
										</span><span class="oak-falseLiteral">false </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-dot">.</span><span class="oak-identifier">type </span><span class="oak-leftBrace">{</span><span class="oak-newline">
											</span><span class="oak-colon">:</span><span class="oak-identifier">rightBrace </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">branches</span><span class="oak-newline">
											</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
												</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">subTarget</span><span class="oak-leftParen">(</span><span class="oak-identifier">targets</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">eof?</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
													</span><span class="oak-trueLiteral">true </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">targets</span><span class="oak-newline">
													</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-identifier">target </span><span class="oak-assign">:= </span><span class="oak-fnName">parseNode</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-dot">.</span><span class="oak-identifier">type </span><span class="oak-leftBrace">{</span><span class="oak-newline">
														</span><span class="oak-colon">:</span><span class="oak-identifier">branchArrow </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">targets </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">target</span><span class="oak-newline">
														</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-fnName">expect</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">comma</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
															</span><span class="oak-fnName">subTarget</span><span class="oak-leftParen">(</span><span class="oak-identifier">targets </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">target</span><span class="oak-rightParen">)</span><span class="oak-newline">
														</span><span class="oak-rightBrace">}</span><span class="oak-newline">
													</span><span class="oak-rightBrace">}</span><span class="oak-newline">
												</span><span class="oak-rightBrace">}</span><span class="oak-newline">
												</span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-identifier">targets </span><span class="oak-assign">:= </span><span class="oak-fnName">subTarget</span><span class="oak-leftParen">(</span><span class="oak-leftBracket">[</span><span class="oak-rightBracket">]</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
													</span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-fnName">expect</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">branchArrow</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
														</span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-identifier">body </span><span class="oak-assign">:= </span><span class="oak-fnName">parseNode</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
															</span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-fnName">expect</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">comma</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
																</span><span class="oak-fnName">subBranch</span><span class="oak-leftParen">(</span><span class="oak-identifier">branches </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">append</span><span class="oak-leftParen">(</span><span class="oak-identifier">targets </span><span class="oak-pipeArrow">|> </span><span class="oak-withKeyword">with </span><span class="oak-fnName">map</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn</span><span class="oak-leftParen">(</span><span class="oak-identifier">target</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
																	</span><span class="oak-identifier">type</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">ifBranch</span><span class="oak-newline">
																	</span><span class="oak-identifier">target</span><span class="oak-colon">: </span><span class="oak-identifier">target</span><span class="oak-newline">
																	</span><span class="oak-identifier">body</span><span class="oak-colon">: </span><span class="oak-identifier">body</span><span class="oak-newline">
																</span><span class="oak-rightBrace">}</span><span class="oak-rightParen">)</span><span class="oak-rightParen">)</span><span class="oak-newline">
															</span><span class="oak-rightBrace">}</span><span class="oak-newline">
														</span><span class="oak-rightBrace">}</span><span class="oak-newline">
													</span><span class="oak-rightBrace">}</span><span class="oak-newline">
												</span><span class="oak-rightBrace">}</span><span class="oak-newline">
											</span><span class="oak-rightBrace">}</span><span class="oak-newline">
										</span><span class="oak-rightBrace">}</span><span class="oak-newline">
										</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">branches</span><span class="oak-newline">
									</span><span class="oak-rightBrace">}</span><span class="oak-newline">
									</span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-identifier">branches </span><span class="oak-assign">:= </span><span class="oak-fnName">subBranch</span><span class="oak-leftParen">(</span><span class="oak-leftBracket">[</span><span class="oak-rightBracket">]</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
										</span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-fnName">expect</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">rightBrace</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
											</span><span class="oak-fnName">popMinPrec</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span>
<span class="oak-newline">
											</span><span class="oak-leftBrace">{</span><span class="oak-newline">
												</span><span class="oak-identifier">type</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">ifExpr</span><span class="oak-newline">
												</span><span class="oak-identifier">tok</span><span class="oak-colon">: </span><span class="oak-identifier">tok</span><span class="oak-newline">
												</span><span class="oak-identifier">cond</span><span class="oak-colon">: </span><span class="oak-identifier">condNode</span><span class="oak-newline">
												</span><span class="oak-identifier">branches</span><span class="oak-colon">: </span><span class="oak-identifier">branches</span><span class="oak-newline">
											</span><span class="oak-rightBrace">}</span><span class="oak-newline">
										</span><span class="oak-rightBrace">}</span><span class="oak-newline">
									</span><span class="oak-rightBrace">}</span><span class="oak-newline">
								</span><span class="oak-rightBrace">}</span><span class="oak-newline">
							</span><span class="oak-rightBrace">}</span><span class="oak-newline">
						</span><span class="oak-rightBrace">}</span><span class="oak-newline">
					</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-colon">:</span><span class="oak-identifier">withKeyword </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-fnName">pushMinPrec</span><span class="oak-leftParen">(</span><span class="oak-numberLiteral">0</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-identifier">base </span><span class="oak-assign">:= </span><span class="oak-fnName">parseNode</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">base</span><span class="oak-dot">.</span><span class="oak-identifier">type </span><span class="oak-leftBrace">{</span><span class="oak-newline">
						</span><span class="oak-colon">:</span><span class="oak-identifier">fnCall </span><span class="oak-branchArrow">-> </span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-identifier">lastArg </span><span class="oak-assign">:= </span><span class="oak-fnName">parseNode</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
							</span><span class="oak-fnName">popMinPrec</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
							</span><span class="oak-identifier">base</span><span class="oak-dot">.</span><span class="oak-identifier">args </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">lastArg</span><span class="oak-newline">
							</span><span class="oak-identifier">base</span><span class="oak-newline">
						</span><span class="oak-rightBrace">}</span><span class="oak-newline">
						</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">error</span><span class="oak-leftParen">(</span><span class="oak-fnName">format</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'with keyword should be followed by a fn call, found {{0}}'</span><span class="oak-comma">, </span><span class="oak-identifier">base</span><span class="oak-rightParen">)</span><span class="oak-comma">, </span><span class="oak-identifier">tok</span><span class="oak-dot">.</span><span class="oak-identifier">pos</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-colon">:</span><span class="oak-identifier">leftParen </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-fnName">pushMinPrec</span><span class="oak-leftParen">(</span><span class="oak-numberLiteral">0</span><span class="oak-rightParen">)</span>
<span class="oak-newline">
					</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">subExpr</span><span class="oak-leftParen">(</span><span class="oak-identifier">exprs</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">eof?</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
						</span><span class="oak-trueLiteral">true </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">error</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'Unexpected end of input inside block'</span><span class="oak-comma">, </span><span class="oak-fnName">lastTokenPos</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">)</span><span class="oak-newline">
						</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-dot">.</span><span class="oak-identifier">type </span><span class="oak-leftBrace">{</span><span class="oak-newline">
							</span><span class="oak-colon">:</span><span class="oak-identifier">rightParen </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">exprs</span><span class="oak-newline">
							</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-identifier">expr </span><span class="oak-assign">:= </span><span class="oak-fnName">parseNode</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
								</span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-fnName">expect</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">comma</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
									</span><span class="oak-fnName">subExpr</span><span class="oak-leftParen">(</span><span class="oak-identifier">exprs </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">expr</span><span class="oak-rightParen">)</span><span class="oak-newline">
								</span><span class="oak-rightBrace">}</span><span class="oak-newline">
							</span><span class="oak-rightBrace">}</span><span class="oak-newline">
						</span><span class="oak-rightBrace">}</span><span class="oak-newline">
					</span><span class="oak-rightBrace">}</span><span class="oak-newline">
					</span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-identifier">exprs </span><span class="oak-assign">:= </span><span class="oak-fnName">subExpr</span><span class="oak-leftParen">(</span><span class="oak-leftBracket">[</span><span class="oak-rightBracket">]</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
						</span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-fnName">expect</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">rightParen</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
							</span><span class="oak-fnName">popMinPrec</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
							</span><span class="oak-leftBrace">{</span><span class="oak-newline">
								</span><span class="oak-identifier">type</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">block</span><span class="oak-newline">
								</span><span class="oak-identifier">tok</span><span class="oak-colon">: </span><span class="oak-identifier">tok</span><span class="oak-newline">
								</span><span class="oak-identifier">exprs</span><span class="oak-colon">: </span><span class="oak-identifier">exprs</span><span class="oak-newline">
							</span><span class="oak-rightBrace">}</span><span class="oak-newline">
						</span><span class="oak-rightBrace">}</span><span class="oak-newline">
					</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">error</span><span class="oak-leftParen">(</span><span class="oak-fnName">format</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'Unexpected token {{0}} at start of unit'</span><span class="oak-comma">, </span><span class="oak-fnName">renderToken</span><span class="oak-leftParen">(</span><span class="oak-identifier">tok</span><span class="oak-rightParen">)</span><span class="oak-rightParen">)</span><span class="oak-comma">, </span><span class="oak-identifier">tok</span><span class="oak-dot">.</span><span class="oak-identifier">pos</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span>
<span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">infixOpPrecedence</span><span class="oak-leftParen">(</span><span class="oak-identifier">op</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">op </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">plus</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">minus </span><span class="oak-branchArrow">-> </span><span class="oak-numberLiteral">40</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">times</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">divide </span><span class="oak-branchArrow">-> </span><span class="oak-numberLiteral">50</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">modulus </span><span class="oak-branchArrow">-> </span><span class="oak-numberLiteral">80</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">eq</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">greater</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">less</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">geq</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">leq</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">neq </span><span class="oak-branchArrow">-> </span><span class="oak-numberLiteral">30</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">and </span><span class="oak-branchArrow">-> </span><span class="oak-numberLiteral">20</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">xor </span><span class="oak-branchArrow">-> </span><span class="oak-numberLiteral">15</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">or </span><span class="oak-branchArrow">-> </span><span class="oak-numberLiteral">10</span><span class="oak-newline">
		</span><span class="oak-comment">// assignment-like semantics</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">pushArrow </span><span class="oak-branchArrow">-> </span><span class="oak-numberLiteral">1</span><span class="oak-newline">
		</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-minus">-</span><span class="oak-numberLiteral">1</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span>
<span class="oak-newline">
	</span><span class="oak-comment">// parseSubNode is responsible for parsing independent "terms" in the Oak</span><span class="oak-newline">
	</span><span class="oak-comment">// syntax, like terms in unary and binary expressions and in pipelines. It</span><span class="oak-newline">
	</span><span class="oak-comment">// is in between parseUnit and parseNode.</span><span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">parseSubNode </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-fnName">pushMinPrec</span><span class="oak-leftParen">(</span><span class="oak-numberLiteral">0</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-identifier">node </span><span class="oak-assign">:= </span><span class="oak-fnName">parseUnit</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">sub </span><span class="oak-ifKeyword">if </span><span class="oak-exclam">!</span><span class="oak-fnName">eof?</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-dot">.</span><span class="oak-identifier">type </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-colon">:</span><span class="oak-identifier">dot </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-identifier">nxt </span><span class="oak-assign">:= </span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-comment">// eat the dot</span><span class="oak-newline">
					</span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-identifier">right </span><span class="oak-assign">:= </span><span class="oak-fnName">parseUnit</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
						</span><span class="oak-identifier">node </span><span class="oak-nonlocalAssign">&lt;- </span><span class="oak-leftBrace">{</span><span class="oak-newline">
							</span><span class="oak-identifier">type</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">propertyAccess</span><span class="oak-newline">
							</span><span class="oak-identifier">tok</span><span class="oak-colon">: </span><span class="oak-identifier">nxt</span><span class="oak-newline">
							</span><span class="oak-identifier">left</span><span class="oak-colon">: </span><span class="oak-identifier">node</span><span class="oak-newline">
							</span><span class="oak-identifier">right</span><span class="oak-colon">: </span><span class="oak-identifier">right</span><span class="oak-newline">
						</span><span class="oak-rightBrace">}</span><span class="oak-newline">
						</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-colon">:</span><span class="oak-identifier">leftParen </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-identifier">nxt </span><span class="oak-assign">:= </span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-comment">// eat the leftParen</span>
<span class="oak-newline">
					</span><span class="oak-identifier">args </span><span class="oak-assign">:= </span><span class="oak-leftBracket">[</span><span class="oak-rightBracket">]</span><span class="oak-newline">
					</span><span class="oak-identifier">restArg </span><span class="oak-assign">:= </span><span class="oak-qmark">?</span><span class="oak-newline">
					</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">subArg </span><span class="oak-ifKeyword">if </span><span class="oak-exclam">!</span><span class="oak-fnName">eof?</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-dot">.</span><span class="oak-identifier">type </span><span class="oak-leftBrace">{</span><span class="oak-newline">
						</span><span class="oak-colon">:</span><span class="oak-identifier">rightParen </span><span class="oak-branchArrow">-> </span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-fnName">expect</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">rightParen</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-rightBrace">}</span><span class="oak-newline">
						</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-identifier">arg </span><span class="oak-assign">:= </span><span class="oak-fnName">parseNode</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">eof?</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
							</span><span class="oak-trueLiteral">true </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">error</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'Unexpected end of input inside argument list'</span><span class="oak-comma">, </span><span class="oak-fnName">lastTokenPos</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">)</span><span class="oak-newline">
							</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-dot">.</span><span class="oak-identifier">type </span><span class="oak-leftBrace">{</span><span class="oak-newline">
								</span><span class="oak-colon">:</span><span class="oak-identifier">ellipsis </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
									</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-comment">// eat the ellipsis</span><span class="oak-newline">
									</span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-fnName">expect</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">comma</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
										</span><span class="oak-identifier">restArg </span><span class="oak-nonlocalAssign">&lt;- </span><span class="oak-identifier">arg</span><span class="oak-newline">
										</span><span class="oak-fnName">subArg</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
									</span><span class="oak-rightBrace">}</span><span class="oak-newline">
								</span><span class="oak-rightBrace">}</span><span class="oak-newline">
								</span><span class="oak-colon">:</span><span class="oak-identifier">comma </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
									</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-comment">// eat the comma</span><span class="oak-newline">
									</span><span class="oak-identifier">args </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">arg</span><span class="oak-newline">
									</span><span class="oak-fnName">subArg</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
								</span><span class="oak-rightBrace">}</span><span class="oak-newline">
								</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">error</span><span class="oak-leftParen">(</span><span class="oak-fnName">format</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'Expected comma after arg in argument list, got {{0}}'</span><span class="oak-comma">, </span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-dot">.</span><span class="oak-identifier">type</span><span class="oak-rightParen">)</span><span class="oak-comma">, </span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-dot">.</span><span class="oak-identifier">pos</span><span class="oak-rightParen">)</span><span class="oak-newline">
							</span><span class="oak-rightBrace">}</span><span class="oak-newline">
						</span><span class="oak-rightBrace">}</span><span class="oak-newline">
					</span><span class="oak-rightBrace">}</span><span class="oak-newline">
					</span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-fnName">subArg</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
						</span><span class="oak-identifier">node </span><span class="oak-nonlocalAssign">&lt;- </span><span class="oak-leftBrace">{</span><span class="oak-newline">
							</span><span class="oak-identifier">type</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">fnCall</span><span class="oak-newline">
							</span><span class="oak-identifier">function</span><span class="oak-colon">: </span><span class="oak-identifier">node</span><span class="oak-newline">
							</span><span class="oak-identifier">args</span><span class="oak-colon">: </span><span class="oak-identifier">args</span><span class="oak-newline">
							</span><span class="oak-identifier">restArg</span><span class="oak-colon">: </span><span class="oak-identifier">restArg</span><span class="oak-newline">
							</span><span class="oak-identifier">tok</span><span class="oak-colon">: </span><span class="oak-identifier">nxt</span><span class="oak-newline">
						</span><span class="oak-rightBrace">}</span><span class="oak-newline">
						</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span><span class="oak-newline">
			</span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-fnName">popMinPrec</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
				</span><span class="oak-identifier">node</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span>
<span class="oak-newline">
	</span><span class="oak-comment">// parseNode returns the next top-level astNode from the parser</span><span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">parseNode </span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-identifier">node </span><span class="oak-assign">:= </span><span class="oak-fnName">parseSubNode</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">sub </span><span class="oak-ifKeyword">if </span><span class="oak-exclam">!</span><span class="oak-fnName">eof?</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-dot">.</span><span class="oak-identifier">type </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-colon">:</span><span class="oak-identifier">comma </span><span class="oak-branchArrow">-> </span><span class="oak-qmark">?</span><span class="oak-newline">
			</span><span class="oak-comment">// whatever follows an assignment expr cannot bind to the</span><span class="oak-newline">
			</span><span class="oak-comment">// assignment expression itself by syntax rule, so we simply</span><span class="oak-newline">
			</span><span class="oak-comment">// return</span><span class="oak-newline">
			</span><span class="oak-colon">:</span><span class="oak-identifier">assign</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">nonlocalAssign </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">node </span><span class="oak-nonlocalAssign">&lt;- </span><span class="oak-fnName">parseAssignment</span><span class="oak-leftParen">(</span><span class="oak-identifier">node</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-comment">// this case implements a mini Pratt parser threaded through</span><span class="oak-newline">
			</span><span class="oak-comment">// the larger Oak syntax parser, using the parser struct itself</span><span class="oak-newline">
			</span><span class="oak-comment">// to keep track of the power / precedence stack since other</span><span class="oak-newline">
			</span><span class="oak-comment">// forms may be parsed in between, as in 1 + f(g(x := y)) + 2</span><span class="oak-newline">
			</span><span class="oak-colon">:</span><span class="oak-identifier">plus</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">minus</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">times</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">divide</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">modulus</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">xor</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">and</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">or</span><span class="oak-newline">
			</span><span class="oak-colon">:</span><span class="oak-identifier">pushArrow</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">greater</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">less</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">eq</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">geq</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">leq</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">neq </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-identifier">minPrec </span><span class="oak-assign">:= </span><span class="oak-fnName">lastMinPrec</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
				</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">subBinary </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">eof?</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-trueLiteral">true </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">error</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'Incomplete binary expression'</span><span class="oak-comma">, </span><span class="oak-fnName">lastTokenPos</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
						</span><span class="oak-identifier">peeked </span><span class="oak-assign">:= </span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
						</span><span class="oak-identifier">op </span><span class="oak-assign">:= </span><span class="oak-identifier">peeked</span><span class="oak-dot">.</span><span class="oak-identifier">type</span><span class="oak-newline">
						</span><span class="oak-identifier">prec </span><span class="oak-assign">:= </span><span class="oak-fnName">infixOpPrecedence</span><span class="oak-leftParen">(</span><span class="oak-identifier">op</span><span class="oak-rightParen">)</span><span class="oak-newline">
						</span><span class="oak-ifKeyword">if </span><span class="oak-identifier">prec </span><span class="oak-greater">> </span><span class="oak-identifier">minPrec </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
							</span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-comment">// eat the operator</span>
<span class="oak-newline">
							</span><span class="oak-ifKeyword">if </span><span class="oak-fnName">eof?</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
								</span><span class="oak-trueLiteral">true </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">error</span><span class="oak-leftParen">(</span><span class="oak-fnName">format</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'Incomplete binary expression with {{0}}'</span><span class="oak-comma">, </span><span class="oak-leftBrace">{ </span><span class="oak-identifier">type</span><span class="oak-colon">: </span><span class="oak-identifier">op </span><span class="oak-rightBrace">}</span><span class="oak-rightParen">)</span><span class="oak-comma">, </span><span class="oak-fnName">peek</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-dot">.</span><span class="oak-identifier">pos</span><span class="oak-rightParen">)</span><span class="oak-newline">
								</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
									</span><span class="oak-fnName">pushMinPrec</span><span class="oak-leftParen">(</span><span class="oak-identifier">prec</span><span class="oak-rightParen">)</span><span class="oak-newline">
									</span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-identifier">right </span><span class="oak-assign">:= </span><span class="oak-fnName">parseNode</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
										</span><span class="oak-fnName">popMinPrec</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span>
<span class="oak-newline">
										</span><span class="oak-identifier">node </span><span class="oak-nonlocalAssign">&lt;- </span><span class="oak-leftBrace">{</span><span class="oak-newline">
											</span><span class="oak-identifier">type</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">binary</span><span class="oak-newline">
											</span><span class="oak-identifier">tok</span><span class="oak-colon">: </span><span class="oak-identifier">peeked</span><span class="oak-newline">
											</span><span class="oak-identifier">op</span><span class="oak-colon">: </span><span class="oak-identifier">op</span><span class="oak-newline">
											</span><span class="oak-identifier">left</span><span class="oak-colon">: </span><span class="oak-identifier">node</span><span class="oak-newline">
											</span><span class="oak-identifier">right</span><span class="oak-colon">: </span><span class="oak-identifier">right</span><span class="oak-newline">
										</span><span class="oak-rightBrace">}</span><span class="oak-newline">
										</span><span class="oak-fnName">subBinary</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
									</span><span class="oak-rightBrace">}</span><span class="oak-newline">
								</span><span class="oak-rightBrace">}</span><span class="oak-newline">
							</span><span class="oak-rightBrace">}</span><span class="oak-newline">
						</span><span class="oak-rightBrace">}</span><span class="oak-newline">
					</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-fnName">subBinary</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-comment">// whatever follows a binary expr cannot bind to the</span><span class="oak-newline">
					</span><span class="oak-comment">// binary expression by syntax rule, so we simply</span><span class="oak-newline">
					</span><span class="oak-comment">// return</span><span class="oak-newline">
					</span><span class="oak-identifier">node</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span><span class="oak-newline">
			</span><span class="oak-colon">:</span><span class="oak-identifier">pipeArrow </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-identifier">pipe </span><span class="oak-assign">:= </span><span class="oak-fnName">next</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-comment">// eat the pipe</span><span class="oak-newline">
				</span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-identifier">pipeRight </span><span class="oak-assign">:= </span><span class="oak-fnName">parseSubNode</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">pipeRight</span><span class="oak-dot">.</span><span class="oak-identifier">type </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-colon">:</span><span class="oak-identifier">fnCall </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
						</span><span class="oak-identifier">pipeRight</span><span class="oak-dot">.</span><span class="oak-identifier">args </span><span class="oak-assign">:= </span><span class="oak-fnName">append</span><span class="oak-leftParen">(</span><span class="oak-leftBracket">[</span><span class="oak-identifier">node</span><span class="oak-rightBracket">]</span><span class="oak-comma">, </span><span class="oak-identifier">pipeRight</span><span class="oak-dot">.</span><span class="oak-identifier">args</span><span class="oak-rightParen">)</span><span class="oak-newline">
						</span><span class="oak-identifier">node </span><span class="oak-nonlocalAssign">&lt;- </span><span class="oak-identifier">pipeRight</span><span class="oak-newline">
						</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-rightBrace">}</span><span class="oak-newline">
					</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">error</span><span class="oak-leftParen">(</span><span class="oak-fnName">format</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'Expected function call after |>, got {{0}}'</span><span class="oak-comma">, </span><span class="oak-identifier">pipeRight</span><span class="oak-rightParen">)</span><span class="oak-comma">, </span><span class="oak-identifier">pipe</span><span class="oak-dot">.</span><span class="oak-identifier">pos</span><span class="oak-rightParen">)</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span><span class="oak-newline">
		</span><span class="oak-comment">// the trailing comma is handled as necessary in callers of parseNode</span><span class="oak-newline">
		</span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-identifier">node</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span>
<span class="oak-newline">
	</span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-identifier">parse</span><span class="oak-colon">: </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-comment">// parse</span><span class="oak-newline">
			</span><span class="oak-identifier">nodes </span><span class="oak-assign">:= </span><span class="oak-leftBracket">[</span><span class="oak-rightBracket">]</span><span class="oak-newline">
			</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">sub </span><span class="oak-ifKeyword">if </span><span class="oak-exclam">!</span><span class="oak-fnName">eof?</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-branchArrow">-> </span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-identifier">node </span><span class="oak-assign">:= </span><span class="oak-fnName">parseNode</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-fnName">expect</span><span class="oak-leftParen">(</span><span class="oak-colon">:</span><span class="oak-identifier">comma</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-identifier">nodes </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">node</span><span class="oak-newline">
					</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span><span class="oak-newline">
			</span><span class="oak-withKeyword">with </span><span class="oak-fnName">notError</span><span class="oak-leftParen">(</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-identifier">nodes</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span>
<span class="oak-rightBrace">}</span>

<span class="oak-comment">// parse takes Oak source text and returns a list of AST nodes</span>
<span class="oak-fnKeyword">fn </span><span class="oak-fnName">parse</span><span class="oak-leftParen">(</span><span class="oak-identifier">text</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
	</span><span class="oak-identifier">tokens </span><span class="oak-assign">:= </span><span class="oak-fnName">tokenize</span><span class="oak-leftParen">(</span><span class="oak-identifier">text</span><span class="oak-rightParen">)</span><span class="oak-newline">
	</span><span class="oak-fnName">Parser</span><span class="oak-leftParen">(</span><span class="oak-identifier">tokens</span><span class="oak-rightParen">)</span><span class="oak-dot">.</span><span class="oak-fnName">parse</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span>
<span class="oak-rightBrace">}</span>

<span class="oak-comment">// Printer takes a list of Oak tokens and pretty-prints the source code into a</span>
<span class="oak-comment">// string. As a rule, all newlines are preserved, including those in comments.</span>
<span class="oak-comment">// This differs from the approach of other pretty-printers that prefer to</span>
<span class="oak-comment">// decide on newlines themselves, and is an intentional design decision.</span>
<span class="oak-comment">//</span>
<span class="oak-comment">// Printer is a *token stream-based formatter*. This means unlike many</span>
<span class="oak-comment">// production pretty-printers, syntax.Printer formats code directly from a flat</span>
<span class="oak-comment">// token stream rather than a syntax tree. This has pros and cons.</span>
<span class="oak-comment">//</span>
<span class="oak-comment">// Pros:</span>
<span class="oak-comment">// 1. Resilience. This approach can generally format incomplete code, or code</span>
<span class="oak-comment">//    that may contain syntax errors the parser may not parse. The printer</span>
<span class="oak-comment">//    rarely breaks on bad input.</span>
<span class="oak-comment">// 2. Simplicity. Because the input is a flat list of tokens, the algorithm is</span>
<span class="oak-comment">//    dramatically simpler to write and understand. Each token determines how</span>
<span class="oak-comment">//    it's printed, and each line determines how it's indented.</span>
<span class="oak-comment">// 3. Performance. The simpler design of iterating through a flat list yields</span>
<span class="oak-comment">//    better performance than a full AST based approach.</span>
<span class="oak-comment">//</span>
<span class="oak-comment">// Cons:</span>
<span class="oak-comment">// 1. Fuzzy correctness, especially on edge cases. There are some edge cases</span>
<span class="oak-comment">//    where Printer will yield unexpected output because of context the</span>
<span class="oak-comment">//    algorithm cannot disambiguate fully without a proper AST. Some of these</span>
<span class="oak-comment">//    are documented in test/syntax.test.oak.</span>
<span class="oak-comment">// 2. Lack of ability to make simplifying AST transformations. Some printers</span>
<span class="oak-comment">//    can make basic AST transformations like removing redundant parentheses</span>
<span class="oak-comment">//    during pretty-printing, but using a token based approach precludes us</span>
<span class="oak-comment">//    from doing so.</span>
<span class="oak-comment">//</span>
<span class="oak-comment">// Methods:</span>
<span class="oak-comment">//</span>
<span class="oak-comment">// fn print()   returns a pretty-printed string</span>
<span class="oak-fnKeyword">fn </span><span class="oak-fnName">Printer</span><span class="oak-leftParen">(</span><span class="oak-identifier">tokens</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
	</span><span class="oak-comment">// create a string with N tabs in it</span><span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">tabs</span><span class="oak-leftParen">(</span><span class="oak-identifier">n</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-identifier">n </span><span class="oak-greater">> </span><span class="oak-numberLiteral">0 </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">tabs</span><span class="oak-leftParen">(</span><span class="oak-identifier">n </span><span class="oak-minus">- </span><span class="oak-numberLiteral">1</span><span class="oak-rightParen">) </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-stringLiteral">'\t'</span><span class="oak-newline">
		</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">''</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span>
<span class="oak-newline">
	</span><span class="oak-comment">// a single token -> its printed value</span><span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">render</span><span class="oak-leftParen">(</span><span class="oak-identifier">token</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">token</span><span class="oak-dot">.</span><span class="oak-identifier">type </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">comment </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'//' </span><span class="oak-plus">+ </span><span class="oak-identifier">token</span><span class="oak-dot">.</span><span class="oak-identifier">val</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">comma </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">','</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">dot </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'.'</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">leftParen </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'('</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">rightParen </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">')'</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">leftBracket </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'['</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">rightBracket </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">']'</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">leftBrace </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'{'</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">rightBrace </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'}'</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">assign </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">':='</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">nonlocalAssign </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'&lt;-'</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">pipeArrow </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'|>'</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">branchArrow </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'->'</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">pushArrow </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'&lt;&lt;'</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">colon </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">':'</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">ellipsis </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'...'</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">qmark </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'?'</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">exclam </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'!'</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">plus </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'+'</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">minus </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'-'</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">times </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'*'</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">divide </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'/'</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">modulus </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'%'</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">xor </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'^'</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">and </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'&amp;'</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">or </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'|'</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">greater </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'>'</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">less </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'&lt;'</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">eq </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'='</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">geq </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'>='</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">leq </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'&lt;='</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">neq </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'!='</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">ifKeyword </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'if'</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">fnKeyword </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'fn'</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">withKeyword </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'with'</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">underscore </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'_'</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">identifier </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">token</span><span class="oak-dot">.</span><span class="oak-identifier">val</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">trueLiteral </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'true'</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">falseLiteral </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'false'</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">stringLiteral </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">'\'' </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">token</span><span class="oak-dot">.</span><span class="oak-identifier">val </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-stringLiteral">'\''</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">numberLiteral </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">token</span><span class="oak-dot">.</span><span class="oak-identifier">val</span><span class="oak-newline">
		</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-fnName">printf</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'Unknown token {{0}}'</span><span class="oak-comma">, </span><span class="oak-identifier">token</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-fnName">string</span><span class="oak-leftParen">(</span><span class="oak-identifier">token</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span>
<span class="oak-newline">
	</span><span class="oak-comment">// does a token require a space to follow it in well-formatted code?</span><span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">connectingToken?</span><span class="oak-leftParen">(</span><span class="oak-identifier">tokenType</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">tokenType </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">assign</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">nonlocalAssign</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">pipeArrow</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">branchArrow</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">pushArrow</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">colon</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">plus</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">minus</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">times</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">divide</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">modulus</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">xor</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">and</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">or</span><span class="oak-newline">
		</span><span class="oak-colon">:</span><span class="oak-identifier">greater</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">less</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">eq</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">geq</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">leq</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">neq </span><span class="oak-branchArrow">-> </span><span class="oak-trueLiteral">true</span><span class="oak-newline">
		</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-falseLiteral">false</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span>
<span class="oak-newline">
	</span><span class="oak-comment">// shorthand for the last item of a list</span><span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">last</span><span class="oak-leftParen">(</span><span class="oak-identifier">list</span><span class="oak-rightParen">) </span><span class="oak-identifier">list</span><span class="oak-dot">.</span><span class="oak-leftParen">(</span><span class="oak-fnName">len</span><span class="oak-leftParen">(</span><span class="oak-identifier">list</span><span class="oak-rightParen">) </span><span class="oak-minus">- </span><span class="oak-numberLiteral">1</span><span class="oak-rightParen">)</span>
<span class="oak-newline">
	</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">print </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-comment">// we keep track of lines of code and their corresponding</span><span class="oak-newline">
		</span><span class="oak-comment">// indent levels separately and merge them at the end.</span><span class="oak-newline">
		</span><span class="oak-comment">//</span><span class="oak-newline">
		</span><span class="oak-comment">// this turns out to be simpler than trying to adjust</span><span class="oak-newline">
		</span><span class="oak-comment">// indentations while also adding on lines of code.</span><span class="oak-newline">
		</span><span class="oak-identifier">lines </span><span class="oak-assign">:= </span><span class="oak-leftBracket">[</span><span class="oak-stringLiteral">''</span><span class="oak-rightBracket">]</span><span class="oak-newline">
		</span><span class="oak-identifier">indents </span><span class="oak-assign">:= </span><span class="oak-leftBracket">[</span><span class="oak-rightBracket">]</span>
<span class="oak-newline">
		</span><span class="oak-comment">// algorithm state</span><span class="oak-newline">
		</span><span class="oak-identifier">curr </span><span class="oak-assign">:= </span><span class="oak-numberLiteral">0</span><span class="oak-newline">
		</span><span class="oak-comment">// to properly indent a line, we can't simply track a cumulative</span><span class="oak-newline">
		</span><span class="oak-comment">// indentation level; we need to know what the *lowest level of</span><span class="oak-newline">
		</span><span class="oak-comment">// indentation achieved in that line* is to account for some cases (see</span><span class="oak-newline">
		</span><span class="oak-comment">// "overlapping braces" in test/syntax). We do this by keeping a list</span><span class="oak-newline">
		</span><span class="oak-comment">// of indentation levels after processing every token in a line.</span><span class="oak-newline">
		</span><span class="oak-comment">//</span><span class="oak-newline">
		</span><span class="oak-comment">// We still need to keep track of curr itself to keep track of indent</span><span class="oak-newline">
		</span><span class="oak-comment">// level across lines, and between tokens.</span><span class="oak-newline">
		</span><span class="oak-identifier">currs </span><span class="oak-assign">:= </span><span class="oak-leftBracket">[</span><span class="oak-numberLiteral">0</span><span class="oak-rightBracket">]</span><span class="oak-newline">
		</span><span class="oak-comment">// indicates whether the following line should have a hanging indent</span><span class="oak-newline">
		</span><span class="oak-identifier">hanging? </span><span class="oak-assign">:= </span><span class="oak-falseLiteral">false</span>
<span class="oak-newline">
		</span><span class="oak-comment">// shorthand for adding tokens and spaces to algorithm state</span><span class="oak-newline">
		</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">add</span><span class="oak-leftParen">(</span><span class="oak-identifier">s</span><span class="oak-comma">, </span><span class="oak-identifier">tabs</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-ifKeyword">if </span><span class="oak-fnName">last</span><span class="oak-leftParen">(</span><span class="oak-identifier">lines</span><span class="oak-rightParen">) </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">trim</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'\t'</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-stringLiteral">'' </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">last</span><span class="oak-leftParen">(</span><span class="oak-identifier">lines</span><span class="oak-rightParen">) </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-fnName">trimStart</span><span class="oak-leftParen">(</span><span class="oak-identifier">s</span><span class="oak-rightParen">)</span><span class="oak-newline">
				</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">last</span><span class="oak-leftParen">(</span><span class="oak-identifier">lines</span><span class="oak-rightParen">) </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">s</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span><span class="oak-newline">
			</span><span class="oak-identifier">curr </span><span class="oak-nonlocalAssign">&lt;- </span><span class="oak-identifier">curr </span><span class="oak-plus">+ </span><span class="oak-identifier">tabs</span><span class="oak-newline">
			</span><span class="oak-identifier">currs </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">curr</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span>
<span class="oak-newline">
		</span><span class="oak-comment">// purelyDescendingPrefix takes a list and returns a slice of the list</span><span class="oak-newline">
		</span><span class="oak-comment">// starting at index 0 (a "prefix slice") that contains purely</span><span class="oak-newline">
		</span><span class="oak-comment">// descending elements.</span><span class="oak-newline">
		</span><span class="oak-comment">//</span><span class="oak-newline">
		</span><span class="oak-comment">// For example, a purelyDescendingPrefix of [5, 2, 1, 1, 10, 3, 8] is</span><span class="oak-newline">
		</span><span class="oak-comment">// [5, 2, 1].</span><span class="oak-newline">
		</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">purelyDescendingPrefix</span><span class="oak-leftParen">(</span><span class="oak-identifier">list</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">len</span><span class="oak-leftParen">(</span><span class="oak-identifier">list</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-numberLiteral">0 </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">list</span><span class="oak-newline">
			</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">i</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-identifier">i </span><span class="oak-eq">= </span><span class="oak-fnName">len</span><span class="oak-leftParen">(</span><span class="oak-identifier">list</span><span class="oak-rightParen">) </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">list </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">take</span><span class="oak-leftParen">(</span><span class="oak-identifier">i</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-identifier">list</span><span class="oak-dot">.</span><span class="oak-leftParen">(</span><span class="oak-identifier">i </span><span class="oak-minus">- </span><span class="oak-numberLiteral">1</span><span class="oak-rightParen">) </span><span class="oak-greater">> </span><span class="oak-identifier">list</span><span class="oak-dot">.</span><span class="oak-leftParen">(</span><span class="oak-identifier">i</span><span class="oak-rightParen">) </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">i </span><span class="oak-plus">+ </span><span class="oak-numberLiteral">1</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">list </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">take</span><span class="oak-leftParen">(</span><span class="oak-identifier">i</span><span class="oak-rightParen">)</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-numberLiteral">1</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span>
<span class="oak-newline">
		</span><span class="oak-comment">// indentLine encapsulates the full indentation logic (except for</span><span class="oak-newline">
		</span><span class="oak-comment">// indentation collapsing, described below) in Printer's formatting</span><span class="oak-newline">
		</span><span class="oak-comment">// algorithm.</span><span class="oak-newline">
		</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">indentLine</span><span class="oak-leftParen">(</span><span class="oak-identifier">lastType</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-comment">// using min(currs...) instead of curr ensures that if a line</span><span class="oak-newline">
			</span><span class="oak-comment">// closes some indentation levels and re-opens other indentation</span><span class="oak-newline">
			</span><span class="oak-comment">// levels, the line is indented correctly. It does this by using a</span><span class="oak-newline">
			</span><span class="oak-comment">// "minimum achieved indentation" during a line's token stream</span><span class="oak-newline">
			</span><span class="oak-comment">// rather than the final indent level, so that we account for the</span><span class="oak-newline">
			</span><span class="oak-comment">// same line opening and closing blocks.</span><span class="oak-newline">
			</span><span class="oak-comment">//</span><span class="oak-newline">
			</span><span class="oak-comment">// In code like this:</span><span class="oak-newline">
			</span><span class="oak-comment">// 1 | {</span><span class="oak-newline">
			</span><span class="oak-comment">// 2 |     something</span><span class="oak-newline">
			</span><span class="oak-comment">// 3 | } + [{</span><span class="oak-newline">
			</span><span class="oak-comment">// 4 |     something else</span><span class="oak-newline">
			</span><span class="oak-comment">// 5 | }]</span><span class="oak-newline">
			</span><span class="oak-comment">//</span><span class="oak-newline">
			</span><span class="oak-comment">// In line 3, a pure count of open blocks would have the line</span><span class="oak-newline">
			</span><span class="oak-comment">// indented 1 level, but intuitively this isn't what we want. We</span><span class="oak-newline">
			</span><span class="oak-comment">// want line 3 to be indented 0 levels, because the open block was</span><span class="oak-newline">
			</span><span class="oak-comment">// closed and a different block was opened.</span><span class="oak-newline">
			</span><span class="oak-identifier">indent </span><span class="oak-assign">:= </span><span class="oak-fnName">min</span><span class="oak-leftParen">(</span><span class="oak-identifier">currs</span><span class="oak-ellipsis">...</span><span class="oak-rightParen">)</span>
<span class="oak-newline">
			</span><span class="oak-comment">// account for hanging indents</span><span class="oak-newline">
			</span><span class="oak-ifKeyword">if </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-comment">// this check ensures correctness of cases where a hanging</span><span class="oak-newline">
				</span><span class="oak-comment">// indent is preferred even though a given line closes an open</span><span class="oak-newline">
				</span><span class="oak-comment">// block, because there is content before the block is closed.</span><span class="oak-newline">
				</span><span class="oak-comment">//</span><span class="oak-newline">
				</span><span class="oak-comment">// In code like this:</span><span class="oak-newline">
				</span><span class="oak-comment">// 1 | [1, 2, 3</span><span class="oak-newline">
				</span><span class="oak-comment">// 2 |     4, 5, 6]</span><span class="oak-newline">
				</span><span class="oak-comment">//</span><span class="oak-newline">
				</span><span class="oak-comment">// In line 2, a pure count of open blocks would have the line</span><span class="oak-newline">
				</span><span class="oak-comment">// indented 0 levels, but intuitively this isn't what we want,</span><span class="oak-newline">
				</span><span class="oak-comment">// because there is content preceding the closing token ']'.</span><span class="oak-newline">
				</span><span class="oak-comment">//</span><span class="oak-newline">
				</span><span class="oak-comment">// We account for this by counting the length of the *purely</span><span class="oak-newline">
				</span><span class="oak-comment">// descending prefix* of indents after every token in the</span><span class="oak-newline">
				</span><span class="oak-comment">// current line. In other words, we check if the line closes</span><span class="oak-newline">
				</span><span class="oak-comment">// existing indents immediately with closing )]}s, or if there</span><span class="oak-newline">
				</span><span class="oak-comment">// is non-indentation related content at the start of the line.</span><span class="oak-newline">
				</span><span class="oak-comment">//</span><span class="oak-newline">
				</span><span class="oak-comment">// If there is such content (len(prefix) &lt;= 1) and the line</span><span class="oak-newline">
				</span><span class="oak-comment">// eventually closes some indents (prefix.0 > indent), we hang</span><span class="oak-newline">
				</span><span class="oak-comment">// this line's indent.</span><span class="oak-newline">
				</span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-identifier">prefix </span><span class="oak-assign">:= </span><span class="oak-fnName">purelyDescendingPrefix</span><span class="oak-leftParen">(</span><span class="oak-identifier">currs</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-fnName">len</span><span class="oak-leftParen">(</span><span class="oak-identifier">prefix</span><span class="oak-rightParen">) </span><span class="oak-leq">&lt;= </span><span class="oak-numberLiteral">1 </span><span class="oak-and">&amp; </span><span class="oak-fnName">default</span><span class="oak-leftParen">(</span><span class="oak-identifier">prefix</span><span class="oak-dot">.</span><span class="oak-numberLiteral">0</span><span class="oak-comma">, </span><span class="oak-numberLiteral">0</span><span class="oak-rightParen">) </span><span class="oak-greater">> </span><span class="oak-identifier">indent</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-comment">// the hanging? flag is set by the previous line, from an</span><span class="oak-newline">
				</span><span class="oak-comment">// incomplete infix operator or other similar constructs</span><span class="oak-newline">
				</span><span class="oak-identifier">hanging? </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">indent </span><span class="oak-nonlocalAssign">&lt;- </span><span class="oak-identifier">indent </span><span class="oak-plus">+ </span><span class="oak-numberLiteral">1</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span>
<span class="oak-newline">
			</span><span class="oak-comment">// set the hanging indent flag for this current line, so we can</span><span class="oak-newline">
			</span><span class="oak-comment">// indent accordingly at start of next line</span><span class="oak-newline">
			</span><span class="oak-identifier">hanging? </span><span class="oak-nonlocalAssign">&lt;- </span><span class="oak-ifKeyword">if </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-fnName">connectingToken?</span><span class="oak-leftParen">(</span><span class="oak-identifier">lastType</span><span class="oak-rightParen">)</span><span class="oak-newline">
				</span><span class="oak-identifier">lastType </span><span class="oak-eq">= </span><span class="oak-colon">:</span><span class="oak-identifier">dot </span><span class="oak-branchArrow">-> </span><span class="oak-trueLiteral">true</span><span class="oak-newline">
				</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-falseLiteral">false</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span>
<span class="oak-newline">
			</span><span class="oak-identifier">indent</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span>
<span class="oak-newline">
		</span><span class="oak-comment">// in this loop, we ask whether a space should come before each token.</span><span class="oak-newline">
		</span><span class="oak-comment">// as a result: a token is only responsible for adding a space before</span><span class="oak-newline">
		</span><span class="oak-comment">// it, not after it</span><span class="oak-newline">
		</span><span class="oak-identifier">tokens </span><span class="oak-pipeArrow">|> </span><span class="oak-withKeyword">with </span><span class="oak-fnName">each</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn</span><span class="oak-leftParen">(</span><span class="oak-identifier">token</span><span class="oak-comma">, </span><span class="oak-identifier">i</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-identifier">nextType </span><span class="oak-assign">:= </span><span class="oak-fnName">default</span><span class="oak-leftParen">(</span><span class="oak-identifier">tokens</span><span class="oak-dot">.</span><span class="oak-leftParen">(</span><span class="oak-identifier">i </span><span class="oak-plus">+ </span><span class="oak-numberLiteral">1</span><span class="oak-rightParen">)</span><span class="oak-comma">, </span><span class="oak-leftBrace">{ </span><span class="oak-identifier">type</span><span class="oak-colon">: </span><span class="oak-colon">:</span><span class="oak-identifier">newline </span><span class="oak-rightBrace">}</span><span class="oak-rightParen">)</span><span class="oak-dot">.</span><span class="oak-identifier">type</span>
<span class="oak-newline">
			</span><span class="oak-comment">// indentation and token spacing are based on lastType, so it must</span><span class="oak-newline">
			</span><span class="oak-comment">// ignore any comments and newlines in between comments that</span><span class="oak-newline">
			</span><span class="oak-comment">// precede the current token. This algorithm traces back until it</span><span class="oak-newline">
			</span><span class="oak-comment">// can reach a non-comment token to determine lastType(s).</span><span class="oak-newline">
			</span><span class="oak-leftBracket">[</span><span class="oak-identifier">lastLastType</span><span class="oak-comma">, </span><span class="oak-identifier">lastType</span><span class="oak-rightBracket">] </span><span class="oak-assign">:= </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">i </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-numberLiteral">0 </span><span class="oak-branchArrow">-> </span><span class="oak-leftBracket">[</span><span class="oak-colon">:</span><span class="oak-identifier">newline</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">newline</span><span class="oak-rightBracket">]</span><span class="oak-newline">
				</span><span class="oak-numberLiteral">1 </span><span class="oak-branchArrow">-> </span><span class="oak-leftBracket">[</span><span class="oak-colon">:</span><span class="oak-identifier">newline</span><span class="oak-comma">, </span><span class="oak-identifier">tokens</span><span class="oak-dot">.</span><span class="oak-leftParen">(</span><span class="oak-identifier">i </span><span class="oak-minus">- </span><span class="oak-numberLiteral">1</span><span class="oak-rightParen">)</span><span class="oak-dot">.</span><span class="oak-identifier">type</span><span class="oak-rightBracket">]</span><span class="oak-newline">
				</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">prev</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">prev </span><span class="oak-leftBrace">{</span><span class="oak-newline">
						</span><span class="oak-comment">// -2 may appear in recursive cases</span><span class="oak-newline">
						</span><span class="oak-minus">-</span><span class="oak-numberLiteral">2</span><span class="oak-comma">, </span><span class="oak-minus">-</span><span class="oak-numberLiteral">1</span><span class="oak-comma">, </span><span class="oak-numberLiteral">0 </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">prev</span><span class="oak-newline">
						</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-leftBracket">[</span><span class="oak-identifier">tokens</span><span class="oak-dot">.</span><span class="oak-leftParen">(</span><span class="oak-identifier">prev</span><span class="oak-rightParen">)</span><span class="oak-dot">.</span><span class="oak-identifier">type</span><span class="oak-comma">, </span><span class="oak-identifier">tokens</span><span class="oak-dot">.</span><span class="oak-leftParen">(</span><span class="oak-identifier">prev </span><span class="oak-minus">- </span><span class="oak-numberLiteral">1</span><span class="oak-rightParen">)</span><span class="oak-dot">.</span><span class="oak-identifier">type</span><span class="oak-rightBracket">] </span><span class="oak-leftBrace">{</span><span class="oak-newline">
							</span><span class="oak-comment">// multiline comments</span><span class="oak-newline">
							</span><span class="oak-leftBracket">[</span><span class="oak-colon">:</span><span class="oak-identifier">newline</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">comment</span><span class="oak-rightBracket">]</span><span class="oak-newline">
							</span><span class="oak-leftBracket">[</span><span class="oak-colon">:</span><span class="oak-identifier">comment</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">newline</span><span class="oak-rightBracket">] </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">prev </span><span class="oak-minus">- </span><span class="oak-numberLiteral">2</span><span class="oak-rightParen">)</span><span class="oak-newline">
							</span><span class="oak-comment">// in-line comments, coming after tokens in the same line</span><span class="oak-newline">
							</span><span class="oak-leftBracket">[</span><span class="oak-colon">:</span><span class="oak-identifier">comment</span><span class="oak-comma">, </span><span class="oak-underscore">_</span><span class="oak-rightBracket">] </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">prev </span><span class="oak-minus">- </span><span class="oak-numberLiteral">1</span><span class="oak-rightParen">)</span><span class="oak-newline">
							</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">prev</span><span class="oak-newline">
						</span><span class="oak-rightBrace">}</span><span class="oak-newline">
					</span><span class="oak-rightBrace">}</span><span class="oak-newline">
					</span><span class="oak-identifier">prev </span><span class="oak-assign">:= </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">i </span><span class="oak-minus">- </span><span class="oak-numberLiteral">1</span><span class="oak-rightParen">) </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">max</span><span class="oak-leftParen">(</span><span class="oak-numberLiteral">0</span><span class="oak-rightParen">)</span>
<span class="oak-newline">
					</span><span class="oak-leftBracket">[</span><span class="oak-newline">
						</span><span class="oak-ifKeyword">if </span><span class="oak-identifier">prev </span><span class="oak-leftBrace">{</span><span class="oak-newline">
							</span><span class="oak-numberLiteral">0 </span><span class="oak-branchArrow">-> </span><span class="oak-colon">:</span><span class="oak-identifier">newline</span><span class="oak-newline">
							</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">tokens</span><span class="oak-dot">.</span><span class="oak-leftParen">(</span><span class="oak-identifier">prev </span><span class="oak-minus">- </span><span class="oak-numberLiteral">1</span><span class="oak-rightParen">)</span><span class="oak-dot">.</span><span class="oak-identifier">type</span><span class="oak-newline">
						</span><span class="oak-rightBrace">}</span><span class="oak-newline">
						</span><span class="oak-identifier">tokens</span><span class="oak-dot">.</span><span class="oak-leftParen">(</span><span class="oak-identifier">prev</span><span class="oak-rightParen">)</span><span class="oak-dot">.</span><span class="oak-identifier">type</span><span class="oak-newline">
					</span><span class="oak-rightBracket">]</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span>
<span class="oak-newline">
			</span><span class="oak-ifKeyword">if </span><span class="oak-leftBracket">[</span><span class="oak-identifier">lastType</span><span class="oak-comma">, </span><span class="oak-identifier">token</span><span class="oak-dot">.</span><span class="oak-identifier">type</span><span class="oak-comma">, </span><span class="oak-identifier">nextType</span><span class="oak-rightBracket">] </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-comment">// this match clause is responsible for computing the correct</span><span class="oak-newline">
				</span><span class="oak-comment">// level of indentation for the line that comes before this</span><span class="oak-newline">
				</span><span class="oak-comment">// current newline.</span><span class="oak-newline">
				</span><span class="oak-comment">//</span><span class="oak-newline">
				</span><span class="oak-comment">// as a result, we compute each line's indentation level only</span><span class="oak-newline">
				</span><span class="oak-comment">// after we fully tokenize and render the line itself.</span><span class="oak-newline">
				</span><span class="oak-leftBracket">[</span><span class="oak-underscore">_</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">newline</span><span class="oak-comma">, </span><span class="oak-underscore">_</span><span class="oak-rightBracket">] </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-identifier">indents </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-fnName">indentLine</span><span class="oak-leftParen">(</span><span class="oak-identifier">lastType</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-identifier">currs </span><span class="oak-nonlocalAssign">&lt;- </span><span class="oak-leftBracket">[</span><span class="oak-identifier">curr</span><span class="oak-rightBracket">]</span><span class="oak-newline">
					</span><span class="oak-identifier">lines </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-stringLiteral">''</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-leftBracket">[</span><span class="oak-underscore">_</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">dot</span><span class="oak-comma">, </span><span class="oak-underscore">_</span><span class="oak-rightBracket">] </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">add</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'.'</span><span class="oak-comma">, </span><span class="oak-numberLiteral">0</span><span class="oak-rightParen">)</span>
<span class="oak-newline">
				</span><span class="oak-comment">// opening delimiters</span><span class="oak-newline">
				</span><span class="oak-leftBracket">[</span><span class="oak-underscore">_</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">leftParen</span><span class="oak-comma">, </span><span class="oak-underscore">_</span><span class="oak-rightBracket">] </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-fnName">connectingToken?</span><span class="oak-leftParen">(</span><span class="oak-identifier">lastType</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-identifier">lastType </span><span class="oak-eq">= </span><span class="oak-colon">:</span><span class="oak-identifier">comma</span><span class="oak-newline">
					</span><span class="oak-identifier">lastType </span><span class="oak-eq">= </span><span class="oak-colon">:</span><span class="oak-identifier">ifKeyword</span><span class="oak-newline">
					</span><span class="oak-identifier">lastType </span><span class="oak-eq">= </span><span class="oak-colon">:</span><span class="oak-identifier">withKeyword </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">add</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">' ' </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-fnName">render</span><span class="oak-leftParen">(</span><span class="oak-identifier">token</span><span class="oak-rightParen">)</span><span class="oak-comma">, </span><span class="oak-numberLiteral">1</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">add</span><span class="oak-leftParen">(</span><span class="oak-fnName">render</span><span class="oak-leftParen">(</span><span class="oak-identifier">token</span><span class="oak-rightParen">)</span><span class="oak-comma">, </span><span class="oak-numberLiteral">1</span><span class="oak-rightParen">)</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-leftBracket">[</span><span class="oak-underscore">_</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">leftBracket</span><span class="oak-comma">, </span><span class="oak-underscore">_</span><span class="oak-rightBracket">]</span><span class="oak-newline">
				</span><span class="oak-leftBracket">[</span><span class="oak-underscore">_</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">leftBrace</span><span class="oak-comma">, </span><span class="oak-underscore">_</span><span class="oak-rightBracket">] </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">lastType </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-colon">:</span><span class="oak-identifier">leftParen</span><span class="oak-newline">
					</span><span class="oak-colon">:</span><span class="oak-identifier">leftBracket </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">add</span><span class="oak-leftParen">(</span><span class="oak-fnName">render</span><span class="oak-leftParen">(</span><span class="oak-identifier">token</span><span class="oak-rightParen">)</span><span class="oak-comma">, </span><span class="oak-numberLiteral">1</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">add</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">' ' </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-fnName">render</span><span class="oak-leftParen">(</span><span class="oak-identifier">token</span><span class="oak-rightParen">)</span><span class="oak-comma">, </span><span class="oak-numberLiteral">1</span><span class="oak-rightParen">)</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span>
<span class="oak-newline">
				</span><span class="oak-comment">// if following a newline, these are exempt from the following rule</span><span class="oak-newline">
				</span><span class="oak-leftBracket">[</span><span class="oak-colon">:</span><span class="oak-identifier">newline</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">rightParen</span><span class="oak-comma">, </span><span class="oak-underscore">_</span><span class="oak-rightBracket">]</span><span class="oak-newline">
				</span><span class="oak-leftBracket">[</span><span class="oak-colon">:</span><span class="oak-identifier">newline</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">rightBracket</span><span class="oak-comma">, </span><span class="oak-underscore">_</span><span class="oak-rightBracket">]</span><span class="oak-newline">
				</span><span class="oak-leftBracket">[</span><span class="oak-colon">:</span><span class="oak-identifier">newline</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">rightBrace</span><span class="oak-comma">, </span><span class="oak-underscore">_</span><span class="oak-rightBracket">] </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">add</span><span class="oak-leftParen">(</span><span class="oak-fnName">render</span><span class="oak-leftParen">(</span><span class="oak-identifier">token</span><span class="oak-rightParen">)</span><span class="oak-comma">, </span><span class="oak-minus">-</span><span class="oak-numberLiteral">1</span><span class="oak-rightParen">)</span>
<span class="oak-newline">
				</span><span class="oak-comment">// ensure { thing } and not {thing}</span><span class="oak-newline">
				</span><span class="oak-leftBracket">[</span><span class="oak-underscore">_</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">rightParen</span><span class="oak-comma">, </span><span class="oak-underscore">_</span><span class="oak-rightBracket">]</span><span class="oak-newline">
				</span><span class="oak-leftBracket">[</span><span class="oak-underscore">_</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">rightBracket</span><span class="oak-comma">, </span><span class="oak-underscore">_</span><span class="oak-rightBracket">] </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">add</span><span class="oak-leftParen">(</span><span class="oak-fnName">render</span><span class="oak-leftParen">(</span><span class="oak-identifier">token</span><span class="oak-rightParen">)</span><span class="oak-comma">, </span><span class="oak-minus">-</span><span class="oak-numberLiteral">1</span><span class="oak-rightParen">)</span><span class="oak-newline">
				</span><span class="oak-comment">// empty object/block special case</span><span class="oak-newline">
				</span><span class="oak-leftBracket">[</span><span class="oak-colon">:</span><span class="oak-identifier">leftBrace</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">rightBrace</span><span class="oak-comma">, </span><span class="oak-underscore">_</span><span class="oak-rightBracket">] </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">add</span><span class="oak-leftParen">(</span><span class="oak-fnName">render</span><span class="oak-leftParen">(</span><span class="oak-identifier">token</span><span class="oak-rightParen">)</span><span class="oak-comma">, </span><span class="oak-minus">-</span><span class="oak-numberLiteral">1</span><span class="oak-rightParen">)</span><span class="oak-newline">
				</span><span class="oak-leftBracket">[</span><span class="oak-underscore">_</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">rightBrace</span><span class="oak-comma">, </span><span class="oak-underscore">_</span><span class="oak-rightBracket">] </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">add</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">' ' </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-fnName">render</span><span class="oak-leftParen">(</span><span class="oak-identifier">token</span><span class="oak-rightParen">)</span><span class="oak-comma">, </span><span class="oak-minus">-</span><span class="oak-numberLiteral">1</span><span class="oak-rightParen">)</span>
<span class="oak-newline">
				</span><span class="oak-comment">// no-ops, where we rely on automatic comma insertion</span><span class="oak-newline">
				</span><span class="oak-leftBracket">[</span><span class="oak-underscore">_</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">comma</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">newline</span><span class="oak-rightBracket">]</span><span class="oak-newline">
				</span><span class="oak-leftBracket">[</span><span class="oak-underscore">_</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">comma</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">rightParen</span><span class="oak-rightBracket">]</span><span class="oak-newline">
				</span><span class="oak-leftBracket">[</span><span class="oak-underscore">_</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">comma</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">rightBracket</span><span class="oak-rightBracket">]</span><span class="oak-newline">
				</span><span class="oak-leftBracket">[</span><span class="oak-underscore">_</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">comma</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">rightBrace</span><span class="oak-rightBracket">] </span><span class="oak-branchArrow">-> </span><span class="oak-qmark">?</span>
<span class="oak-newline">
				</span><span class="oak-comment">// special cases for colon used in atoms</span><span class="oak-newline">
				</span><span class="oak-leftBracket">[</span><span class="oak-underscore">_</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">colon</span><span class="oak-comma">, </span><span class="oak-underscore">_</span><span class="oak-rightBracket">] </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-identifier">lastType </span><span class="oak-eq">= </span><span class="oak-colon">:</span><span class="oak-identifier">comma</span><span class="oak-newline">
					</span><span class="oak-identifier">lastType </span><span class="oak-eq">= </span><span class="oak-colon">:</span><span class="oak-identifier">leftBrace</span><span class="oak-newline">
					</span><span class="oak-fnName">connectingToken?</span><span class="oak-leftParen">(</span><span class="oak-identifier">lastType</span><span class="oak-rightParen">) </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">add</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">' :'</span><span class="oak-comma">, </span><span class="oak-numberLiteral">0</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">add</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">':'</span><span class="oak-comma">, </span><span class="oak-numberLiteral">0</span><span class="oak-rightParen">)</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span>
<span class="oak-newline">
				</span><span class="oak-comment">// no-space tokens</span><span class="oak-newline">
				</span><span class="oak-leftBracket">[</span><span class="oak-underscore">_</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">comma</span><span class="oak-comma">, </span><span class="oak-underscore">_</span><span class="oak-rightBracket">]</span><span class="oak-newline">
				</span><span class="oak-leftBracket">[</span><span class="oak-underscore">_</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">ellipsis</span><span class="oak-comma">, </span><span class="oak-underscore">_</span><span class="oak-rightBracket">] </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">add</span><span class="oak-leftParen">(</span><span class="oak-fnName">render</span><span class="oak-leftParen">(</span><span class="oak-identifier">token</span><span class="oak-rightParen">)</span><span class="oak-comma">, </span><span class="oak-numberLiteral">0</span><span class="oak-rightParen">)</span>
<span class="oak-newline">
				</span><span class="oak-comment">// parens and lists don't include inner space</span><span class="oak-newline">
				</span><span class="oak-leftBracket">[</span><span class="oak-colon">:</span><span class="oak-identifier">leftParen</span><span class="oak-comma">, </span><span class="oak-underscore">_</span><span class="oak-comma">, </span><span class="oak-underscore">_</span><span class="oak-rightBracket">]</span><span class="oak-newline">
				</span><span class="oak-leftBracket">[</span><span class="oak-colon">:</span><span class="oak-identifier">leftBracket</span><span class="oak-comma">, </span><span class="oak-underscore">_</span><span class="oak-comma">, </span><span class="oak-underscore">_</span><span class="oak-rightBracket">]</span>
<span class="oak-newline">
				</span><span class="oak-comment">// no-space operators</span><span class="oak-newline">
				</span><span class="oak-leftBracket">[</span><span class="oak-colon">:</span><span class="oak-identifier">dot</span><span class="oak-comma">, </span><span class="oak-underscore">_</span><span class="oak-comma">, </span><span class="oak-underscore">_</span><span class="oak-rightBracket">]</span><span class="oak-newline">
				</span><span class="oak-leftBracket">[</span><span class="oak-colon">:</span><span class="oak-identifier">exclam</span><span class="oak-comma">, </span><span class="oak-underscore">_</span><span class="oak-comma">, </span><span class="oak-underscore">_</span><span class="oak-rightBracket">] </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">add</span><span class="oak-leftParen">(</span><span class="oak-fnName">render</span><span class="oak-leftParen">(</span><span class="oak-identifier">token</span><span class="oak-rightParen">)</span><span class="oak-comma">, </span><span class="oak-numberLiteral">0</span><span class="oak-rightParen">)</span>
<span class="oak-newline">
				</span><span class="oak-comment">// unary exprs (which may also be used as binary infix)</span><span class="oak-newline">
				</span><span class="oak-leftBracket">[</span><span class="oak-colon">:</span><span class="oak-identifier">minus</span><span class="oak-comma">, </span><span class="oak-underscore">_</span><span class="oak-comma">, </span><span class="oak-underscore">_</span><span class="oak-rightBracket">] </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">lastLastType </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-colon">:</span><span class="oak-identifier">leftParen</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">leftBracket</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">leftBrace</span><span class="oak-newline">
					</span><span class="oak-colon">:</span><span class="oak-identifier">ifKeyword</span><span class="oak-newline">
					</span><span class="oak-colon">:</span><span class="oak-identifier">exclam</span><span class="oak-newline">
					</span><span class="oak-colon">:</span><span class="oak-identifier">minus</span><span class="oak-newline">
					</span><span class="oak-colon">:</span><span class="oak-identifier">newline</span><span class="oak-newline">
					</span><span class="oak-colon">:</span><span class="oak-identifier">comma</span><span class="oak-newline">
					</span><span class="oak-colon">:</span><span class="oak-identifier">colon </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">add</span><span class="oak-leftParen">(</span><span class="oak-fnName">render</span><span class="oak-leftParen">(</span><span class="oak-identifier">token</span><span class="oak-rightParen">)</span><span class="oak-comma">, </span><span class="oak-numberLiteral">0</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">connectingToken?</span><span class="oak-leftParen">(</span><span class="oak-identifier">lastLastType</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
						</span><span class="oak-trueLiteral">true </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">add</span><span class="oak-leftParen">(</span><span class="oak-fnName">render</span><span class="oak-leftParen">(</span><span class="oak-identifier">token</span><span class="oak-rightParen">)</span><span class="oak-comma">, </span><span class="oak-numberLiteral">0</span><span class="oak-rightParen">)</span><span class="oak-newline">
						</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">add</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">' ' </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-fnName">render</span><span class="oak-leftParen">(</span><span class="oak-identifier">token</span><span class="oak-rightParen">)</span><span class="oak-comma">, </span><span class="oak-numberLiteral">0</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span>
<span class="oak-newline">
				</span><span class="oak-comment">// atom special case</span><span class="oak-newline">
				</span><span class="oak-leftBracket">[</span><span class="oak-colon">:</span><span class="oak-identifier">colon</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">identifier</span><span class="oak-comma">, </span><span class="oak-underscore">_</span><span class="oak-rightBracket">]</span><span class="oak-newline">
				</span><span class="oak-leftBracket">[</span><span class="oak-colon">:</span><span class="oak-identifier">colon</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">ifKeyword</span><span class="oak-comma">, </span><span class="oak-underscore">_</span><span class="oak-rightBracket">]</span><span class="oak-newline">
				</span><span class="oak-leftBracket">[</span><span class="oak-colon">:</span><span class="oak-identifier">colon</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">fnKeyword</span><span class="oak-comma">, </span><span class="oak-underscore">_</span><span class="oak-rightBracket">]</span><span class="oak-newline">
				</span><span class="oak-leftBracket">[</span><span class="oak-colon">:</span><span class="oak-identifier">colon</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">withKeyword</span><span class="oak-comma">, </span><span class="oak-underscore">_</span><span class="oak-rightBracket">]</span><span class="oak-newline">
				</span><span class="oak-leftBracket">[</span><span class="oak-colon">:</span><span class="oak-identifier">colon</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">trueLiteral</span><span class="oak-comma">, </span><span class="oak-underscore">_</span><span class="oak-rightBracket">]</span><span class="oak-newline">
				</span><span class="oak-leftBracket">[</span><span class="oak-colon">:</span><span class="oak-identifier">colon</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">falseLiteral</span><span class="oak-comma">, </span><span class="oak-underscore">_</span><span class="oak-rightBracket">] </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">lastLastType </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-comment">// if token before colon cannot be end of an object key,</span><span class="oak-newline">
					</span><span class="oak-comment">// don't insert a space. This isn't a perfect rule but</span><span class="oak-newline">
					</span><span class="oak-comment">// seems to be a good-enough algorithm.</span><span class="oak-newline">
					</span><span class="oak-colon">:</span><span class="oak-identifier">leftParen</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">leftBracket</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">leftBrace</span><span class="oak-newline">
					</span><span class="oak-colon">:</span><span class="oak-identifier">rightParen</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">rightBracket</span><span class="oak-comma">, </span><span class="oak-colon">:</span><span class="oak-identifier">rightBrace</span><span class="oak-newline">
					</span><span class="oak-colon">:</span><span class="oak-identifier">ifKeyword</span><span class="oak-newline">
					</span><span class="oak-colon">:</span><span class="oak-identifier">exclam</span><span class="oak-newline">
					</span><span class="oak-colon">:</span><span class="oak-identifier">minus</span><span class="oak-newline">
					</span><span class="oak-colon">:</span><span class="oak-identifier">newline</span><span class="oak-newline">
					</span><span class="oak-colon">:</span><span class="oak-identifier">comma</span><span class="oak-newline">
					</span><span class="oak-colon">:</span><span class="oak-identifier">colon </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">add</span><span class="oak-leftParen">(</span><span class="oak-fnName">render</span><span class="oak-leftParen">(</span><span class="oak-identifier">token</span><span class="oak-rightParen">)</span><span class="oak-comma">, </span><span class="oak-numberLiteral">0</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-fnName">connectingToken?</span><span class="oak-leftParen">(</span><span class="oak-identifier">lastLastType</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
						</span><span class="oak-trueLiteral">true </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">add</span><span class="oak-leftParen">(</span><span class="oak-fnName">render</span><span class="oak-leftParen">(</span><span class="oak-identifier">token</span><span class="oak-rightParen">)</span><span class="oak-comma">, </span><span class="oak-numberLiteral">0</span><span class="oak-rightParen">)</span><span class="oak-newline">
						</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">add</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">' ' </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-fnName">render</span><span class="oak-leftParen">(</span><span class="oak-identifier">token</span><span class="oak-rightParen">)</span><span class="oak-comma">, </span><span class="oak-numberLiteral">0</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span>
<span class="oak-newline">
				</span><span class="oak-leftBracket">[</span><span class="oak-colon">:</span><span class="oak-identifier">leftBrace</span><span class="oak-comma">, </span><span class="oak-underscore">_</span><span class="oak-comma">, </span><span class="oak-underscore">_</span><span class="oak-rightBracket">]</span><span class="oak-newline">
				</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">add</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">' ' </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-fnName">render</span><span class="oak-leftParen">(</span><span class="oak-identifier">token</span><span class="oak-rightParen">)</span><span class="oak-comma">, </span><span class="oak-numberLiteral">0</span><span class="oak-rightParen">)</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span>
<span class="oak-newline">
		</span><span class="oak-comment">// indent last line</span><span class="oak-newline">
		</span><span class="oak-identifier">indents </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-fnName">indentLine</span><span class="oak-leftParen">(</span><span class="oak-fnName">last</span><span class="oak-leftParen">(</span><span class="oak-identifier">tokens</span><span class="oak-rightParen">)</span><span class="oak-rightParen">)</span>
<span class="oak-newline">
		</span><span class="oak-comment">// indentation collapsing:</span><span class="oak-newline">
		</span><span class="oak-comment">//</span><span class="oak-newline">
		</span><span class="oak-comment">// sometimes, multiple delimiter openers in a single line or a callback</span><span class="oak-newline">
		</span><span class="oak-comment">// being passed into a function will add multiple levels of indentation</span><span class="oak-newline">
		</span><span class="oak-comment">// in the above algorithm, but we only really want to indent one level</span><span class="oak-newline">
		</span><span class="oak-comment">// at a time visually, even if semantically there are multiple levels</span><span class="oak-newline">
		</span><span class="oak-comment">// of nesting present. We try to detect and "collapse" these</span><span class="oak-newline">
		</span><span class="oak-comment">// indentations into single levels of tab here.</span><span class="oak-newline">
		</span><span class="oak-comment">//</span><span class="oak-newline">
		</span><span class="oak-comment">// we do this by scanning lines and finding groups of lines that are</span><span class="oak-newline">
		</span><span class="oak-comment">// indented by more than 1 level at a time, and de-indenting them until</span><span class="oak-newline">
		</span><span class="oak-comment">// they're only indented one level.</span><span class="oak-newline">
		</span><span class="oak-identifier">indents </span><span class="oak-pipeArrow">|> </span><span class="oak-withKeyword">with </span><span class="oak-fnName">each</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn</span><span class="oak-leftParen">(</span><span class="oak-identifier">n</span><span class="oak-comma">, </span><span class="oak-identifier">i</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">i </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-numberLiteral">0 </span><span class="oak-branchArrow">-> </span><span class="oak-qmark">?</span><span class="oak-newline">
			</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">n </span><span class="oak-less">&lt; </span><span class="oak-identifier">indents</span><span class="oak-dot">.</span><span class="oak-leftParen">(</span><span class="oak-identifier">i </span><span class="oak-minus">- </span><span class="oak-numberLiteral">1</span><span class="oak-rightParen">) </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
				</span><span class="oak-comment">// backtrack to the line immediately following the first line</span><span class="oak-newline">
				</span><span class="oak-comment">// where indent > n</span><span class="oak-newline">
				</span><span class="oak-fnKeyword">fn </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">j</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-identifier">indents</span><span class="oak-dot">.</span><span class="oak-leftParen">(</span><span class="oak-identifier">j</span><span class="oak-rightParen">) </span><span class="oak-greater">> </span><span class="oak-identifier">n </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">j </span><span class="oak-minus">- </span><span class="oak-numberLiteral">1</span><span class="oak-rightParen">)</span><span class="oak-newline">
					</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">j </span><span class="oak-plus">+ </span><span class="oak-numberLiteral">1</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-identifier">target </span><span class="oak-assign">:= </span><span class="oak-fnName">sub</span><span class="oak-leftParen">(</span><span class="oak-identifier">i </span><span class="oak-minus">- </span><span class="oak-numberLiteral">1</span><span class="oak-rightParen">)</span>
<span class="oak-newline">
				</span><span class="oak-comment">// if the range from target to current line is indented by more</span><span class="oak-newline">
				</span><span class="oak-comment">// than 1, de-dent them accordingly</span><span class="oak-newline">
				</span><span class="oak-ifKeyword">if </span><span class="oak-identifier">indents</span><span class="oak-dot">.</span><span class="oak-leftParen">(</span><span class="oak-identifier">target</span><span class="oak-rightParen">) </span><span class="oak-minus">- </span><span class="oak-identifier">n </span><span class="oak-greater">> </span><span class="oak-numberLiteral">1 </span><span class="oak-branchArrow">-> </span><span class="oak-leftBrace">{</span><span class="oak-newline">
					</span><span class="oak-identifier">diff </span><span class="oak-assign">:= </span><span class="oak-identifier">indents</span><span class="oak-dot">.</span><span class="oak-leftParen">(</span><span class="oak-identifier">target</span><span class="oak-rightParen">) </span><span class="oak-minus">- </span><span class="oak-identifier">n</span><span class="oak-newline">
					</span><span class="oak-fnName">range</span><span class="oak-leftParen">(</span><span class="oak-identifier">target</span><span class="oak-comma">, </span><span class="oak-identifier">i</span><span class="oak-rightParen">) </span><span class="oak-pipeArrow">|> </span><span class="oak-withKeyword">with </span><span class="oak-fnName">each</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn</span><span class="oak-leftParen">(</span><span class="oak-identifier">j</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
						</span><span class="oak-identifier">indents</span><span class="oak-dot">.</span><span class="oak-leftParen">(</span><span class="oak-identifier">j</span><span class="oak-rightParen">) </span><span class="oak-assign">:= </span><span class="oak-identifier">indents</span><span class="oak-dot">.</span><span class="oak-leftParen">(</span><span class="oak-identifier">j</span><span class="oak-rightParen">) </span><span class="oak-minus">- </span><span class="oak-identifier">diff </span><span class="oak-plus">+ </span><span class="oak-numberLiteral">1</span><span class="oak-newline">
					</span><span class="oak-rightBrace">}</span><span class="oak-newline">
				</span><span class="oak-rightBrace">}</span><span class="oak-newline">
			</span><span class="oak-rightBrace">}</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span>
<span class="oak-newline">
		</span><span class="oak-identifier">indentedLines </span><span class="oak-assign">:= </span><span class="oak-identifier">lines </span><span class="oak-pipeArrow">|> </span><span class="oak-withKeyword">with </span><span class="oak-fnName">map</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-fnKeyword">fn</span><span class="oak-leftParen">(</span><span class="oak-identifier">line</span><span class="oak-comma">, </span><span class="oak-identifier">i</span><span class="oak-rightParen">) </span><span class="oak-ifKeyword">if </span><span class="oak-identifier">line </span><span class="oak-leftBrace">{</span><span class="oak-newline">
			</span><span class="oak-comment">// we don't indent empty lines</span><span class="oak-newline">
			</span><span class="oak-stringLiteral">'' </span><span class="oak-branchArrow">-> </span><span class="oak-stringLiteral">''</span><span class="oak-newline">
			</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-fnName">tabs</span><span class="oak-leftParen">(</span><span class="oak-identifier">indents</span><span class="oak-dot">.</span><span class="oak-leftParen">(</span><span class="oak-identifier">i</span><span class="oak-rightParen">)</span><span class="oak-rightParen">) </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">line</span><span class="oak-newline">
		</span><span class="oak-rightBrace">}</span><span class="oak-newline">
		</span><span class="oak-identifier">indentedLines </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">join</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'\n'</span><span class="oak-rightParen">)</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span>
<span class="oak-newline">
	</span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-identifier">print</span><span class="oak-colon">: </span><span class="oak-identifier">print</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span>
<span class="oak-rightBrace">}</span>

<span class="oak-comment">// print takes an Oak source file and returns a pretty-printed string.</span>
<span class="oak-comment">// Unlike Printer.print, print also correctly processes shebang lines.</span>
<span class="oak-fnKeyword">fn </span><span class="oak-fnName">print</span><span class="oak-leftParen">(</span><span class="oak-identifier">text</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
	</span><span class="oak-identifier">tokens </span><span class="oak-assign">:= </span><span class="oak-fnName">tokenize</span><span class="oak-leftParen">(</span><span class="oak-identifier">text</span><span class="oak-rightParen">)</span><span class="oak-newline">
	</span><span class="oak-identifier">printer </span><span class="oak-assign">:= </span><span class="oak-fnName">Printer</span><span class="oak-leftParen">(</span><span class="oak-identifier">tokens</span><span class="oak-rightParen">)</span><span class="oak-newline">
	</span><span class="oak-ifKeyword">if </span><span class="oak-fnName">shebang?</span><span class="oak-leftParen">(</span><span class="oak-identifier">text</span><span class="oak-rightParen">) </span><span class="oak-leftBrace">{</span><span class="oak-newline">
		</span><span class="oak-trueLiteral">true </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">text </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">cut</span><span class="oak-leftParen">(</span><span class="oak-stringLiteral">'\n'</span><span class="oak-rightParen">) </span><span class="oak-pipeArrow">|> </span><span class="oak-fnName">first</span><span class="oak-leftParen">(</span><span class="oak-rightParen">) </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-stringLiteral">'\n' </span><span class="oak-pushArrow">&lt;&lt; </span><span class="oak-identifier">printer</span><span class="oak-dot">.</span><span class="oak-fnName">print</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
		</span><span class="oak-underscore">_ </span><span class="oak-branchArrow">-> </span><span class="oak-identifier">printer</span><span class="oak-dot">.</span><span class="oak-fnName">print</span><span class="oak-leftParen">(</span><span class="oak-rightParen">)</span><span class="oak-newline">
	</span><span class="oak-rightBrace">}</span>
<span class="oak-rightBrace">}</span>

</code></pre>
        </article>
    </main>
    <footer>
        <div class="split overlay">
            <div class="left">
            </div>
            <div class="right">
                - <a href="https://thesephist.com/">Linus</a>
            </div>
        </div>
    </footer>
</body>
